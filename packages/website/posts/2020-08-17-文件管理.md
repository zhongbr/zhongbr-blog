---
title: '文件管理'
tags: ['操作系统','文件']
---
# 文件管理

## 文件的属性

1. 文件名：创建文件的用户决定的文件名，不允许重复
2. 标识符：操作系统用于区分文件的内部标识符
3. 类型：指明文件类型
4. 位置：文件的存放路径、在外存中的地址
5. 大小：知名文件的大小
6. 所有者信息
7. 保护信息

******

## 文件的物理结构

### 无结构文件

文件内部是一些列二进制流或者字符流，又称为“流式文件”

### 有结构文件

由一组相似的记录组成，又称为“记录式文件”，每条记录又由多个数据项组成，如数据表文件。一般来说每条记录有一个数据项可以作为关键字。

- 定长记录：每条记录占用的存储空间相等
- 可变长记录：每条记录占用的存储空间不相等

#### 顺序文件

文件中的记录一个接一个地顺序排列，记录可也是定长地或者是变长地，各个记录在物理上可以顺序存储或者链式存储。

串结构：记录之间的顺序与关键字无关

顺序结构：记录之间的顺序按关键字顺序排列（查找时可以使用折半查找等方式快速查找检索）

##### 顺序文件的随机访问

只有采用**顺序结构存储的定长记录文件**可以实现随机访问。

#### 索引文件

可以通过建立**索引表**的方式，实现对**顺序结构存储的可变长记录文件**的随机访问。

#### 索引顺序文件

索引顺序文件时索引文件和顺序文件思想的结合，在索引顺序文件中，同样会为文件建立一张索引表，但是不同的是，并不是每个记录都会对应一张索引表项，而是一组记录对应一个索引表项。

******

## 文件目录

### 文件控制块

FCB的有序集合称为“文件目录”，FCB时一个文件的目录项，FCB包含了文件的基本信息（文件名、物理地址、逻辑结构、物理结构等），存取控制信息（权限信息等）、使用信息（建立时间、修改时间等）。

### 单级目录结构

整个系统中只建立一张目录表，每个文件占用一个表项

缺点：单级目录实现了文件的“按名存取”，但是**不允许文件重名**。

单机目录结构**不适用于多用户操作系统**。

### 两级目录结构

早期的多用户莋系统采用的是两级目录结构，分为主文件目录(MFD, Master File Directory)和用户文件目录(UFD, User File Directory)。

优点：允许不同的用户使用相同的文件名，并且使用两级文件目录可以便于操作系统实现对文件的权限保护。

缺点：缺乏灵活性，用户不能对自己的文件进行分类

### 多级目录结构（树形目录结构）

用户要访问某个文件夹的时候要用文件路径来标识文件，文件路径是字符串，各级目录之间使用“/”隔开。

- 从根目录出发的路径称为**绝对路径**。
- 从当前目录出发路径称为**相对路径**。

优点：可以很方便地对文件进行分类，层次结构清晰，也能有效地进行文件管理和保护

缺点：不便于实现文件共享

### 无环图目录结构

在多级目录结构的基础上，增加了一些指向同一个节点的有向边，使整个目录称为一个有向无环图。可以更方便地实现多个用户之间的文件共享。

不同的用户可以在各自的目录表中使用不同的文件名指向磁盘上的同一个文件，甚至可以指向同一个目录。在这样的情况下，为了便于删除文件，可以为文件设置一个共享计数器，一个用户删除文件的时候，将文件的FCB从该用户的目录表中删除，并将共享计数器减一，共享计数器为零的时候才可以真正地将文件删除。

****

## 文件的物理结构（文件的分配方式）

> **磁盘块**：类似于内存分页，磁盘的存储单元也会被分为一个个的“磁盘块”，很多操作系统中会将磁盘块的大小设置为**与内存的分页大小相同**。
>
> **文件块**：在内存管理中，进程的逻辑地址空间被分为一个个页面，在外存的管理中，为了便于文件的数据的管理，文件的逻辑地址空间也被分为一个个的文件“块”。文件的逻辑地址可以表示成**(逻辑块号、块内地址)**的形式。

### 连续分配

要求每个文件在磁盘上占有一组连续的块。为了可以通过用户提供的逻辑快好得到文件在磁盘上的物理块号，文件目录表需要记录存放文件的**起始块号**和**文件占用的块数**。

优点：

- 文件在**顺序读取的时候速度最快**。
- 可以支持随机访问文件块

缺点：

- 不便于对文件进行拓展
- 会产生难以利用的磁盘碎片

### 链接分配

采用离散分配的凡是，为文件分配离散的磁盘块，分为**隐式链接**和**显示连接**两种。

#### 隐式链接（默认）

目录中记录了文件存放的**起始块号**和**结束块号**，也可以增加一个字段表示文件的长度

除了最后一个磁盘块以外，每个磁盘块都会保存指向下一个磁盘块的指针，这些指针对用户是透明的。

优点：文件的拓展方便，不会产生碎片问题

缺点：只支持顺序访问不支持随机访问

#### 显示链接

将用于链接文件的物理块的指针显示存在一张表中——文件分配表(FAT File Allocation Table)。文件的目录表中只记录了文件的**起始块号**。

> 一个磁盘只对应**一张文件分配表**，开机时便会将文件分配表**加载到内存**中

优点：支持顺序访问，也支持随机访问，地址转换不需要访问磁盘，效率更高

缺点：文件分配表需要占用一定的存储空间

### 索引分配

索引分配允许文件离散分配在各个磁盘块中，系统会为**每个文件建立一张索引表**，索引表记录了文件的各个逻辑块对应的物理块（索引表的功能类似于内存管理中的页表），**索引表存放的磁盘块称为索引块**，文件数据存放的磁盘称为数据块。

优点：支持随机访问

缺点：索引表需要占用一定的空间

#### 索引表太大的解决方案

1. 链接方案：如果索引表太大，一个索引块装不下，可以将多个索引块链接起来存放。

   缺点：索引块不支持随机访问，导致读取文件低效

2. 多层索引：类似多级页表，使第一层索引块指向第二层索引块，可以根据文件的大小再建立第三层、第四层索引块.....

   映射过程：操作系统首先根据文件目录表中的顶级索引块的物理地址找到顶级索引块，然后根据逻辑地址依次读取二级索引、三级索引......就可以访问到物理地址。

   采用K层索引结构，且顶级索引表未调入内存，访问一个数据块需要K+1次读磁盘操作

3. 混合索引：多种索引方式的结合，可以同时包含直接地址索引、间接索引等多种索引方式。

   优点：**小文件**只需要**较少的读磁盘次数**就可以访问到目标数据块

![quicker_a0c83763-cdc2-479f-b813-95b91669855a.png](https://i.loli.net/2020/08/17/vWM3yXVZeTtuK1g.png)
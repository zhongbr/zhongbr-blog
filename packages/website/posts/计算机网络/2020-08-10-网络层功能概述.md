---
title: '网络层功能概述'
tags: ['计算机网络','网络层','路由']
---
# 网络层功能概述

把分组从远端传送到目的端，为分组交换网上不同的主机提供通信服务。

传输设备：数据报

## 网络层的功能

### 1. 路由的选择和转发

路由选择：按照复杂的分布式算法，根据从各个相邻路由器得到的关于整个网络拓扑的变化情况，动态改变选择的路由。

分组转发：路由器根据转发表将用户的IP和数据报从合适的端口转发出去。

> 路由表是根据路由选择算法计算得出的，转发表是从路由表得到的。转发表的结构应该使得查找的过程最优化，路由表则需要对网络拓扑的变化的计算最优化。在讨论路由器的选择原理时通常不会区分路由表和转发表，笼统使用路由表一词。

### 2. 异构网络互联

网络层的互联通常指的是使用路由器进行网络互连和路由选择。路由器是一台专用计算机，用于在互联网中进行路由选择。
参与互联的计算机都使用相同的网际协议（Internet Protocol, IP），互联后的网络可以视为一个虚拟的IP网络。
虚拟互联网络也就是逻辑互联网络，互连起来的各种物理网络客观上存在异构性（物理层、数据链路层和网络层可能异构），但是使用虚拟互联网络互联后就好像是在统一的网络一样。使用IP的虚拟互联网络简称IP网络。

### 3. 拥塞控制

若所有的结点都来不及接收分组，丢弃大量的分组，网络就处于拥塞状态，因此需要采取一定的额措施来缓解这种情况。

#### 3.1 开环控制

静态方式

#### 3.2 闭环控制

动态方式

*****

## 路由算法

路由表/转发表的内容

|目的网络的IP地址|子网掩码|下一跳的IP地址|接口|
|-|-|-|-|
|||||
|||||

三种路由协议的比较

|协议|类型|路由算法|层次、协议|路径选择|交换结点|交换内容|
|-|-|-|-|-|-|-|
|RIP协议|内部|距离-向量|应用层，基于UDP|跳数最少|相邻路由器|自己的全部路由表|
|OSPF协议|内部|链路状态|存在争议，暂且作为网络层，采用IP协议|代价最低|所有路由器|与本路由器相邻的所有路由器的链路状态|
|BGP协议|外部|路径-向量|应用层，基于TCP|较好、非最佳|相邻路由器|首次：整个路由表；整个路由表：有变化的部分|

### 静态路由和动态路由

#### 静态路由（非自适应路由）

由网络管理员手工配置路由信息。需要网络管理员全面了解整个网络的拓扑结构，当网络拓扑结构发生改变时需要大量修改路由表的路由信息。

优点：简便、可靠

在负荷稳定、拓扑变化不大的网络中运行结果良好

#### 动态路由（自适应路由）

路由器上的路由表项根据相互连接的路由器之间彼此交换信息，然后按照一定的算法优化，这些路由信息会在一定的时间间隙里不断更新。

优点：动态路由能改善网络性能，有助于流量控制

缺点：算法复杂，会增加网络的负担，有时可能因为变化太快而引起网络振荡，或者反应太慢影响网络路由的一致性

### 距离-向量路由算法 RIP（应用层协议，UDP传送）

分散性的动态路由算法，路由器智障我物理相连的路由器的链路费用，适用于较小的网络

RIP协议要求网络中的每一个路由器都维护一个从它自己到其他每一个目的网络的唯一距离记录（即一组距离）。

距离：通常是“跳数”，即从源端口到目的端口的所经过的路由器的个数，经过一个路由器+1。

从一路路由器直接连接的网络的距离为1，RIP允许一条路由最多包含15个路由器，因此距离16表示网络不可达。

#### 仅和相邻的路由器交换信息

每30秒与自己相邻的路由器交换自己的路由表的内容，然后路由器根据新信息更新路由表，超过180秒没有收到邻居路由器的通告，则判定邻居没了，并更新自己的路由表。

路由器刚开始工作的时候，路由表中只有与自己直接相连的网络的距离，接着每一个路由器也只和数目非常有限的相邻路由器交换信息

讲过若干次更新，所有的路由器都会知道到达本自治系统任何一个网络的最短距离和下一跳路由器的地址，即“收敛”

#### RIP过程

1. 修改相邻路由器发过来的RIP报文中的所有表项，将下一跳的地址改为相邻的路由器，并把距离+1
2. 对修改后的每一个项目：
   - 如果自己的路由表中没有表项中的网络，直接将表项添加到路由表
   - 如果自己的路由表中有表项中的网络，查看下一条的地址：
     - 如果下一跳与表项中的路由器相同，使用表项中的内容替换自己的路由表
     - 如果下一条与表项中的路由器不同，如果新的距离比旧的距离小就更新，否则不更新。
3. 如果180s还没收到相邻的某个路由器的路由表，就把这个路由器标识为不可达的路由器，把距离设置成16.  

### 链路状态路由算法 OSPF(开放最短路径优先协议)

存在争议，暂时当作**网络层**协议

全局性的动态路由算法，所有的路由器都拥有完整的网络拓扑结构和链路费用信息

使用了Dijkstra的最短路径算法

#### OSPF的特点

1. 使用洪泛法向自治系统内所有路由器发送信息，即路由器通过输出端口向所有相邻的路由器发出信息，每一个相邻的路由器接着将此信息转发给其他相邻的路由器。
   **最终整个网络所有的路由器都会获得这个信息的一个副本**。
2. 发送的信息就是与本路由器相邻的所有路由器的链路状态（本路由器和哪些路由器相邻，以及该链路的度量/代价——费用、距离、时延、带宽等）。
3. 只有当链路发生变化的时候，路由器才会向所有的路由器洪泛发送此信息。
4. 每隔30分钟更新一次数据库中的链路状态
5. 一个路由器的链路状态只涉及与之相邻的路由器的连通状态，与整个网络的规模并无直接联系，当互联网规模很大的时候，OSPF协议比RIP协议好很多。
6. 不存在坏消息传输速度慢的问题，收敛速度快

#### 链路状态路由算法

1. 每个路由器发现它的邻居结点【Hello问候分组】，并了解邻居节点的网络地址。
2. 设置到它的每个邻居节点的成本度量(metric)
3. 构造【DD数据库描述分组】，向所有的相邻路由器给出自己的链路状态数据库中的所有链路状态的摘要信息。
4. 如果相邻的路由器收到的DD数据库描述的摘要自己都有，就不做处理，如果没有或者有更新的，发送【LSR链路状态请求分组】，请求自己没有的信息或者更新的信息。
5. 收到来自相邻路由器的LSR分组后，发送【LSU链路状态更新分组】进行更新。
6. 更新完毕后，相邻路由器返回一个【LSAck链路状态确认分组】进行确认。

#### OSPF的区域

为了使OSPF可以用于规模很大的网络，可以将一个自治系统再划分为若干个更小的范围，叫做区域。每一个区域都有一个32位的区域标识符（点分十进制）。

每一个区域不能太大，路由器的数量最好不超过200个。

*****

## 分层次的路由选择协议

1. 因特网的规模很大
2. 不想让外界知道自己的路由选择协议的情况下连接互联网

自治系统AS：在单一的技术管理下的一组路由器，这些路由器使用一种AS内部的路由选择协议和共同度量确定分组在该AS内的路由，同时还是用另一种AS之间的路由协议以确定AS之间的路由。

一个AS内的所有网络属于一个行政单位管辖，一个自治系统下的所有路由器在本自治系统内都必须连通。

### 内部网关协议IGP

AS内部使用的路由协议：RIP、OSPF

### 外部网关协议EGP

AS之间使用的路由协议：BGP-4

#### BGP协议（应用层协议，采用TCP报文传送）

1. 和谁交换信息：与其他AS的邻站BGP发言人交换信息
2. 交换什么信息：交换网络的可达信息，即要到达某个网络所需要经过的一系列AS
3. 多久交换一次：发生变化的时候，交换有变化的部分。

#### BGP交换过程

BGP所交换的网络可达信息就是要到达某个网络后要经过的一系列AS。当BGP发言人互相交换了网络可达信息后，各BGP发言人根据采用的策略，从收到的路由信息中找出到达各个AS的较好的路由。

BGP发言人交换路径向量

一个BGP发言人与另一个AS中的BGP发言人交换路由信息之前需要先简历TCP连接，通过TCP传送，然后再此连接上简历BGP会话（session），利用BGP会话交换路由信息。

#### BGP协议的特点

1. 支持CIDR，BGP路由表包含目的网络前缀、下一级路由，以及到达该目的网络要经过的各个自治系统的序列。
2. BGP刚刚运行的时候需要交换整个路由表的，以后只需要交换变化的部分，这样可以节省带宽和减少路由器的处理开销。

#### BGP-4的四种报文

1. OPEN（打开）报文：用来与相邻的另一个BGP发言人建立关系，并认证发送方
2. UPDATE（更新）报文：通告新路径或撤销原路径
3. KEEPALIVE（保活）报文：无UPDATE的时候，周期性证实邻站的连通性，作为OPEN确认
4. NOTIFICATION（通知）报文：报告前报文的差错，也被用于关闭连接。

*****

## IP数据报

IP数据包分为首部和数据部分（TCP、UDP段）

### IP数据报的首部

![PNG图像.png](https://i.loli.net/2020/08/10/EB8sHbawgGZCMUz.png)

首部：20字节的固定部分 + 可有可无的可变部分（大部分情况下都没有）

- 0 - 3 bit：版本字段（IPv4/IPv6）
- 4 - 7 bit：首部长度/4B（例如首部长度是20B时，这里取值是5，也就是0101）
- 8 - 15 bit：期望获得服务类型，例如优先级等
- 16 - 31 bit：总长度，IP数据报的上限值
- 生存时间（TTL）8bit：IP分组的保质期，经过一个路由器则-1，变成0就会被丢弃
- 协议 8bit：数据部分使用的协议（TCP为6，UDP为17）
- 首部检验和 16bit：只检验首部
- 源地址、目的地址 均为 32bit
- 可选择段 0-40B：用来支持排错、测量等安全措施
- 填充：全0，把首部填充为4B的整数倍
- 标识：同一数据报的分片使用同一个标识
- 标志 3bit：第0位无意义 第1位DF为1表示禁止分片 第2位MF为1表示后面还有分片
- 片偏移 13bit：该分片在原数据报中的位置，以8B为单位

*****

## IPv4地址

全世界唯一的32bit的标识符，标识路由器主机的接口。

### 分类的IP地址

![PNG图像.png](https://i.loli.net/2020/08/10/WHjMClr8BN2ycsD.png)

#### 特殊IP地址

|NetID 网络号|HostID 主机号|作为IP分组源地址|作为IP分组目的地址|用途|
|-|-|-|-|-|
|全0|全0|可以|不可以|本网范围内表示全部主机，路由表中表示默认路由（表示整个Internet的内容）|
|全0|特殊值|不可以|可以|表示本网内的某个特定主机|
|全1|全1|不可以|可以|本网广播地址（路由器不转发）|
|特定值|全0|不可以|不可以|网络地址|表示一个网络|
|特定值|全1|不可以|可以|直接广播地址，对特定网络上所有的主机进行广播|
|127|任何数（非全0/1）|可以|可以|本地软件换回测试，称为环回地址|

#### 私有IP地址

|地址类别|地址范围|网段个数|
|-|-|-|
|A类|10.0.0.0~10.255.255.255|1|
|B类|172.16.0.0~172.31.255.255|16|
|C类|192.168.0.0~192.168.255.255|256|

#### 可用的IP数

|网络类别|最大可用网络数|第一个可用的网络号|最后一个可用的网络号|每个网络中最大的主机数|
|-|-|-|-|-|
|A| $2^{7}-2$ |1|126| $2^{24}-2$ |
|B| $2^{14}-1$ |128.1|192.255| $2^{16}-2$ |
|C| $2^{21}-1$ |192.0.1|223.255.255| $2^{8}-2$ |

#### 网络地址转换(Network Address Translation)

在专用网连接因特网的路由器上安装NAT软件，安装了NAT软件的路由器称为NAT路由器，它至少拥有一个外部有效的IP地址。

NAT软件建立和维护一个NAT转换表，存有WAN端口和LAN端口

### 子网的划分

子网掩码(subnet mask)又叫网络掩码、地址掩码、子网络遮罩，它是一种用来指明一个IP地址的哪些位标识的是主机所在的子网，以及哪些位标识的是主机的位掩码。

子网掩码和IP地址按位相与，就可以得到子网网络地址。

> 路由器转发分组的算法：
>
> 1. 提取目的IP地址
> 2. 是否直接交付
> 3. 特定主机路由
> 4. 检测路由表中是否有路径
> 5. 默认路由 0.0.0.0
> 6. 丢弃，报告转发分组出错

### 构成超网（无分类编址方法 CIDR）

1. 消除了传统的A类、B类和C类地址以及划分子网的概念，将子网号和网络编号合并记为**网络前缀**。
   CIDR记法：IP地址后加上“/”然后写上网络前缀的位数。eg. 128.14.32.0/20

2. 融合了子网地址和子网掩码，方便子网划分

   CIDR把网络前缀都相同的连续的IP地址组成一个“CIDR地址块”
   地址块的记法：地址块的最小地址/网络前缀的位数

3. 将多个子网聚合成一个较大的子网，叫做构成超网，或者称为路由聚合

   方法：将网络前缀缩短

   使用CIDR时，查找路由表可能查到多个匹配结果，应该选择具有最长网络前缀的路由。前缀越长，地址块越小，路由越具体。

*****

## ARP协议

完成主机或者路由器由IP到MAC地址的映射

ARP应对的四种情况：

1. 主机A发给本网络上的主机B:用ARP找到主机B的硬件地址
2. 主机A发给另一网络上的主机B:用ARP找到本网络上一个路由器(网关)的硬件地址;
3. 路由器发给本网络的主机A:用ARP找到主机A的硬件地址;
4. 路由器发给另一网络的主机B:用ARP找到本网络上的一个路由器的硬件地址。

### ARP高速缓存

存储IP地址和MAC地址的映射

#### 与同一网段内的主机通信

ARP广播询问目的IP的MAC地址，交换机会将询问ARP请求转发给所有的主机，对应IP的主机会回复自己的MAC地址。

#### 与不同网段的主机通信

1. 通信之前，主机使用自己的子网掩码验证目的IP和自己不在一个网段后，发送ARP广播请求询问自己的默认网关的MAC地址，作为下一跳的MAC地址，然后放入到物理层传输。
2. 数据报到达源主机的路由器后，解封装到网络层后，修改源MAC地址为路由器的MAC地址，目的MAC地址为目的主机所在的网段的网关的MAC地址，如果有NAT还需要修改源IP，然后封装到物理层传输。
3. 到达目的主机的路由器，路由器解封装到网络层，然后发送ARP广播，询问目的主机的MAC地址，然后修改MAC地址等信息后封装到物理层传输，即可到达目的主机。

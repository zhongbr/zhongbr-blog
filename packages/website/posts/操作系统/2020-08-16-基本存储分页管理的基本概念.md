---
title: '内存分页管理'
tags: ['操作系统','分页','内存']
---
# 分页管理

# 单级分页管理

基本分页存储管理的思想：把内存分为一个个相等的小**分区**，再按照分页大小把进程拆分成一个个小部分。

>  分区：又叫页框、页帧、内存块、物理块
>
>  页框号：每一个页框的编号，又叫内存块号、页帧号、物理块号，从0开始
>
>  页面：将用户进程的地址空间分为与页面大小相同的一个个区域，称为“页”或者“页面”
>
>  页号：每个页面都有一个编号，即“页号”，页号和页框号一样从0开始。
>
>  ***页框不能设置太大，页框太大会产生较多的内部碎片***

## 地址转换

如果一个操作系统采用分页的管理内存，如果想要通过逻辑地址得到其物理地址：

1. 算出逻辑地址对应的页号
2. 要知道页号对应的页面在内存中的起始地址（操作系统会保存）
3. 算出逻辑地址在页面中的偏移量
4. 物理地址 = 页面起始地址 + 偏移量

> 如果每个页面的大小为 $2^{k}B$ ，用二进制表示其逻辑地址，其末尾的k位即为其页内偏移量，前面的其余部分就是分页的页号。

为了能知道每个页面在内存中存放的位置，操作系统要为**每个进程建立一个页表**，页表中的页表项由页号和块号组成，页表负责记录进程页面和时机存放的内存块之间的对应关系。

值得注意的是，页表中的页号是隐含在页表项的偏移量中的（相当于将页号隐含在数组的下标中）。

## 基本地址变换机构

用于实现**逻辑地址到物理地址**转换的一组**硬件机构**。 

基本地址变换机构借助进程页表将逻辑地址转换为物理地址：基本地址变换机构可以借助进程的页表将逻辑地址转换为物理地址通常会在系统中设置一个**页表寄存器(PTR)**,存放页表在内存中的起始地址F和页表长度M。
进程未执行时,页表的始址和页表长度放在进程控制块(PCB)中,当进程被调度时,操作系统内核会把它们放到页表寄存器中。

- 根据逻辑地址计算出页号、页内偏移量
- 检查页号是否越界，不合法的时候会出现**越界中断**
- 如果页号合法，查询页表，找到页号对应的页表项（ $页表项地址=页表起始地址+页号*页表项长度$ ），确定页面存放的内存块号
- 用内存块号和页内偏移量得到物理地址

## 具有快表的地址变换机构

> **局部性原理**
>
> **时间局部性**：如果执行了程序中的某条指令，那么不久后这条指令有可能再被执行，如果某个数据被访问过，不久之后很有可能被再次访问。
>
> **空间局部性**：一旦程序访问了某个存储单元，不久之后，其附近的存储单元也很有可能被访问。（很多数据再内存中是连续存放的）。

在基本地址变换机构中，每次要访问一个逻辑地址，都需要查询内存中的页表，由局部性原理，**可能连续很多查到的都是同一个页表项**。

**快表**：联想寄存器（TLB），是一种访问速度**比内存快很多**的高速缓冲存储器，用来存放当前访问的若干表项，以加速地址变换的额过程。与此对应，内存中的页表常被称为**慢表**。==快表中存放的是页表的一部分副本内容==，

在地址转换的过程中，查询页表之前，会先根据页号，尝试在快表中查询，如果命中了，就不会再去页表中查询了。

### 加入快表后的地址变换过程

① cpυ给出逻辑地址,由某个硬件算得页号、页内偏移量,将页号与快表中的所有页号进行比较

② 如果找到匹配的页号,说明要访问的页表项在快表中有副本,则直接从中取出该页对应的内存块号,再将内存块号与页内偏移量拼接形成物理地址,最后,访问该物理地址对应的内存单元。因此,若快表命中,则访问某个逻辑地址仅需**一次访存**即可

③ 如果没有找到匹配的页号,则需要访问内存中的页表,找到对应页表项,得到页面存放的内存块号,再将内存块号与页内偏移量拼接形成物理地址,最后,访问该物理地址对应的内存单元。因此,若快表未命中,则**访问某个逻辑地址需要两次访存**(注意:在找到页表项后,**应同时将其存入快表以便后面可能的再次访问**。但若快表已满,则必须按照一定的算法对旧的**表项进行替换**)。

*****

# 两级分页管理

## 单级分页管理存在的问题

1. 需要专门为进程分配 $2^{10}=1024$ 个**连续的页框**来存放它们的页表；
2. 整个页表都需要常驻内存，但是进程可能再一段时间内只访问某几个特定的页面

## 两级分页

- 将单级分页管理中规模庞大的页表进行分组，使每个内存块刚好可以放入一个人族，分组的大小为4KB。每个页表项4B，每个页面可以存放1K个页表项，因此每1K个连续的页表项为一组，刚好占一个内存块。

- 为离散分配的页表再建立一张页表，称为**页目录表**，或者称为外层页表、顶层页表。

#### 两级分页管理中逻辑地址的结构

| 31 ... 22 | 21 ... 12 | 11 ... 0   |
| --------- | --------- | ---------- |
| 一级页号  | 二级页号  | 页内偏移量 |

 $一级页号 = [逻辑地址 / 4096^{2}]$ 

 $二级页号 = [逻辑地址/4096] - 一级页号*4096$ 

 $业内偏移量 = 逻辑地址 \% 4096$ 


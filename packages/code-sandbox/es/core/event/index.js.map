{"version":3,"file":"index.js","sources":["../../../src/core/event/index.ts"],"sourcesContent":["export interface Handler {\n    (...params: unknown[]): void;\n    filter?: (...params: unknown[]) => boolean;\n    once?: boolean;\n}\n\nexport const createEventSubscribeManager = <K = string>() => {\n    const eventsHandlersMap = new Map<K, Array<Handler>>();\n\n    const trigger = (key: K, ...params: unknown[]) => {\n        const handlers = eventsHandlersMap.get(key);\n        if (handlers) {\n            const drops = new Map<number, boolean>();\n            handlers.forEach((handler, index) => {\n                // 存在触发条件，但是不满足的跳过\n                if (handler.filter && !handler.filter(...params)) {\n                    return;\n                }\n                handler(...params);\n                if (handler.once) {\n                    drops.set(index, true);\n                }\n            });\n            eventsHandlersMap.set(key, handlers.filter((_, index) => !drops.get(index)));\n        }\n    }\n\n    const listen = (key: K, cb: Handler, filter?: Handler['filter']) => {\n        if (!eventsHandlersMap.has(key)) {\n            eventsHandlersMap.set(key, []);\n        }\n        eventsHandlersMap.get(key)?.push?.(Object.assign(cb, {\n            filter\n        }));\n        return () => {\n            eventsHandlersMap.get(key)?.filter(handler => handler !== cb);\n        }\n    };\n\n    const once = (key: K, cb: Handler, filter?: Handler['filter'], onTimeout?: () => void, timeout = -1) => {\n        if (!eventsHandlersMap.has(key)) {\n            eventsHandlersMap.set(key, []);\n        }\n        const dispose = () => {\n            eventsHandlersMap.get(key)?.filter(handler => handler !== cb);\n        }\n\n        // 超时\n        let _timeout;\n        if (timeout !== -1) {\n            _timeout = setTimeout(() => {\n                dispose();\n                onTimeout?.();\n            }, timeout);\n        }\n        eventsHandlersMap.get(key)?.push?.(Object.assign((...args) => {\n            if (_timeout) clearTimeout(_timeout);\n            cb(...args);\n        }, {\n            once: true,\n            filter\n        }));\n        return dispose;\n    }\n\n    return { trigger, listen, once };\n}\n"],"names":["_a"],"mappings":"AAMO,MAAM,8BAA8B,MAAkB;AACnD,QAAA,wCAAwB;AAExB,QAAA,UAAU,CAAC,QAAW,WAAsB;AACxC,UAAA,WAAW,kBAAkB,IAAI,GAAG;AAC1C,QAAI,UAAU;AACJ,YAAA,4BAAY;AACT,eAAA,QAAQ,CAAC,SAAS,UAAU;AAEjC,YAAI,QAAQ,UAAU,CAAC,QAAQ,OAAO,GAAG,MAAM,GAAG;AAC9C;AAAA,QACJ;AACA,gBAAQ,GAAG,MAAM;AACjB,YAAI,QAAQ,MAAM;AACR,gBAAA,IAAI,OAAO,IAAI;AAAA,QACzB;AAAA,MAAA,CACH;AACD,wBAAkB,IAAI,KAAK,SAAS,OAAO,CAAC,GAAG,UAAU,CAAC,MAAM,IAAI,KAAK,CAAC,CAAC;AAAA,IAC/E;AAAA,EAAA;AAGJ,QAAM,SAAS,CAAC,KAAQ,IAAa,WAA+B;AArBjE;AAsBC,QAAI,CAAC,kBAAkB,IAAI,GAAG,GAAG;AACX,wBAAA,IAAI,KAAK,CAAA,CAAE;AAAA,IACjC;AACA,kCAAkB,IAAI,GAAG,MAAzB,mBAA4B,SAA5B,4BAAmC,OAAO,OAAO,IAAI;AAAA,MACjD;AAAA,IACH,CAAA;AACD,WAAO,MAAM;AA5Bd,UAAAA;AA6BK,OAAAA,MAAA,kBAAkB,IAAI,GAAG,MAAzB,gBAAAA,IAA4B,OAAO,CAAA,YAAW,YAAY;AAAA,IAAE;AAAA,EAChE;AAGJ,QAAM,OAAO,CAAC,KAAQ,IAAa,QAA4B,WAAwB,UAAU,OAAO;AAjCrG;AAkCC,QAAI,CAAC,kBAAkB,IAAI,GAAG,GAAG;AACX,wBAAA,IAAI,KAAK,CAAA,CAAE;AAAA,IACjC;AACA,UAAM,UAAU,MAAM;AArCvB,UAAAA;AAsCK,OAAAA,MAAA,kBAAkB,IAAI,GAAG,MAAzB,gBAAAA,IAA4B,OAAO,CAAA,YAAW,YAAY;AAAA,IAAE;AAI5D,QAAA;AACJ,QAAI,YAAY,IAAI;AAChB,iBAAW,WAAW,MAAM;AAChB;AACI;AAAA,SACb,OAAO;AAAA,IACd;AACA,kCAAkB,IAAI,GAAG,MAAzB,mBAA4B,SAA5B,4BAAmC,OAAO,OAAO,IAAI,SAAS;AACtD,UAAA;AAAU,qBAAa,QAAQ;AACnC,SAAG,GAAG,IAAI;AAAA,IAAA,GACX;AAAA,MACC,MAAM;AAAA,MACN;AAAA,IACH,CAAA;AACM,WAAA;AAAA,EAAA;AAGJ,SAAA,EAAE,SAAS,QAAQ;AAC9B;"}
{"version":3,"file":"index-bbd22918.js","sources":["../src/utils/iframe.ts","../src/type.ts","../.cache/iframe/iframe.js?url","../src/iframe/iframe.css?used&raw","../src/iframe/html.ts","../src/iframe/index.ts","../src/default.ts","../src/plugins/index.ts"],"sourcesContent":["import { createEventSubscribeManager } from '../core/event';\nimport { callProxy, registerProxy } from '../core/proxy';\n\nconst EVENT_KEY = 'iframe-message-type';\nconst NOTIFICATION_SERVICE = 'iframe-notification-service';\n\ninterface INotificationService {\n    /** iframe 加载完成 */\n    iframeReady: (e: MessageEvent) => Promise<boolean>;\n    iframeLoadingModule: (moduleName: string, moduleUrl: string, e: MessageEvent) => Promise<void>;\n}\n\nconst emitter = createEventSubscribeManager<keyof INotificationService>();\n\n/**\n * 注册主进程中的服务，监听消息\n */\nexport const initMainThreadService = async () => {\n    const service: INotificationService = {\n        iframeReady: async (e) => {\n            console.log('iframe ready', e);\n            emitter.trigger('iframeReady', e);\n            return true;\n        },\n        iframeLoadingModule: async (moduleName, moduleUrl, e) => {\n            emitter.trigger('iframeLoadingModule', moduleName, moduleUrl, e);\n        }\n    }\n    registerProxy(NOTIFICATION_SERVICE, service);\n};\n\n/**\n * 主页面中，等待指定的 iframe 运行环境加载完成\n * @param iframe 要等待的 iframe\n * @param timeout 超时时间\n */\nexport const waitIframeReady = async (iframe: HTMLIFrameElement, timeout=10000) => {\n    // 被动监听 iframe 发送的消息来得知 iframe 已经加载，避免调用时 iframe 端还未准备好而导致的消息丢失\n    const listenTask = new Promise<null>((resolve, reject) => {\n        if (iframe.getAttribute('data-iframe-status') !== 'loaded') {\n            emitter.once(\n                'iframeReady',\n                (...args) => {\n                    iframe.setAttribute('data-iframe-status', 'loaded');\n                    resolve(null);\n                },\n                (e: MessageEvent) => e.source === iframe.contentWindow,\n                reject,\n                timeout\n            );\n        }\n        else {\n            resolve(null);\n        }\n    });\n    // 主动调用 iframe 暴露的接口查询是否准备好\n    const queryTask = callProxy<Pick<INotificationService, 'iframeReady'>>({\n        win: iframe.contentWindow,\n        serviceId: NOTIFICATION_SERVICE,\n        method: 'iframeReady',\n        payload: [],\n        timeout\n    });\n    // 两个查询方式 race，取返回快的结果\n    return Promise.race([listenTask, queryTask]);\n}\n\n/**\n * 通知外部容器，iframe 内部已经加载完成的函数\n */\nexport const iframeReady = async () => {\n    registerProxy<Pick<INotificationService, 'iframeReady'>>(NOTIFICATION_SERVICE, {\n        iframeReady: async () => {\n            return true;\n        }\n    });\n    const parent = window.top || window.parent || window.opener;\n    if (!parent) return;\n    return callProxy<INotificationService>({\n        win: parent,\n        serviceId: NOTIFICATION_SERVICE,\n        method: 'iframeReady',\n        payload: []\n    });\n}\n\n/**\n * 监听指定的 iframe 内加载模块\n * @param iframe 要监听的 iframe\n * @param cb 回调函数\n */\nexport const onIframeLoadingModule = (iframe: HTMLIFrameElement, cb: (moduleName: string, extraInfo: string) => void) => {\n    emitter.listen('iframeLoadingModule', cb, (moduleName, extraInfo, e: MessageEvent) => e.source === iframe.contentWindow);\n};\n\n/**\n * 通知外部容器，iframe 内部正在加载模块的函数\n * @param moduleName\n * @param extraInfo\n */\nexport const iframeLoadingModule = async (moduleName: string, extraInfo: string) => {\n    const parent = window.top || window.parent || window.opener;\n    if (!parent) return;\n    return callProxy<INotificationService>({\n        win: parent,\n        serviceId: NOTIFICATION_SERVICE,\n        method: 'iframeLoadingModule',\n        payload: [moduleName, extraInfo]\n    });\n};\n","export const DemoServiceName = 'demo-service';\n\n\nexport interface IDemoService {\n    defineModule: (name: string, deps: string[], factory: string) => Promise<boolean>;\n    executeModule: (name: string) => Promise<boolean>;\n    setStyle: (name: string) => Promise<boolean>;\n    setPlugins: (pluginsId: string[]) => Promise<void>;\n    setBodyHtml: (html: string) => Promise<void>;\n}\n","export default \"data:application/javascript;base64,Y29uc3QgZGVidWdPbmx5TGV2ZWwgPSBbImxvZyIsICJkZWJ1ZyJdOwpjb25zdCBsb2dnZXIgPSBkZWJ1Z09ubHlMZXZlbC5yZWR1Y2UoKHByZSwga2V5KSA9PiB7CiAgcmV0dXJuIE9iamVjdC5hc3NpZ24ocHJlLCB7CiAgICBba2V5XTogKC4uLmFyZ3MpID0+IHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfSk7Cn0sIHt9KTsKbGV0IE1lc3NhZ2VJRCA9IDA7CmNvbnN0IGdldE1lc3NhZ2VJZCA9ICgpID0+IE1lc3NhZ2VJRCsrOwpjb25zdCBzZXJ2aWNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CmNvbnN0IHdhaXRTZXJ2aWNlQ2FsbGJhY2tzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKc2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKGUpID0+IHsKICBjb25zdCBtZXNzYWdlID0gZS5kYXRhOwogIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgUmVmbGVjdC5nZXQobWVzc2FnZSwgIl9fcHJveHlfaW50ZXJuYWwiKSAhPT0gIndhaXQiKSB7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IHNlcnZpY2VJZCA9IG1lc3NhZ2UucmVjZWl2ZXI7CiAgY29uc3QgdGltZW91dF8gPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgIGNvbnN0IGNhbGxiYWNrczIgPSAod2FpdFNlcnZpY2VDYWxsYmFja3MuZ2V0KHNlcnZpY2VJZCkgfHwgW10pLmZpbHRlcigoYykgPT4gYyAhPT0gY2FsbGJhY2spOwogICAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzMik7CiAgICAoZS5zb3VyY2UgfHwgc2VsZikucG9zdE1lc3NhZ2UoewogICAgICBfX3Byb3h5X2ludGVybmFsOiAid2FpdC1yZXBseSIsCiAgICAgIGVycm9yOiB0cnVlLAogICAgICBpZDogbWVzc2FnZS5pZCwKICAgICAgcGF5bG9hZDogW2BbcHJveHldd2FpdCBmb3Igc2VydmljZSAke3NlcnZpY2VJZH0gdGltZW91dC5gXQogICAgfSk7CiAgfSwgbWVzc2FnZS50aW1lb3V0KTsKICBjb25zdCBjYWxsYmFjayA9ICgpID0+IHsKICAgIGNsZWFyVGltZW91dCh0aW1lb3V0Xyk7CiAgICAoZS5zb3VyY2UgfHwgc2VsZikucG9zdE1lc3NhZ2UoewogICAgICBfX3Byb3h5X2ludGVybmFsOiAid2FpdC1yZXBseSIsCiAgICAgIGlkOiBtZXNzYWdlLmlkLAogICAgICBlcnJvcjogZmFsc2UsCiAgICAgIHBheWxvYWQ6IFtdCiAgICB9KTsKICAgIGNvbnN0IGNhbGxiYWNrczIgPSAod2FpdFNlcnZpY2VDYWxsYmFja3MuZ2V0KHNlcnZpY2VJZCkgfHwgW10pLmZpbHRlcigoYykgPT4gYyAhPT0gY2FsbGJhY2spOwogICAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzMik7CiAgfTsKICBjb25zdCBjYWxsYmFja3MgPSB3YWl0U2VydmljZUNhbGxiYWNrcy5nZXQoc2VydmljZUlkKSB8fCBbXTsKICBjYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzKTsKICBpZiAoc2VydmljZXMuaGFzKHNlcnZpY2VJZCkpIHsKICAgIGNhbGxiYWNrKCk7CiAgfQp9KTsKZnVuY3Rpb24gcmVnaXN0ZXJQcm94eShzZXJ2aWNlSWQsIG9iaikgewogIGlmIChzZXJ2aWNlcy5oYXMoc2VydmljZUlkKSkgewogICAgcmV0dXJuOwogIH0KICBzZXJ2aWNlcy5hZGQoc2VydmljZUlkKTsKICBjb25zdCBjYWxsYmFja3MgPSB3YWl0U2VydmljZUNhbGxiYWNrcy5nZXQoc2VydmljZUlkKTsKICBpZiAoY2FsbGJhY2tzKQogICAgY2FsbGJhY2tzLmZvckVhY2goKGNhbGxiYWNrKSA9PiBjYWxsYmFjaygpKTsKICBjb25zdCBzZXJ2aWNlSGFuZGxlciA9IGFzeW5jIChlKSA9PiB7CiAgICB2YXIgX2E7CiAgICBjb25zdCBtZXNzYWdlID0gZS5kYXRhOwogICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBSZWZsZWN0LmdldChtZXNzYWdlLCAiX19wcm94eV9pbnRlcm5hbCIpICE9PSAiY2FsbCIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKG1lc3NhZ2UucmVjZWl2ZXIgPT09IHNlcnZpY2VJZCkgewogICAgICBjb25zdCBtZXRob2QgPSBSZWZsZWN0LmdldChvYmosIG1lc3NhZ2UubWV0aG9kKTsKICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICAoZS5zb3VyY2UgfHwgc2VsZikucG9zdE1lc3NhZ2UoewogICAgICAgICAgX19wcm94eV9pbnRlcm5hbDogInJlcGx5IiwKICAgICAgICAgIGlkOiBtZXNzYWdlLmlkLAogICAgICAgICAgZXJyb3I6IHRydWUsCiAgICAgICAgICBwYXlsb2FkOiBbYFtwcm94eV0gbWV0aG9kIFxgJHttZXNzYWdlLm1ldGhvZH1cYCBkb2VzIG5vdCBleGlzdCBvbiByZW1vdGUgb2JqZWN0ICR7bWVzc2FnZS5yZWNlaXZlcn0gb3IgaXQgaXMgbm90IGEgZnVuY3Rpb24uYF0KICAgICAgICB9KTsKICAgICAgfQogICAgICBsZXQgcmVzID0gbWV0aG9kOwogICAgICBpZiAodHlwZW9mIG1ldGhvZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJlcyA9IGF3YWl0IG1ldGhvZC5jYWxsKG9iaiwgLi4ubWVzc2FnZS5wYXlsb2FkLCBlKTsKICAgICAgfQogICAgICBsb2dnZXIuZGVidWcoIltwcm94eV0gcmVwbHkiLCAoKF9hID0gc2VsZiA9PSBudWxsID8gdm9pZCAwIDogc2VsZi5sb2NhdGlvbikgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmhyZWYpIHx8ICJ3b3JrZXIiLCBlLnNvdXJjZSwgbWVzc2FnZS5yZWNlaXZlciwgbWVzc2FnZS5tZXRob2QsIGUuc291cmNlIHx8IHNlbGYpOwogICAgICAoZS5zb3VyY2UgfHwgc2VsZikucG9zdE1lc3NhZ2UoewogICAgICAgIF9fcHJveHlfaW50ZXJuYWw6ICJyZXBseSIsCiAgICAgICAgaWQ6IG1lc3NhZ2UuaWQsCiAgICAgICAgZXJyb3I6IGZhbHNlLAogICAgICAgIHBheWxvYWQ6IFtyZXNdCiAgICAgIH0pOwogICAgfQogIH07CiAgc2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgc2VydmljZUhhbmRsZXIpOwogIHJldHVybiAoKSA9PiB7CiAgICBzZWxmLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBzZXJ2aWNlSGFuZGxlcik7CiAgfTsKfQphc3luYyBmdW5jdGlvbiB3YWl0UHJveHkod2luLCBzZXJ2aWNlSWQsIHRpbWVvdXQgPSAxZTQpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUzLCByZWplY3QpID0+IHsKICAgIGNvbnN0IG1lc3NhZ2VJZCA9IGdldE1lc3NhZ2VJZCgpOwogICAgY29uc3QgdGltZW91dF8gPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgc2VsZi5yZW1vdmVFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgY2FsbGJhY2spOwogICAgICByZWplY3QoYFtwcm94eV0gd2FpdCBmb3IgJHtzZXJ2aWNlSWR9IHRpbWVvdXQgLmApOwogICAgfSwgdGltZW91dCk7CiAgICBjb25zdCBjYWxsYmFjayA9IChlKSA9PiB7CiAgICAgIGlmICgoZS5zb3VyY2UgfHwgc2VsZikgIT09IHdpbikKICAgICAgICByZXR1cm47CiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlLmRhdGE7CiAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgUmVmbGVjdC5nZXQobWVzc2FnZSwgIl9fcHJveHlfaW50ZXJuYWwiKSAhPT0gIndhaXQtcmVwbHkiIHx8IG1lc3NhZ2UuaWQgIT09IG1lc3NhZ2VJZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICByZXNvbHZlMyhudWxsKTsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRfKTsKICAgICAgc2VsZi5yZW1vdmVFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgY2FsbGJhY2spOwogICAgfTsKICAgIHNlbGYuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGNhbGxiYWNrKTsKICAgIHdpbi5wb3N0TWVzc2FnZSh7CiAgICAgIF9fcHJveHlfaW50ZXJuYWw6ICJ3YWl0IiwKICAgICAgcmVjZWl2ZXI6IHNlcnZpY2VJZCwKICAgICAgcGF5bG9hZDogW10sCiAgICAgIGVycm9yOiBmYWxzZSwKICAgICAgaWQ6IG1lc3NhZ2VJZAogICAgfSk7CiAgfSk7Cn0KYXN5bmMgZnVuY3Rpb24gY2FsbFByb3h5KHsgd2luLCBzZXJ2aWNlSWQsIG1ldGhvZCwgcGF5bG9hZCwgdGltZW91dCA9IDFlNCB9KSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlMywgcmVqZWN0KSA9PiB7CiAgICB2YXIgX2E7CiAgICBjb25zdCBtZXNzYWdlSWQgPSBnZXRNZXNzYWdlSWQoKTsKICAgIGxldCBoYW5kbGVyID0gc2VsZjsKICAgIGlmICh3aW4gaW5zdGFuY2VvZiBXb3JrZXIpIHsKICAgICAgaGFuZGxlciA9IHdpbjsKICAgIH0KICAgIGxldCB0aW1lb3V0XyA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICByZWplY3QoYGNhbGwgcmVtb3RlIG9iamVjdCAke3NlcnZpY2VJZH0gbWV0aG9kICR7bWV0aG9kLnRvU3RyaW5nKCl9IHRpbWVvdXRgKTsKICAgICAgaGFuZGxlci5yZW1vdmVFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgY2FsbGJhY2spOwogICAgfSwgdGltZW91dCk7CiAgICBjb25zdCBjYWxsYmFjayA9IChlKSA9PiB7CiAgICAgIHZhciBfYTI7CiAgICAgIGlmICghKHdpbiBpbnN0YW5jZW9mIFdvcmtlcikgJiYgKGUuc291cmNlIHx8IHNlbGYpICE9PSB3aW4pCiAgICAgICAgcmV0dXJuOwogICAgICBjb25zdCBtZXNzYWdlID0gZS5kYXRhOwogICAgICBpZiAodHlwZW9mIG1lc3NhZ2UgIT09ICJvYmplY3QiIHx8IFJlZmxlY3QuZ2V0KG1lc3NhZ2UsICJfX3Byb3h5X2ludGVybmFsIikgIT09ICJyZXBseSIgfHwgbWVzc2FnZS5pZCAhPT0gbWVzc2FnZUlkKQogICAgICAgIHJldHVybjsKICAgICAgaGFuZGxlci5yZW1vdmVFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgY2FsbGJhY2spOwogICAgICBjbGVhclRpbWVvdXQodGltZW91dF8pOwogICAgICBsb2dnZXIuZGVidWcoIltwcm94eV0gcmVjZWl2ZSByZXBseSIsICgoX2EyID0gc2VsZiA9PSBudWxsID8gdm9pZCAwIDogc2VsZi5sb2NhdGlvbikgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5ocmVmKSB8fCAid29ya2VyIiwgbWVzc2FnZS5pZCk7CiAgICAgIGlmIChtZXNzYWdlLmVycm9yKSB7CiAgICAgICAgcmVqZWN0KG1lc3NhZ2UucGF5bG9hZFswXSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHJlc29sdmUzKG1lc3NhZ2UucGF5bG9hZFswXSk7CiAgICB9OwogICAgaGFuZGxlci5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgY2FsbGJhY2spOwogICAgbG9nZ2VyLmRlYnVnKCJbcHJveHldIGNhbGwiLCAoKF9hID0gc2VsZiA9PSBudWxsID8gdm9pZCAwIDogc2VsZi5sb2NhdGlvbikgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmhyZWYpIHx8ICJ3b3JrZXIiLCBzZXJ2aWNlSWQsIG1ldGhvZCk7CiAgICB3aW4ucG9zdE1lc3NhZ2UoewogICAgICBpZDogbWVzc2FnZUlkLAogICAgICBfX3Byb3h5X2ludGVybmFsOiAiY2FsbCIsCiAgICAgIHJlY2VpdmVyOiBzZXJ2aWNlSWQsCiAgICAgIG1ldGhvZCwKICAgICAgcGF5bG9hZCwKICAgICAgZXJyb3I6IGZhbHNlCiAgICB9KTsKICB9KTsKfQpmdW5jdGlvbiBiaW5kU2NyaXB0TG9hZGVyVG9DdHgoY3R4MikgewogIGxldCBsb2FkaW5nTW9kdWxlTmFtZSA9ICIiOwogIGNvbnN0IHNjcmlwdExvYWRpbmdUYXNrcyA9IFtdOwogIGNvbnN0IGxvYWRTY3JpcHQgPSBhc3luYyAoZG9tLCB1cmwsIG1vZHVsZU5hbWUyID0gImdsb2JhbE9iaiIpID0+IHsKICAgIGlmIChsb2FkaW5nTW9kdWxlTmFtZSkgewogICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZTMpID0+IHsKICAgICAgICByZXNvbHZlMy5tb2R1bGVOYW1lID0gbW9kdWxlTmFtZTI7CiAgICAgICAgc2NyaXB0TG9hZGluZ1Rhc2tzLnB1c2gocmVzb2x2ZTMpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTMsIHJlamVjdCkgPT4gewogICAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgY29uc3QgdGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICBjdHgyLmxvZ2dlci5sb2coIlthbWRdIHNjcmlwdCBsb2FkIHRpbWVvdXQgIiArIG1vZHVsZU5hbWUyKTsKICAgICAgICByZWplY3QobmV3IEVycm9yKGBsb2FkIG1vZHVsZSAke21vZHVsZU5hbWUyfSB0aW1lb3V0YCkpOwogICAgICAgIChfYSA9IHNjcmlwdExvYWRpbmdUYXNrcy5zaGlmdCgpKSA9PSBudWxsID8gdm9pZCAwIDogX2EoKTsKICAgICAgfSwgY3R4Mi5zY3JpcHRUaW1lb3V0KTsKICAgICAgc2NyaXB0Lm9ubG9hZCA9ICgpID0+IHsKICAgICAgICB2YXIgX2E7CiAgICAgICAgY3R4Mi5sb2dnZXIubG9nKCJbYW1kXSBzY3JpcHQgcmVzb2x2ZWQiLCBsb2FkaW5nTW9kdWxlTmFtZSk7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHJlc29sdmUzKG51bGwpOwogICAgICAgIGxvYWRpbmdNb2R1bGVOYW1lID0gIiI7CiAgICAgICAgKF9hID0gc2NyaXB0TG9hZGluZ1Rhc2tzLnNoaWZ0KCkpID09IG51bGwgPyB2b2lkIDAgOiBfYSgpOwogICAgICB9OwogICAgICBzY3JpcHQub25lcnJvciA9IChlcnIpID0+IHsKICAgICAgICB2YXIgX2E7CiAgICAgICAgY3R4Mi5sb2dnZXIubG9nKCJbYW1kXSBzY3JpcHQgcmVqZWN0ZWQiLCBsb2FkaW5nTW9kdWxlTmFtZSk7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIGxvYWRpbmdNb2R1bGVOYW1lID0gIiI7CiAgICAgICAgKF9hID0gc2NyaXB0TG9hZGluZ1Rhc2tzLnNoaWZ0KCkpID09IG51bGwgPyB2b2lkIDAgOiBfYSgpOwogICAgICB9OwogICAgICBzY3JpcHQuY3Jvc3NPcmlnaW4gPSAiYW5vbnltb3VzIjsKICAgICAgc2NyaXB0LnNyYyA9IHVybDsKICAgICAgc2NyaXB0LnR5cGUgPSAidGV4dC9qYXZhc2NyaXB0IjsKICAgICAgY3R4Mi5sb2dnZXIubG9nKCJbYW1kXSBzdGFydCBsb2FkIHNjcmlwdCIsIG1vZHVsZU5hbWUyKTsKICAgICAgbG9hZGluZ01vZHVsZU5hbWUgPSBtb2R1bGVOYW1lMjsKICAgICAgZG9tLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICB9KTsKICB9OwogIGN0eDIuc2NyaXB0TG9hZGVyID0gewogICAgZ2V0TG9hZGluZ01vZHVsZU5hbWU6ICgpID0+IGxvYWRpbmdNb2R1bGVOYW1lLAogICAgbG9hZFNjcmlwdCwKICAgIHNjcmlwdExvYWRpbmdUYXNrcwogIH07Cn0KdmFyIElFdmVudFR5cGVzID0gLyogQF9fUFVSRV9fICovICgoSUV2ZW50VHlwZXMyKSA9PiB7CiAgSUV2ZW50VHlwZXMyWyJNb2R1bGVVcGRhdGUiXSA9ICJtb2R1bGUtdXBkYXRlIjsKICBJRXZlbnRUeXBlczJbIkxvYWRpbmdTY3JpcHQiXSA9ICJsb2FkaW5nLXNjcmlwdCI7CiAgcmV0dXJuIElFdmVudFR5cGVzMjsKfSkoSUV2ZW50VHlwZXMgfHwge30pOwpmdW5jdGlvbiBiaW5kRGVmaW5lVG9DdHgoY3R4MikgewogIGZ1bmN0aW9uIGRlZmluZShtb2R1bGVOYW1lMiwgZGVwZW5kZW5jaWVzXywgZmFjdG9yeTIpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlTmFtZTIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZmFjdG9yeTIgPSBtb2R1bGVOYW1lMjsKICAgICAgZGVwZW5kZW5jaWVzXyA9IFsicmVxdWlyZSIsICJleHBvcnRzIiwgIm1vZHVsZSJdOwogICAgICBtb2R1bGVOYW1lMiA9IGN0eDIuc2NyaXB0TG9hZGVyLmdldExvYWRpbmdNb2R1bGVOYW1lKCk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheShtb2R1bGVOYW1lMikpIHsKICAgICAgZmFjdG9yeTIgPSBkZXBlbmRlbmNpZXNfOwogICAgICBkZXBlbmRlbmNpZXNfID0gbW9kdWxlTmFtZTI7CiAgICAgIG1vZHVsZU5hbWUyID0gY3R4Mi5zY3JpcHRMb2FkZXIuZ2V0TG9hZGluZ01vZHVsZU5hbWUoKTsKICAgIH0KICAgIGN0eDIubG9nZ2VyLmxvZygiW2FtZF0gZGVmaW5lIG1vZHVsZSIsIG1vZHVsZU5hbWUyLCBkZXBlbmRlbmNpZXNfKTsKICAgIGNvbnN0IG1vZHVsZVBhdGgyID0gY3R4Mi5yZXF1aXJlXy5yZXNvbHZlKG1vZHVsZU5hbWUyKTsKICAgIGNvbnN0IHsgZmFjdG9yaWVzOiBmYWN0b3JpZXMyLCBjYWNoZTogY2FjaGUyLCBkZXBlbmRlbmNpZXM6IGRlcGVuZGVuY2llczIgfSA9IGN0eDIucmVxdWlyZV87CiAgICBpZiAoZmFjdG9yaWVzMi5oYXMobW9kdWxlUGF0aDIpKSB7CiAgICAgIGZhY3RvcmllczIuZGVsZXRlKG1vZHVsZVBhdGgyKTsKICAgIH0KICAgIGlmIChjYWNoZTIuaGFzKG1vZHVsZVBhdGgyKSkgewogICAgICBjYWNoZTIuZGVsZXRlKG1vZHVsZVBhdGgyKTsKICAgIH0KICAgIGlmIChkZXBlbmRlbmNpZXMyLmhhcyhtb2R1bGVQYXRoMikpIHsKICAgICAgZGVwZW5kZW5jaWVzMi5kZWxldGUobW9kdWxlUGF0aDIpOwogICAgfQogICAgY3R4Mi5ldmVudFN1YnNjcmliZU1hbmFnZXIudHJpZ2dlcihJRXZlbnRUeXBlcy5Nb2R1bGVVcGRhdGUsIG1vZHVsZVBhdGgyKTsKICAgIGZhY3RvcmllczIuc2V0KG1vZHVsZVBhdGgyLCBmYWN0b3J5Mik7CiAgICBkZXBlbmRlbmNpZXMyLnNldChtb2R1bGVQYXRoMiwgZGVwZW5kZW5jaWVzXyk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBjdHgyLmxvZ2dlci5sb2coIlthbWRdIG1vZHVsZSBkaXNwb3NlIiwgbW9kdWxlTmFtZTIpOwogICAgICBmYWN0b3JpZXMyLmRlbGV0ZShtb2R1bGVQYXRoMik7CiAgICB9OwogIH0KICBjdHgyLmRlZmluZSA9IE9iamVjdC5hc3NpZ24oZGVmaW5lLCB7CiAgICBhbWQ6IHt9CiAgfSk7Cn0KZnVuY3Rpb24gYXNzZXJ0UGF0aChwYXRoKSB7CiAgaWYgKHR5cGVvZiBwYXRoICE9PSAic3RyaW5nIikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiUGF0aCBtdXN0IGJlIGEgc3RyaW5nLiBSZWNlaXZlZCAiICsgSlNPTi5zdHJpbmdpZnkocGF0aCkpOwogIH0KfQpmdW5jdGlvbiBub3JtYWxpemVTdHJpbmdQb3NpeChwYXRoLCBhbGxvd0Fib3ZlUm9vdCkgewogIHZhciByZXMgPSAiIjsKICB2YXIgbGFzdFNlZ21lbnRMZW5ndGggPSAwOwogIHZhciBsYXN0U2xhc2ggPSAtMTsKICB2YXIgZG90cyA9IDA7CiAgdmFyIGNvZGU7CiAgZm9yICh2YXIgaSA9IDA7IGkgPD0gcGF0aC5sZW5ndGg7ICsraSkgewogICAgaWYgKGkgPCBwYXRoLmxlbmd0aCkKICAgICAgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKTsKICAgIGVsc2UgaWYgKGNvZGUgPT09IDQ3KQogICAgICBicmVhazsKICAgIGVsc2UKICAgICAgY29kZSA9IDQ3OwogICAgaWYgKGNvZGUgPT09IDQ3KSB7CiAgICAgIGlmIChsYXN0U2xhc2ggPT09IGkgLSAxIHx8IGRvdHMgPT09IDEpCiAgICAgICAgOwogICAgICBlbHNlIGlmIChsYXN0U2xhc2ggIT09IGkgLSAxICYmIGRvdHMgPT09IDIpIHsKICAgICAgICBpZiAocmVzLmxlbmd0aCA8IDIgfHwgbGFzdFNlZ21lbnRMZW5ndGggIT09IDIgfHwgcmVzLmNoYXJDb2RlQXQocmVzLmxlbmd0aCAtIDEpICE9PSA0NiB8fCByZXMuY2hhckNvZGVBdChyZXMubGVuZ3RoIC0gMikgIT09IDQ2KSB7CiAgICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgdmFyIGxhc3RTbGFzaEluZGV4ID0gcmVzLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICAgIGlmIChsYXN0U2xhc2hJbmRleCAhPT0gcmVzLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICBpZiAobGFzdFNsYXNoSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgICByZXMgPSAiIjsKICAgICAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzID0gcmVzLnNsaWNlKDAsIGxhc3RTbGFzaEluZGV4KTsKICAgICAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gcmVzLmxlbmd0aCAtIDEgLSByZXMubGFzdEluZGV4T2YoIi8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFNsYXNoID0gaTsKICAgICAgICAgICAgICBkb3RzID0gMDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChyZXMubGVuZ3RoID09PSAyIHx8IHJlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcmVzID0gIiI7CiAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMDsKICAgICAgICAgICAgbGFzdFNsYXNoID0gaTsKICAgICAgICAgICAgZG90cyA9IDA7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYWxsb3dBYm92ZVJvb3QpIHsKICAgICAgICAgIGlmIChyZXMubGVuZ3RoID4gMCkKICAgICAgICAgICAgcmVzICs9ICIvLi4iOwogICAgICAgICAgZWxzZQogICAgICAgICAgICByZXMgPSAiLi4iOwogICAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPSAyOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDApCiAgICAgICAgICByZXMgKz0gIi8iICsgcGF0aC5zbGljZShsYXN0U2xhc2ggKyAxLCBpKTsKICAgICAgICBlbHNlCiAgICAgICAgICByZXMgPSBwYXRoLnNsaWNlKGxhc3RTbGFzaCArIDEsIGkpOwogICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gaSAtIGxhc3RTbGFzaCAtIDE7CiAgICAgIH0KICAgICAgbGFzdFNsYXNoID0gaTsKICAgICAgZG90cyA9IDA7CiAgICB9IGVsc2UgaWYgKGNvZGUgPT09IDQ2ICYmIGRvdHMgIT09IC0xKSB7CiAgICAgICsrZG90czsKICAgIH0gZWxzZSB7CiAgICAgIGRvdHMgPSAtMTsKICAgIH0KICB9CiAgcmV0dXJuIHJlczsKfQpmdW5jdGlvbiBfZm9ybWF0KHNlcCwgcGF0aE9iamVjdCkgewogIHZhciBkaXIgPSBwYXRoT2JqZWN0LmRpciB8fCBwYXRoT2JqZWN0LnJvb3Q7CiAgdmFyIGJhc2UgPSBwYXRoT2JqZWN0LmJhc2UgfHwgKHBhdGhPYmplY3QubmFtZSB8fCAiIikgKyAocGF0aE9iamVjdC5leHQgfHwgIiIpOwogIGlmICghZGlyKSB7CiAgICByZXR1cm4gYmFzZTsKICB9CiAgaWYgKGRpciA9PT0gcGF0aE9iamVjdC5yb290KSB7CiAgICByZXR1cm4gZGlyICsgYmFzZTsKICB9CiAgcmV0dXJuIGRpciArIHNlcCArIGJhc2U7Cn0KdmFyIHBvc2l4ID0gewogIC8vIHBhdGgucmVzb2x2ZShbZnJvbSAuLi5dLCB0bykKICByZXNvbHZlOiBmdW5jdGlvbiByZXNvbHZlMigpIHsKICAgIHZhciByZXNvbHZlZFBhdGggPSAiIjsKICAgIHZhciByZXNvbHZlZEFic29sdXRlID0gZmFsc2U7CiAgICB2YXIgY3dkOwogICAgZm9yICh2YXIgaSA9IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpID49IC0xICYmICFyZXNvbHZlZEFic29sdXRlOyBpLS0pIHsKICAgICAgdmFyIHBhdGg7CiAgICAgIGlmIChpID49IDApCiAgICAgICAgcGF0aCA9IGFyZ3VtZW50c1tpXTsKICAgICAgZWxzZSB7CiAgICAgICAgaWYgKGN3ZCA9PT0gdm9pZCAwKQogICAgICAgICAgY3dkID0gcHJvY2Vzcy5jd2QoKTsKICAgICAgICBwYXRoID0gY3dkOwogICAgICB9CiAgICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHJlc29sdmVkUGF0aCA9IHBhdGggKyAiLyIgKyByZXNvbHZlZFBhdGg7CiAgICAgIHJlc29sdmVkQWJzb2x1dGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IDQ3OwogICAgfQogICAgcmVzb2x2ZWRQYXRoID0gbm9ybWFsaXplU3RyaW5nUG9zaXgocmVzb2x2ZWRQYXRoLCAhcmVzb2x2ZWRBYnNvbHV0ZSk7CiAgICBpZiAocmVzb2x2ZWRBYnNvbHV0ZSkgewogICAgICBpZiAocmVzb2x2ZWRQYXRoLmxlbmd0aCA+IDApCiAgICAgICAgcmV0dXJuICIvIiArIHJlc29sdmVkUGF0aDsKICAgICAgZWxzZQogICAgICAgIHJldHVybiAiLyI7CiAgICB9IGVsc2UgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiByZXNvbHZlZFBhdGg7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gIi4iOwogICAgfQogIH0sCiAgbm9ybWFsaXplOiBmdW5jdGlvbiBub3JtYWxpemUocGF0aCkgewogICAgYXNzZXJ0UGF0aChwYXRoKTsKICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkKICAgICAgcmV0dXJuICIuIjsKICAgIHZhciBpc0Fic29sdXRlMiA9IHBhdGguY2hhckNvZGVBdCgwKSA9PT0gNDc7CiAgICB2YXIgdHJhaWxpbmdTZXBhcmF0b3IgPSBwYXRoLmNoYXJDb2RlQXQocGF0aC5sZW5ndGggLSAxKSA9PT0gNDc7CiAgICBwYXRoID0gbm9ybWFsaXplU3RyaW5nUG9zaXgocGF0aCwgIWlzQWJzb2x1dGUyKTsKICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCAmJiAhaXNBYnNvbHV0ZTIpCiAgICAgIHBhdGggPSAiLiI7CiAgICBpZiAocGF0aC5sZW5ndGggPiAwICYmIHRyYWlsaW5nU2VwYXJhdG9yKQogICAgICBwYXRoICs9ICIvIjsKICAgIGlmIChpc0Fic29sdXRlMikKICAgICAgcmV0dXJuICIvIiArIHBhdGg7CiAgICByZXR1cm4gcGF0aDsKICB9LAogIGlzQWJzb2x1dGU6IGZ1bmN0aW9uIGlzQWJzb2x1dGUocGF0aCkgewogICAgYXNzZXJ0UGF0aChwYXRoKTsKICAgIHJldHVybiBwYXRoLmxlbmd0aCA+IDAgJiYgcGF0aC5jaGFyQ29kZUF0KDApID09PSA0NzsKICB9LAogIGpvaW46IGZ1bmN0aW9uIGpvaW4oKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgcmV0dXJuICIuIjsKICAgIHZhciBqb2luZWQ7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgYXJnID0gYXJndW1lbnRzW2ldOwogICAgICBhc3NlcnRQYXRoKGFyZyk7CiAgICAgIGlmIChhcmcubGVuZ3RoID4gMCkgewogICAgICAgIGlmIChqb2luZWQgPT09IHZvaWQgMCkKICAgICAgICAgIGpvaW5lZCA9IGFyZzsKICAgICAgICBlbHNlCiAgICAgICAgICBqb2luZWQgKz0gIi8iICsgYXJnOwogICAgICB9CiAgICB9CiAgICBpZiAoam9pbmVkID09PSB2b2lkIDApCiAgICAgIHJldHVybiAiLiI7CiAgICByZXR1cm4gcG9zaXgubm9ybWFsaXplKGpvaW5lZCk7CiAgfSwKICByZWxhdGl2ZTogZnVuY3Rpb24gcmVsYXRpdmUoZnJvbSwgdG8pIHsKICAgIGFzc2VydFBhdGgoZnJvbSk7CiAgICBhc3NlcnRQYXRoKHRvKTsKICAgIGlmIChmcm9tID09PSB0bykKICAgICAgcmV0dXJuICIiOwogICAgZnJvbSA9IHBvc2l4LnJlc29sdmUoZnJvbSk7CiAgICB0byA9IHBvc2l4LnJlc29sdmUodG8pOwogICAgaWYgKGZyb20gPT09IHRvKQogICAgICByZXR1cm4gIiI7CiAgICB2YXIgZnJvbVN0YXJ0ID0gMTsKICAgIGZvciAoOyBmcm9tU3RhcnQgPCBmcm9tLmxlbmd0aDsgKytmcm9tU3RhcnQpIHsKICAgICAgaWYgKGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQpICE9PSA0NykKICAgICAgICBicmVhazsKICAgIH0KICAgIHZhciBmcm9tRW5kID0gZnJvbS5sZW5ndGg7CiAgICB2YXIgZnJvbUxlbiA9IGZyb21FbmQgLSBmcm9tU3RhcnQ7CiAgICB2YXIgdG9TdGFydCA9IDE7CiAgICBmb3IgKDsgdG9TdGFydCA8IHRvLmxlbmd0aDsgKyt0b1N0YXJ0KSB7CiAgICAgIGlmICh0by5jaGFyQ29kZUF0KHRvU3RhcnQpICE9PSA0NykKICAgICAgICBicmVhazsKICAgIH0KICAgIHZhciB0b0VuZCA9IHRvLmxlbmd0aDsKICAgIHZhciB0b0xlbiA9IHRvRW5kIC0gdG9TdGFydDsKICAgIHZhciBsZW5ndGggPSBmcm9tTGVuIDwgdG9MZW4gPyBmcm9tTGVuIDogdG9MZW47CiAgICB2YXIgbGFzdENvbW1vblNlcCA9IC0xOwogICAgdmFyIGkgPSAwOwogICAgZm9yICg7IGkgPD0gbGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKGkgPT09IGxlbmd0aCkgewogICAgICAgIGlmICh0b0xlbiA+IGxlbmd0aCkgewogICAgICAgICAgaWYgKHRvLmNoYXJDb2RlQXQodG9TdGFydCArIGkpID09PSA0NykgewogICAgICAgICAgICByZXR1cm4gdG8uc2xpY2UodG9TdGFydCArIGkgKyAxKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaSA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gdG8uc2xpY2UodG9TdGFydCArIGkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZnJvbUxlbiA+IGxlbmd0aCkgewogICAgICAgICAgaWYgKGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKSA9PT0gNDcpIHsKICAgICAgICAgICAgbGFzdENvbW1vblNlcCA9IGk7CiAgICAgICAgICB9IGVsc2UgaWYgKGkgPT09IDApIHsKICAgICAgICAgICAgbGFzdENvbW1vblNlcCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHZhciBmcm9tQ29kZSA9IGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKTsKICAgICAgdmFyIHRvQ29kZSA9IHRvLmNoYXJDb2RlQXQodG9TdGFydCArIGkpOwogICAgICBpZiAoZnJvbUNvZGUgIT09IHRvQ29kZSkKICAgICAgICBicmVhazsKICAgICAgZWxzZSBpZiAoZnJvbUNvZGUgPT09IDQ3KQogICAgICAgIGxhc3RDb21tb25TZXAgPSBpOwogICAgfQogICAgdmFyIG91dCA9ICIiOwogICAgZm9yIChpID0gZnJvbVN0YXJ0ICsgbGFzdENvbW1vblNlcCArIDE7IGkgPD0gZnJvbUVuZDsgKytpKSB7CiAgICAgIGlmIChpID09PSBmcm9tRW5kIHx8IGZyb20uY2hhckNvZGVBdChpKSA9PT0gNDcpIHsKICAgICAgICBpZiAob3V0Lmxlbmd0aCA9PT0gMCkKICAgICAgICAgIG91dCArPSAiLi4iOwogICAgICAgIGVsc2UKICAgICAgICAgIG91dCArPSAiLy4uIjsKICAgICAgfQogICAgfQogICAgaWYgKG91dC5sZW5ndGggPiAwKQogICAgICByZXR1cm4gb3V0ICsgdG8uc2xpY2UodG9TdGFydCArIGxhc3RDb21tb25TZXApOwogICAgZWxzZSB7CiAgICAgIHRvU3RhcnQgKz0gbGFzdENvbW1vblNlcDsKICAgICAgaWYgKHRvLmNoYXJDb2RlQXQodG9TdGFydCkgPT09IDQ3KQogICAgICAgICsrdG9TdGFydDsKICAgICAgcmV0dXJuIHRvLnNsaWNlKHRvU3RhcnQpOwogICAgfQogIH0sCiAgX21ha2VMb25nOiBmdW5jdGlvbiBfbWFrZUxvbmcocGF0aCkgewogICAgcmV0dXJuIHBhdGg7CiAgfSwKICBkaXJuYW1lOiBmdW5jdGlvbiBkaXJuYW1lKHBhdGgpIHsKICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICBpZiAocGF0aC5sZW5ndGggPT09IDApCiAgICAgIHJldHVybiAiLiI7CiAgICB2YXIgY29kZSA9IHBhdGguY2hhckNvZGVBdCgwKTsKICAgIHZhciBoYXNSb290ID0gY29kZSA9PT0gNDc7CiAgICB2YXIgZW5kID0gLTE7CiAgICB2YXIgbWF0Y2hlZFNsYXNoID0gdHJ1ZTsKICAgIGZvciAodmFyIGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMTsgLS1pKSB7CiAgICAgIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSk7CiAgICAgIGlmIChjb2RlID09PSA0NykgewogICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICBlbmQgPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlOwogICAgICB9CiAgICB9CiAgICBpZiAoZW5kID09PSAtMSkKICAgICAgcmV0dXJuIGhhc1Jvb3QgPyAiLyIgOiAiLiI7CiAgICBpZiAoaGFzUm9vdCAmJiBlbmQgPT09IDEpCiAgICAgIHJldHVybiAiLy8iOwogICAgcmV0dXJuIHBhdGguc2xpY2UoMCwgZW5kKTsKICB9LAogIGJhc2VuYW1lOiBmdW5jdGlvbiBiYXNlbmFtZShwYXRoLCBleHQpIHsKICAgIGlmIChleHQgIT09IHZvaWQgMCAmJiB0eXBlb2YgZXh0ICE9PSAic3RyaW5nIikKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImV4dCIgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycpOwogICAgYXNzZXJ0UGF0aChwYXRoKTsKICAgIHZhciBzdGFydCA9IDA7CiAgICB2YXIgZW5kID0gLTE7CiAgICB2YXIgbWF0Y2hlZFNsYXNoID0gdHJ1ZTsKICAgIHZhciBpOwogICAgaWYgKGV4dCAhPT0gdm9pZCAwICYmIGV4dC5sZW5ndGggPiAwICYmIGV4dC5sZW5ndGggPD0gcGF0aC5sZW5ndGgpIHsKICAgICAgaWYgKGV4dC5sZW5ndGggPT09IHBhdGgubGVuZ3RoICYmIGV4dCA9PT0gcGF0aCkKICAgICAgICByZXR1cm4gIiI7CiAgICAgIHZhciBleHRJZHggPSBleHQubGVuZ3RoIC0gMTsKICAgICAgdmFyIGZpcnN0Tm9uU2xhc2hFbmQgPSAtMTsKICAgICAgZm9yIChpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHZhciBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICAgIGlmIChjb2RlID09PSA0NykgewogICAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgICAgc3RhcnQgPSBpICsgMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChmaXJzdE5vblNsYXNoRW5kID09PSAtMSkgewogICAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICAgICAgZmlyc3ROb25TbGFzaEVuZCA9IGkgKyAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4dElkeCA+PSAwKSB7CiAgICAgICAgICAgIGlmIChjb2RlID09PSBleHQuY2hhckNvZGVBdChleHRJZHgpKSB7CiAgICAgICAgICAgICAgaWYgKC0tZXh0SWR4ID09PSAtMSkgewogICAgICAgICAgICAgICAgZW5kID0gaTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXh0SWR4ID0gLTE7CiAgICAgICAgICAgICAgZW5kID0gZmlyc3ROb25TbGFzaEVuZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoc3RhcnQgPT09IGVuZCkKICAgICAgICBlbmQgPSBmaXJzdE5vblNsYXNoRW5kOwogICAgICBlbHNlIGlmIChlbmQgPT09IC0xKQogICAgICAgIGVuZCA9IHBhdGgubGVuZ3RoOwogICAgICByZXR1cm4gcGF0aC5zbGljZShzdGFydCwgZW5kKTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICBpZiAocGF0aC5jaGFyQ29kZUF0KGkpID09PSA0NykgewogICAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgICAgc3RhcnQgPSBpICsgMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChlbmQgPT09IC0xKSB7CiAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICAgIGVuZCA9IGkgKyAxOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZW5kID09PSAtMSkKICAgICAgICByZXR1cm4gIiI7CiAgICAgIHJldHVybiBwYXRoLnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgfQogIH0sCiAgZXh0bmFtZTogZnVuY3Rpb24gZXh0bmFtZShwYXRoKSB7CiAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgdmFyIHN0YXJ0RG90ID0gLTE7CiAgICB2YXIgc3RhcnRQYXJ0ID0gMDsKICAgIHZhciBlbmQgPSAtMTsKICAgIHZhciBtYXRjaGVkU2xhc2ggPSB0cnVlOwogICAgdmFyIHByZURvdFN0YXRlID0gMDsKICAgIGZvciAodmFyIGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgIHZhciBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICBpZiAoY29kZSA9PT0gNDcpIHsKICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgc3RhcnRQYXJ0ID0gaSArIDE7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGVuZCA9PT0gLTEpIHsKICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICBlbmQgPSBpICsgMTsKICAgICAgfQogICAgICBpZiAoY29kZSA9PT0gNDYpIHsKICAgICAgICBpZiAoc3RhcnREb3QgPT09IC0xKQogICAgICAgICAgc3RhcnREb3QgPSBpOwogICAgICAgIGVsc2UgaWYgKHByZURvdFN0YXRlICE9PSAxKQogICAgICAgICAgcHJlRG90U3RhdGUgPSAxOwogICAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewogICAgICAgIHByZURvdFN0YXRlID0gLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChzdGFydERvdCA9PT0gLTEgfHwgZW5kID09PSAtMSB8fCAvLyBXZSBzYXcgYSBub24tZG90IGNoYXJhY3RlciBpbW1lZGlhdGVseSBiZWZvcmUgdGhlIGRvdAogICAgcHJlRG90U3RhdGUgPT09IDAgfHwgLy8gVGhlIChyaWdodC1tb3N0KSB0cmltbWVkIHBhdGggY29tcG9uZW50IGlzIGV4YWN0bHkgJy4uJwogICAgcHJlRG90U3RhdGUgPT09IDEgJiYgc3RhcnREb3QgPT09IGVuZCAtIDEgJiYgc3RhcnREb3QgPT09IHN0YXJ0UGFydCArIDEpIHsKICAgICAgcmV0dXJuICIiOwogICAgfQogICAgcmV0dXJuIHBhdGguc2xpY2Uoc3RhcnREb3QsIGVuZCk7CiAgfSwKICBmb3JtYXQ6IGZ1bmN0aW9uIGZvcm1hdChwYXRoT2JqZWN0KSB7CiAgICBpZiAocGF0aE9iamVjdCA9PT0gbnVsbCB8fCB0eXBlb2YgcGF0aE9iamVjdCAhPT0gIm9iamVjdCIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlICJwYXRoT2JqZWN0IiBhcmd1bWVudCBtdXN0IGJlIG9mIHR5cGUgT2JqZWN0LiBSZWNlaXZlZCB0eXBlICcgKyB0eXBlb2YgcGF0aE9iamVjdCk7CiAgICB9CiAgICByZXR1cm4gX2Zvcm1hdCgiLyIsIHBhdGhPYmplY3QpOwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKHBhdGgpIHsKICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICB2YXIgcmV0ID0geyByb290OiAiIiwgZGlyOiAiIiwgYmFzZTogIiIsIGV4dDogIiIsIG5hbWU6ICIiIH07CiAgICBpZiAocGF0aC5sZW5ndGggPT09IDApCiAgICAgIHJldHVybiByZXQ7CiAgICB2YXIgY29kZSA9IHBhdGguY2hhckNvZGVBdCgwKTsKICAgIHZhciBpc0Fic29sdXRlMiA9IGNvZGUgPT09IDQ3OwogICAgdmFyIHN0YXJ0OwogICAgaWYgKGlzQWJzb2x1dGUyKSB7CiAgICAgIHJldC5yb290ID0gIi8iOwogICAgICBzdGFydCA9IDE7CiAgICB9IGVsc2UgewogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICB2YXIgc3RhcnREb3QgPSAtMTsKICAgIHZhciBzdGFydFBhcnQgPSAwOwogICAgdmFyIGVuZCA9IC0xOwogICAgdmFyIG1hdGNoZWRTbGFzaCA9IHRydWU7CiAgICB2YXIgaSA9IHBhdGgubGVuZ3RoIC0gMTsKICAgIHZhciBwcmVEb3RTdGF0ZSA9IDA7CiAgICBmb3IgKDsgaSA+PSBzdGFydDsgLS1pKSB7CiAgICAgIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSk7CiAgICAgIGlmIChjb2RlID09PSA0NykgewogICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICBzdGFydFBhcnQgPSBpICsgMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoZW5kID09PSAtMSkgewogICAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlOwogICAgICAgIGVuZCA9IGkgKyAxOwogICAgICB9CiAgICAgIGlmIChjb2RlID09PSA0NikgewogICAgICAgIGlmIChzdGFydERvdCA9PT0gLTEpCiAgICAgICAgICBzdGFydERvdCA9IGk7CiAgICAgICAgZWxzZSBpZiAocHJlRG90U3RhdGUgIT09IDEpCiAgICAgICAgICBwcmVEb3RTdGF0ZSA9IDE7CiAgICAgIH0gZWxzZSBpZiAoc3RhcnREb3QgIT09IC0xKSB7CiAgICAgICAgcHJlRG90U3RhdGUgPSAtMTsKICAgICAgfQogICAgfQogICAgaWYgKHN0YXJ0RG90ID09PSAtMSB8fCBlbmQgPT09IC0xIHx8IC8vIFdlIHNhdyBhIG5vbi1kb3QgY2hhcmFjdGVyIGltbWVkaWF0ZWx5IGJlZm9yZSB0aGUgZG90CiAgICBwcmVEb3RTdGF0ZSA9PT0gMCB8fCAvLyBUaGUgKHJpZ2h0LW1vc3QpIHRyaW1tZWQgcGF0aCBjb21wb25lbnQgaXMgZXhhY3RseSAnLi4nCiAgICBwcmVEb3RTdGF0ZSA9PT0gMSAmJiBzdGFydERvdCA9PT0gZW5kIC0gMSAmJiBzdGFydERvdCA9PT0gc3RhcnRQYXJ0ICsgMSkgewogICAgICBpZiAoZW5kICE9PSAtMSkgewogICAgICAgIGlmIChzdGFydFBhcnQgPT09IDAgJiYgaXNBYnNvbHV0ZTIpCiAgICAgICAgICByZXQuYmFzZSA9IHJldC5uYW1lID0gcGF0aC5zbGljZSgxLCBlbmQpOwogICAgICAgIGVsc2UKICAgICAgICAgIHJldC5iYXNlID0gcmV0Lm5hbWUgPSBwYXRoLnNsaWNlKHN0YXJ0UGFydCwgZW5kKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHN0YXJ0UGFydCA9PT0gMCAmJiBpc0Fic29sdXRlMikgewogICAgICAgIHJldC5uYW1lID0gcGF0aC5zbGljZSgxLCBzdGFydERvdCk7CiAgICAgICAgcmV0LmJhc2UgPSBwYXRoLnNsaWNlKDEsIGVuZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0Lm5hbWUgPSBwYXRoLnNsaWNlKHN0YXJ0UGFydCwgc3RhcnREb3QpOwogICAgICAgIHJldC5iYXNlID0gcGF0aC5zbGljZShzdGFydFBhcnQsIGVuZCk7CiAgICAgIH0KICAgICAgcmV0LmV4dCA9IHBhdGguc2xpY2Uoc3RhcnREb3QsIGVuZCk7CiAgICB9CiAgICBpZiAoc3RhcnRQYXJ0ID4gMCkKICAgICAgcmV0LmRpciA9IHBhdGguc2xpY2UoMCwgc3RhcnRQYXJ0IC0gMSk7CiAgICBlbHNlIGlmIChpc0Fic29sdXRlMikKICAgICAgcmV0LmRpciA9ICIvIjsKICAgIHJldHVybiByZXQ7CiAgfSwKICBzZXA6ICIvIiwKICBkZWxpbWl0ZXI6ICI6IiwKICB3aW4zMjogbnVsbCwKICBwb3NpeDogbnVsbAp9Owpwb3NpeC5wb3NpeCA9IHBvc2l4Owp2YXIgcGF0aEJyb3dzZXJpZnkgPSBwb3NpeDsKZnVuY3Rpb24gYmluZFJlcXVpcmVUb0N0eChjdHgpIHsKICBjb25zdCBjYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgZmFjdG9yaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCBkZXBlbmRlbmNpZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IG1vZHVsZVJlcXVpcmluZ1Rhc2tzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCBwYXJzZU1vZHVsZU5hbWUgPSBmdW5jdGlvbihtb2R1bGVOYW1lMikgewogICAgY29uc3QgWywgbmFtZSwgdmVyc2lvbiwgZmlsZV0gPSBtb2R1bGVOYW1lMi5tYXRjaCgvKF5AP1teL0BdKykoPzpAKFteL10rKSk/KC4qKS8pIHx8IFtdOwogICAgcmV0dXJuIFtuYW1lLCB2ZXJzaW9uLCBmaWxlXTsKICB9OwogIGNvbnN0IHJlc29sdmUgPSAobW9kdWxlTmFtZTIsIF9fZmlsZXBhdGgpID0+IHsKICAgIGlmIChbInJlcXVpcmUiLCAibW9kdWxlIiwgImV4cG9ydHMiXS5pbmNsdWRlcyhtb2R1bGVOYW1lMikpIHsKICAgICAgcmV0dXJuIG1vZHVsZU5hbWUyOwogICAgfQogICAgaWYgKHBhdGhCcm93c2VyaWZ5LmlzQWJzb2x1dGUobW9kdWxlTmFtZTIpKSB7CiAgICAgIHJldHVybiBtb2R1bGVOYW1lMjsKICAgIH0KICAgIGlmIChtb2R1bGVOYW1lMi5zdGFydHNXaXRoKCIuIikpIHsKICAgICAgaWYgKCFfX2ZpbGVwYXRoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbYW1kXSBjYW4ndCBub3QgcmVzb2x2ZSByZWxhdGl2ZSBwYXRoICR7bW9kdWxlTmFtZTJ9IHdpdGhvdXQgX19kaXJuYW1lYCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHBhdGhCcm93c2VyaWZ5LnJlc29sdmUocGF0aEJyb3dzZXJpZnkuZGlybmFtZShfX2ZpbGVwYXRoKSwgbW9kdWxlTmFtZTIpOwogICAgfQogICAgY29uc3QgW21vZHVsZVBhdGgyXSA9IHBhcnNlTW9kdWxlTmFtZShtb2R1bGVOYW1lMik7CiAgICByZXR1cm4gcGF0aEJyb3dzZXJpZnkucmVzb2x2ZShjdHgucm9vdCwgIm5vZGVfbW9kdWxlcyIsIG1vZHVsZVBhdGgyKTsKICB9OwogIGNvbnN0IHJlc29sdmVEZXBzID0gYXN5bmMgKF9wYWNrYWdlTmFtZSwgX3ZlcnNpb24sIF9maWxlKSA9PiB7CiAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgIHBhY2thZ2VOYW1lOiBfcGFja2FnZU5hbWUsCiAgICAgIHZlcnNpb246IF92ZXJzaW9uLAogICAgICBmaWxlOiBfZmlsZQogICAgfTsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGN0eC5wbHVnaW5SZWR1Y2UoCiAgICAgIGFzeW5jIChwcmVWYWx1ZSwgcGx1Z2luKSA9PiB7CiAgICAgICAgY29uc3QgcmVzMiA9IGF3YWl0IHBsdWdpbi5yZXNvbHZlTW9kdWxlVXJsKHByZVZhbHVlKTsKICAgICAgICBpZiAodHlwZW9mIHJlczIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN1bHQ6IHJlczIsCiAgICAgICAgICAgIGJyZWFrOiB0cnVlCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4geyByZXN1bHQ6IHJlczIgfTsKICAgICAgfSwKICAgICAgcGFyYW1zCiAgICApOwogICAgcmV0dXJuIHJlczsKICB9OwogIGNvbnN0IG1vZHVsZUZhY3RvcnkgPSBhc3luYyAobW9kdWxlTmFtZSwgX3RoaXMpID0+IHsKICAgIGNvbnN0IG1vZHVsZVBhdGggPSByZXNvbHZlKG1vZHVsZU5hbWUsIF90aGlzLl9fZGlybmFtZSk7CiAgICBpZiAobW9kdWxlUmVxdWlyaW5nVGFza3MuaGFzKG1vZHVsZVBhdGgpKSB7CiAgICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZTIyLCByZWplY3QpID0+IHsKICAgICAgICBjb25zdCB0YXNrcyA9IG1vZHVsZVJlcXVpcmluZ1Rhc2tzLmdldChtb2R1bGVQYXRoKTsKICAgICAgICB0YXNrcy5wdXNoKFtyZXNvbHZlMjIsIHJlamVjdF0pOwogICAgICAgIGN0eC5sb2dnZXIubG9nKGBbYW1kXSByZXF1aXJlICR7bW9kdWxlTmFtZX0sIGFscmVhZHkgaGFzIHRhc2sgcmVxdWlyaW5nLCB3YWl0aW5nIHRhc2tzOiAke3Rhc2tzLmxlbmd0aH0uYCk7CiAgICAgIH0pOwogICAgfQogICAgY3R4LmxvZ2dlci5sb2coIlthbWRdIHN0YXJ0IHJlcXVpcmUiLCBtb2R1bGVQYXRoKTsKICAgIG1vZHVsZVJlcXVpcmluZ1Rhc2tzLnNldChtb2R1bGVQYXRoLCBbXSk7CiAgICBjb25zdCBjbGVhckFsbFRhc2tzID0gKGVyciwgbW9kdWxlXzIpID0+IHsKICAgICAgY29uc3QgdGFza3MgPSBtb2R1bGVSZXF1aXJpbmdUYXNrcy5nZXQobW9kdWxlUGF0aCk7CiAgICAgIGlmICh0YXNrcyA9PSBudWxsID8gdm9pZCAwIDogdGFza3MubGVuZ3RoKSB7CiAgICAgICAgdGFza3MuZm9yRWFjaCgoW3Jlc29sdmUyMiwgcmVqZWN0XSwgaW5kZXgpID0+IHsKICAgICAgICAgIGN0eC5sb2dnZXIubG9nKCJbYW1kXSByZXNvbHZlIGl0ZW0iLCBpbmRleCwgbW9kdWxlTmFtZSk7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgfQogICAgICAgICAgcmVzb2x2ZTIyKG1vZHVsZV8yKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBtb2R1bGVSZXF1aXJpbmdUYXNrcy5kZWxldGUobW9kdWxlUGF0aCk7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICB0aHJvdyBlcnI7CiAgICAgIH0KICAgICAgcmV0dXJuIG1vZHVsZV8yOwogICAgfTsKICAgIGlmIChjYWNoZS5oYXMobW9kdWxlUGF0aCkpIHsKICAgICAgY3R4LmxvZ2dlci5sb2coYFthbWRdIHJlcXVpcmUgJHttb2R1bGVOYW1lfSwgcmVzb2x2ZWQgZnJvbSBjYWNoZWApOwogICAgICByZXR1cm4gY2xlYXJBbGxUYXNrcyh2b2lkIDAsIGNhY2hlLmdldChtb2R1bGVQYXRoKSk7CiAgICB9CiAgICBjb25zdCByZXF1aXJlXyA9IGdldFJlcXVpcmVGdW5jKHsgX19kaXJuYW1lOiBtb2R1bGVQYXRoIH0pOwogICAgbGV0IGZhY3RvcnkgPSBmYWN0b3JpZXMuZ2V0KG1vZHVsZVBhdGgpOwogICAgaWYgKCFmYWN0b3J5KSB7CiAgICAgIGlmICghbW9kdWxlTmFtZS5zdGFydHNXaXRoKCIuIikgJiYgIW1vZHVsZU5hbWUuc3RhcnRzV2l0aCgiX18iKSAmJiAhcGF0aEJyb3dzZXJpZnkuaXNBYnNvbHV0ZShtb2R1bGVOYW1lKSkgewogICAgICAgIGNvbnN0IFtuYW1lLCB2ZXJzaW9uLCBmaWxlXSA9IHBhcnNlTW9kdWxlTmFtZShtb2R1bGVOYW1lKTsKICAgICAgICBjb25zdCBzY3JpcHRVcmwgPSBhd2FpdCByZXF1aXJlXy5yZXNvbHZlRGVwcyhuYW1lLCB2ZXJzaW9uLCBmaWxlKTsKICAgICAgICBjdHguZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLnRyaWdnZXIoSUV2ZW50VHlwZXMuTG9hZGluZ1NjcmlwdCwgbW9kdWxlTmFtZSwgc2NyaXB0VXJsKTsKICAgICAgICBpZiAodHlwZW9mIHNjcmlwdFVybCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIGF3YWl0IGN0eC5zY3JpcHRMb2FkZXIubG9hZFNjcmlwdChjdHguc2NyaXB0Q29udGFpbmVyRG9tLCBzY3JpcHRVcmwsIG1vZHVsZU5hbWUpOwogICAgICAgICAgZmFjdG9yeSA9IGZhY3Rvcmllcy5nZXQobW9kdWxlUGF0aCk7CiAgICAgICAgICBjdHgubG9nZ2VyLmxvZygiW2FtZF0gc2NyaXB0IGxvYWRlZCIsIGZhY3RvcnksIG1vZHVsZVBhdGgpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWZhY3RvcnkpIHsKICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoYFthbWRdIG1vZHVsZSBlcnJvcjogJHttb2R1bGVQYXRofSBkb2VzIG5vdCBleGlzdC5gKTsKICAgICAgICByZXR1cm4gY2xlYXJBbGxUYXNrcyhlcnIpOwogICAgICB9CiAgICB9CiAgICBsZXQgZGVwTW9kdWxlTmFtZXMgPSBkZXBlbmRlbmNpZXMuZ2V0KG1vZHVsZVBhdGgpOwogICAgaWYgKHR5cGVvZiBmYWN0b3J5ID09PSAic3RyaW5nIikgewogICAgICBjb25zdCB7IGRlcHM6IF9kZXBNb2R1bGVOYW1lcywgZmFjdG9yeTogZmFjdG9yeV8gfSA9IGF3YWl0IGN0eC5wbHVnaW5SZWR1Y2UoYXN5bmMgKHByZVZhbHVlLCBwbHVnaW4pID0+IHsKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwbHVnaW4uYmVmb3JlTW9kdWxlR2VuZXJhdGUoX3RoaXMsIHByZVZhbHVlKTsKICAgICAgICByZXR1cm4geyByZXN1bHQ6IHsgLi4ucmVzdWx0LCBuYW1lOiBtb2R1bGVOYW1lIH0gfTsKICAgICAgfSwgeyBuYW1lOiBtb2R1bGVOYW1lLCBkZXBzOiBkZXBNb2R1bGVOYW1lcywgZmFjdG9yeSB9KTsKICAgICAgZmFjdG9yeSA9IGZhY3RvcnlfOwogICAgICBkZXBNb2R1bGVOYW1lcyA9IF9kZXBNb2R1bGVOYW1lczsKICAgIH0KICAgIGNvbnN0IF9leHBvcnRzID0ge307CiAgICBjb25zdCBjb21tb25qcyA9IHsKICAgICAgcmVxdWlyZTogcmVxdWlyZV8sCiAgICAgIG1vZHVsZTogeyBleHBvcnRzOiBfZXhwb3J0cyB9LAogICAgICBleHBvcnRzOiBfZXhwb3J0cwogICAgfTsKICAgIGxldCBkZXBzID0gW107CiAgICBpZiAoZGVwTW9kdWxlTmFtZXMgPT0gbnVsbCA/IHZvaWQgMCA6IGRlcE1vZHVsZU5hbWVzLmxlbmd0aCkgewogICAgICBkZXBzID0gYXdhaXQgUHJvbWlzZS5hbGwoZGVwTW9kdWxlTmFtZXMubWFwKChkZXBOYW1lKSA9PiB7CiAgICAgICAgaWYgKGNvbW1vbmpzW2RlcE5hbWVdKQogICAgICAgICAgcmV0dXJuIGNvbW1vbmpzW2RlcE5hbWVdOwogICAgICAgIHJldHVybiByZXF1aXJlXyhkZXBOYW1lKTsKICAgICAgfSkpOwogICAgfQogICAgdHJ5IHsKICAgICAgbGV0IGV4cG9ydHNSZXR1cm47CiAgICAgIGlmICh0eXBlb2YgZmFjdG9yeSA9PT0gInN0cmluZyIpIHsKICAgICAgICBleHBvcnRzUmV0dXJuID0gYXdhaXQgZXZhbChmYWN0b3J5KSguLi5kZXBzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBleHBvcnRzUmV0dXJuID0gYXdhaXQgZmFjdG9yeSguLi5kZXBzKTsKICAgICAgfQogICAgICBjb25zdCBtb2R1bGVfID0gKCgpID0+IHsKICAgICAgICBpZiAoT2JqZWN0LmtleXMoY29tbW9uanMubW9kdWxlLmV4cG9ydHMpLmxlbmd0aCB8fCB0eXBlb2YgY29tbW9uanMubW9kdWxlLmV4cG9ydHMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gY29tbW9uanMubW9kdWxlLmV4cG9ydHM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHBvcnRzUmV0dXJuOwogICAgICB9KSgpOwogICAgICBjYWNoZS5zZXQobW9kdWxlUGF0aCwgbW9kdWxlXyk7CiAgICAgIGN0eC5sb2dnZXIubG9nKCJbYW1kXSByZXNvbHZlIG1vZHVsZSB0YXNrcyBoZWFkIiwgbW9kdWxlUGF0aCwgbW9kdWxlXyk7CiAgICAgIHJldHVybiBjbGVhckFsbFRhc2tzKHZvaWQgMCwgbW9kdWxlXyk7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgcmV0dXJuIGNsZWFyQWxsVGFza3MoZXJyLCB2b2lkIDApOwogICAgfQogIH07CiAgY29uc3QgcmVxdWlyZVByb3RvID0gYXN5bmMgKF90aGlzMiwgLi4uYXJncykgPT4gewogICAgY29uc3QgW21vZHVsZU5hbWVzXywgY2JdID0gYXJnczsKICAgIGNvbnN0IG1vZHVsZU5hbWVzID0gYXdhaXQgY3R4LnBsdWdpblJlZHVjZShhc3luYyAocHJlVmFsdWUsIHBsdWdpbikgPT4gewogICAgICByZXR1cm4gewogICAgICAgIHJlc3VsdDogYXdhaXQgcGx1Z2luLnJlcXVpcmUoX3RoaXMyLCBwcmVWYWx1ZSkKICAgICAgfTsKICAgIH0sIG1vZHVsZU5hbWVzXyk7CiAgICBsZXQgbW9kdWxlczsKICAgIGlmIChBcnJheS5pc0FycmF5KG1vZHVsZU5hbWVzKSkgewogICAgICBtb2R1bGVzID0gYXdhaXQgUHJvbWlzZS5hbGwobW9kdWxlTmFtZXMubWFwKChuYW1lKSA9PiBtb2R1bGVGYWN0b3J5KG5hbWUsIF90aGlzMikpKTsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZXMgPSBhd2FpdCBtb2R1bGVGYWN0b3J5KG1vZHVsZU5hbWVzLCBfdGhpczIpOwogICAgfQogICAgY2IgPT0gbnVsbCA/IHZvaWQgMCA6IGNiKG1vZHVsZXMpOwogICAgcmV0dXJuIG1vZHVsZXM7CiAgfTsKICBjb25zdCBnZXRSZXF1aXJlRnVuYyA9IChfdGhpczIpID0+IHsKICAgIHZhciBfYTsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKHJlcXVpcmVQcm90by5iaW5kKG51bGwsIF90aGlzMiksIHsKICAgICAgY2FjaGUsCiAgICAgIGZhY3RvcmllcywKICAgICAgcmVzb2x2ZSwKICAgICAgZGVwZW5kZW5jaWVzLAogICAgICBtb2R1bGVSZXF1aXJpbmdUYXNrcywKICAgICAgLy8g6L+Z5LmI5Y+W5YC85piv5Li65LqG5Y+v5Lul5LuO5aSW6YOo6KaG55uW5o6JIHJlc29sdmVEZXBzIOeahOmAu+i+kQogICAgICByZXNvbHZlRGVwczogKChfYSA9IGN0eCA9PSBudWxsID8gdm9pZCAwIDogY3R4LnJlcXVpcmVfKSA9PSBudWxsID8gdm9pZCAwIDogX2EucmVzb2x2ZURlcHMpIHx8IHJlc29sdmVEZXBzCiAgICB9KTsKICB9OwogIGN0eC5yZXF1aXJlXyA9IGdldFJlcXVpcmVGdW5jKHsgX19kaXJuYW1lOiBjdHgucm9vdCB9KTsKfQpjb25zdCBjcmVhdGVFdmVudFN1YnNjcmliZU1hbmFnZXIgPSAoKSA9PiB7CiAgY29uc3QgZXZlbnRzSGFuZGxlcnNNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IHRyaWdnZXIgPSAoa2V5LCAuLi5wYXJhbXMpID0+IHsKICAgIGNvbnN0IGhhbmRsZXJzID0gZXZlbnRzSGFuZGxlcnNNYXAuZ2V0KGtleSk7CiAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgY29uc3QgZHJvcHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBoYW5kbGVycy5mb3JFYWNoKChoYW5kbGVyLCBpbmRleCkgPT4gewogICAgICAgIGlmIChoYW5kbGVyLmZpbHRlciAmJiAhaGFuZGxlci5maWx0ZXIoLi4ucGFyYW1zKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBoYW5kbGVyKC4uLnBhcmFtcyk7CiAgICAgICAgaWYgKGhhbmRsZXIub25jZSkgewogICAgICAgICAgZHJvcHMuc2V0KGluZGV4LCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBldmVudHNIYW5kbGVyc01hcC5zZXQoa2V5LCBoYW5kbGVycy5maWx0ZXIoKF8sIGluZGV4KSA9PiAhZHJvcHMuZ2V0KGluZGV4KSkpOwogICAgfQogIH07CiAgY29uc3QgbGlzdGVuID0gKGtleSwgY2IsIGZpbHRlcikgPT4gewogICAgdmFyIF9hLCBfYjsKICAgIGlmICghZXZlbnRzSGFuZGxlcnNNYXAuaGFzKGtleSkpIHsKICAgICAgZXZlbnRzSGFuZGxlcnNNYXAuc2V0KGtleSwgW10pOwogICAgfQogICAgKF9iID0gKF9hID0gZXZlbnRzSGFuZGxlcnNNYXAuZ2V0KGtleSkpID09IG51bGwgPyB2b2lkIDAgOiBfYS5wdXNoKSA9PSBudWxsID8gdm9pZCAwIDogX2IuY2FsbChfYSwgT2JqZWN0LmFzc2lnbihjYiwgewogICAgICBmaWx0ZXIKICAgIH0pKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBfYTI7CiAgICAgIChfYTIgPSBldmVudHNIYW5kbGVyc01hcC5nZXQoa2V5KSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5maWx0ZXIoKGhhbmRsZXIpID0+IGhhbmRsZXIgIT09IGNiKTsKICAgIH07CiAgfTsKICBjb25zdCBvbmNlID0gKGtleSwgY2IsIGZpbHRlciwgb25UaW1lb3V0LCB0aW1lb3V0ID0gLTEpID0+IHsKICAgIHZhciBfYSwgX2I7CiAgICBpZiAoIWV2ZW50c0hhbmRsZXJzTWFwLmhhcyhrZXkpKSB7CiAgICAgIGV2ZW50c0hhbmRsZXJzTWFwLnNldChrZXksIFtdKTsKICAgIH0KICAgIGNvbnN0IGRpc3Bvc2UgPSAoKSA9PiB7CiAgICAgIHZhciBfYTI7CiAgICAgIChfYTIgPSBldmVudHNIYW5kbGVyc01hcC5nZXQoa2V5KSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5maWx0ZXIoKGhhbmRsZXIpID0+IGhhbmRsZXIgIT09IGNiKTsKICAgIH07CiAgICBsZXQgX3RpbWVvdXQ7CiAgICBpZiAodGltZW91dCAhPT0gLTEpIHsKICAgICAgX3RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBkaXNwb3NlKCk7CiAgICAgICAgb25UaW1lb3V0ID09IG51bGwgPyB2b2lkIDAgOiBvblRpbWVvdXQoKTsKICAgICAgfSwgdGltZW91dCk7CiAgICB9CiAgICAoX2IgPSAoX2EgPSBldmVudHNIYW5kbGVyc01hcC5nZXQoa2V5KSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnB1c2gpID09IG51bGwgPyB2b2lkIDAgOiBfYi5jYWxsKF9hLCBPYmplY3QuYXNzaWduKCguLi5hcmdzKSA9PiB7CiAgICAgIGlmIChfdGltZW91dCkKICAgICAgICBjbGVhclRpbWVvdXQoX3RpbWVvdXQpOwogICAgICBjYiguLi5hcmdzKTsKICAgIH0sIHsKICAgICAgb25jZTogdHJ1ZSwKICAgICAgZmlsdGVyCiAgICB9KSk7CiAgICByZXR1cm4gZGlzcG9zZTsKICB9OwogIHJldHVybiB7IHRyaWdnZXIsIGxpc3Rlbiwgb25jZSB9Owp9OwpmdW5jdGlvbiBjcmVhdGVBbWRNYW5hZ2VyKHJvb3QgPSAiLyIsIHNjcmlwdFRpbWVvdXQgPSAxZTQsIGxvZ2dlcjIgPSBjb25zb2xlKSB7CiAgY29uc3QgY3R4MiA9IHt9OwogIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyID0gY3JlYXRlRXZlbnRTdWJzY3JpYmVNYW5hZ2VyKCk7CiAgY3R4Mi5yb290ID0gcm9vdDsKICBjdHgyLnNjcmlwdFRpbWVvdXQgPSBzY3JpcHRUaW1lb3V0OwogIGN0eDIuc2NyaXB0Q29udGFpbmVyRG9tID0gZG9jdW1lbnQuYm9keTsKICBjdHgyLmxvZ2dlciA9IGxvZ2dlcjI7CiAgY3R4Mi5wbHVnaW5zID0gW107CiAgY3R4Mi5wbHVnaW5SZWR1Y2UgPSBhc3luYyAocmVkdWNlciwgaW5pdFZhbHVlKSA9PiB7CiAgICBsZXQgcmVzdWx0ID0gaW5pdFZhbHVlOwogICAgZm9yIChjb25zdCBwbHVnaW4gb2YgY3R4Mi5wbHVnaW5zKSB7CiAgICAgIGNvbnN0IHsgcmVzdWx0OiByZXMsIGJyZWFrOiBicmVha18gfSA9IGF3YWl0IHJlZHVjZXIocmVzdWx0LCBwbHVnaW4pOwogICAgICBpZiAoYnJlYWtfKSB7CiAgICAgICAgcmV0dXJuIHJlczsKICAgICAgfQogICAgICByZXN1bHQgPSByZXM7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgYmluZFJlcXVpcmVUb0N0eChjdHgyKTsKICBiaW5kRGVmaW5lVG9DdHgoY3R4Mik7CiAgYmluZFNjcmlwdExvYWRlclRvQ3R4KGN0eDIpOwogIGZ1bmN0aW9uIGltcG9ydEdsb2JhbE9iamVjdFNjcmlwdCh0YXJnZXQsIHVybCwgbmFtZSkgewogICAgcmV0dXJuIGFzeW5jIChfcmVxdWlyZSkgPT4gewogICAgICBhd2FpdCBjdHgyLnNjcmlwdExvYWRlci5sb2FkU2NyaXB0KHRhcmdldCwgdXJsKTsKICAgICAgcmV0dXJuIHsKICAgICAgICAiZGVmYXVsdCI6IFJlZmxlY3QuZ2V0KHdpbmRvdywgbmFtZSksCiAgICAgICAgLi4uUmVmbGVjdC5nZXQod2luZG93LCBuYW1lKQogICAgICB9OwogICAgfTsKICB9CiAgY29uc3QgbW9kdWxlXzIgPSB7CiAgICByZXF1aXJlXzogY3R4Mi5yZXF1aXJlXywKICAgIGRlZmluZTogY3R4Mi5kZWZpbmUsCiAgICBfaW1wb3J0OiBpbXBvcnRHbG9iYWxPYmplY3RTY3JpcHQuYmluZChudWxsLCBjdHgyLnNjcmlwdENvbnRhaW5lckRvbSksCiAgICBzZXQ6ICh7IHRhcmdldCwgcmVzb2x2ZTogX3Jlc29sdmUgfSkgPT4gewogICAgICBpZiAoX3Jlc29sdmUpIHsKICAgICAgICBjdHgyLnJlcXVpcmVfLnJlc29sdmVEZXBzID0gX3Jlc29sdmU7CiAgICAgIH0KICAgICAgaWYgKHRhcmdldCkgewogICAgICAgIGN0eDIuc2NyaXB0Q29udGFpbmVyRG9tID0gdGFyZ2V0OwogICAgICB9CiAgICB9LAogICAgb25Nb2R1bGVVcGRhdGUodGFyZ2V0cywgY2IpIHsKICAgICAgcmV0dXJuIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLmxpc3RlbihJRXZlbnRUeXBlcy5Nb2R1bGVVcGRhdGUsIChtb2R1bGVOYW1lMikgPT4gewogICAgICAgIGlmICghdGFyZ2V0cyB8fCB0YXJnZXRzLmluY2x1ZGVzKG1vZHVsZU5hbWUyKSkgewogICAgICAgICAgY2IoW21vZHVsZU5hbWUyXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBvbk1vZHVsZUxvYWRpbmcoY2IpIHsKICAgICAgcmV0dXJuIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLmxpc3RlbihJRXZlbnRUeXBlcy5Mb2FkaW5nU2NyaXB0LCAobW9kdWxlTmFtZTIsIHVybCkgPT4gewogICAgICAgIGNiKG1vZHVsZU5hbWUyLCB1cmwpOwogICAgICB9KTsKICAgIH0sCiAgICBtb3VudFRvR2xvYmFsKGdsb2JhbF8gPSB3aW5kb3cpIHsKICAgICAgY29uc3QgY3VycmVudERlZmluZSA9IFJlZmxlY3QuZ2V0KGdsb2JhbF8sICJkZWZpbmUiKTsKICAgICAgY29uc3QgY3VycmVudFJlcXVpcmUgPSBSZWZsZWN0LmdldChnbG9iYWxfLCAicmVxdWlyZSIpOwogICAgICBSZWZsZWN0LnNldChnbG9iYWxfLCAiZGVmaW5lIiwgY3R4Mi5kZWZpbmUpOwogICAgICBSZWZsZWN0LnNldChnbG9iYWxfLCAicmVxdWlyZSIsIGN0eDIucmVxdWlyZV8pOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIFJlZmxlY3Quc2V0KGdsb2JhbF8sICJkZWZpbmUiLCBjdXJyZW50RGVmaW5lKTsKICAgICAgICBSZWZsZWN0LnNldChnbG9iYWxfLCAicmVxdWlyZSIsIGN1cnJlbnRSZXF1aXJlKTsKICAgICAgfTsKICAgIH0sCiAgICBzZXRQbHVnaW5zKHBsdWdpbnMpIHsKICAgICAgY3R4Mi5wbHVnaW5zID0gcGx1Z2luczsKICAgIH0KICB9OwogIGN0eDIuZGVmaW5lKCJtb2R1bGUtbWFuYWdlciIsIFtdLCBhc3luYyAoKSA9PiAoewogICAgZGVmYXVsdDogbW9kdWxlXzIsCiAgICAuLi5tb2R1bGVfMgogIH0pKTsKICByZXR1cm4gbW9kdWxlXzI7Cn0KY3JlYXRlQW1kTWFuYWdlcigpOwpjb25zdCBEZW1vU2VydmljZU5hbWUgPSAiZGVtby1zZXJ2aWNlIjsKY29uc3QgTk9USUZJQ0FUSU9OX1NFUlZJQ0UgPSAiaWZyYW1lLW5vdGlmaWNhdGlvbi1zZXJ2aWNlIjsKY29uc3QgaWZyYW1lUmVhZHkgPSBhc3luYyAoKSA9PiB7CiAgcmVnaXN0ZXJQcm94eShOT1RJRklDQVRJT05fU0VSVklDRSwgewogICAgaWZyYW1lUmVhZHk6IGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSk7CiAgY29uc3QgcGFyZW50ID0gd2luZG93LnRvcCB8fCB3aW5kb3cucGFyZW50IHx8IHdpbmRvdy5vcGVuZXI7CiAgaWYgKCFwYXJlbnQpCiAgICByZXR1cm47CiAgcmV0dXJuIGNhbGxQcm94eSh7CiAgICB3aW46IHBhcmVudCwKICAgIHNlcnZpY2VJZDogTk9USUZJQ0FUSU9OX1NFUlZJQ0UsCiAgICBtZXRob2Q6ICJpZnJhbWVSZWFkeSIsCiAgICBwYXlsb2FkOiBbXQogIH0pOwp9Owpjb25zdCBpZnJhbWVMb2FkaW5nTW9kdWxlID0gYXN5bmMgKG1vZHVsZU5hbWUyLCBleHRyYUluZm8pID0+IHsKICBjb25zdCBwYXJlbnQgPSB3aW5kb3cudG9wIHx8IHdpbmRvdy5wYXJlbnQgfHwgd2luZG93Lm9wZW5lcjsKICBpZiAoIXBhcmVudCkKICAgIHJldHVybjsKICByZXR1cm4gY2FsbFByb3h5KHsKICAgIHdpbjogcGFyZW50LAogICAgc2VydmljZUlkOiBOT1RJRklDQVRJT05fU0VSVklDRSwKICAgIG1ldGhvZDogImlmcmFtZUxvYWRpbmdNb2R1bGUiLAogICAgcGF5bG9hZDogW21vZHVsZU5hbWUyLCBleHRyYUluZm9dCiAgfSk7Cn07CmZ1bmN0aW9uIGdlbmVyYXRlUGx1Z2lucyhwbHVnaW5zU2VydmljZUlkKSB7CiAgY29uc3QgcGFyZW50ID0gd2luZG93LnBhcmVudCB8fCB3aW5kb3cudG9wIHx8IHdpbmRvdy5vcGVuZXI7CiAgY29uc3QgZ2VuZXJhdGVNZXRob2QgPSAoa2V5LCBzZXJ2aWNlSWQpID0+IGFzeW5jICguLi5hcmdzKSA9PiB7CiAgICBhd2FpdCB3YWl0UHJveHkocGFyZW50LCBzZXJ2aWNlSWQpOwogICAgcmV0dXJuIGF3YWl0IGNhbGxQcm94eSh7CiAgICAgIHdpbjogcGFyZW50LAogICAgICBzZXJ2aWNlSWQsCiAgICAgIG1ldGhvZDoga2V5LAogICAgICBwYXlsb2FkOiBhcmdzCiAgICB9KTsKICB9OwogIHJldHVybiBwbHVnaW5zU2VydmljZUlkLm1hcCgoc2VydmljZUlkKSA9PiB7CiAgICBjb25zdCBrZXlzID0gWyJyZXF1aXJlIiwgImJlZm9yZU1vZHVsZUdlbmVyYXRlIiwgInJlc29sdmVNb2R1bGVVcmwiXTsKICAgIHJldHVybiBrZXlzLnJlZHVjZSgocHJlLCBrZXkpID0+IHsKICAgICAgcmV0dXJuIHsKICAgICAgICAuLi5wcmUsCiAgICAgICAgW2tleV06IGdlbmVyYXRlTWV0aG9kKGtleSwgc2VydmljZUlkKQogICAgICB9OwogICAgfSwge30pOwogIH0pOwp9CmNvbnN0IG1hbmFnZXIgPSBjcmVhdGVBbWRNYW5hZ2VyKHZvaWQgMCwgdm9pZCAwLCBsb2dnZXIpOwptYW5hZ2VyLm1vdW50VG9HbG9iYWwoKTsKY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwpkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKbWFuYWdlci5vbk1vZHVsZUxvYWRpbmcoaWZyYW1lTG9hZGluZ01vZHVsZSk7CnJlZ2lzdGVyUHJveHkoRGVtb1NlcnZpY2VOYW1lLCB7CiAgZGVmaW5lTW9kdWxlOiBhc3luYyAobmFtZSwgZGVwczIsIGZhY3RvcnkyKSA9PiB7CiAgICBtYW5hZ2VyLmRlZmluZShuYW1lLCBkZXBzMiwgZmFjdG9yeTIpOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBleGVjdXRlTW9kdWxlOiBhc3luYyAobmFtZSkgPT4gewogICAgYXdhaXQgbWFuYWdlci5yZXF1aXJlXyhuYW1lKTsKICAgIHJldHVybiB0cnVlOwogIH0sCiAgc2V0U3R5bGU6IGFzeW5jIChjb2RlKSA9PiB7CiAgICBzdHlsZS5pbm5lckhUTUwgPSBjb2RlOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBzZXRQbHVnaW5zOiBhc3luYyAocGx1Z2luSWRzKSA9PiB7CiAgICBjb25zdCBwbHVnaW5zID0gZ2VuZXJhdGVQbHVnaW5zKHBsdWdpbklkcyk7CiAgICBtYW5hZ2VyLnNldFBsdWdpbnMocGx1Z2lucyk7CiAgfSwKICBzZXRCb2R5SHRtbDogYXN5bmMgKGh0bWwpID0+IHsKICAgIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gaHRtbDsKICB9Cn0pOwp3aW5kb3cub25lcnJvciA9IChlcnIpID0+IHsKICBjb25zb2xlLmVycm9yKGVycik7Cn07CmlmcmFtZVJlYWR5KCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPWlmcmFtZS5qcy5tYXAK\"","export default \".code-sandbox-iframe {\\n    border-width: 0;\\n    background-color: #ffffff;\\n}\\n\"","import iframeScriptUrl from '@/iframe/iframe?url';\nimport iframeStyles_ from './iframe.css?raw';\n\nexport const getIframeHTML = () => {\n    const srcDoc =\n`<html lang=\"en\">\n    <head>\n        <title>Demo Sandbox</title>\n        <script type=\"module\" src=\"${iframeScriptUrl}\"></script>\n    </head>\n    <body></body>\n</html>`;\n    const src = `data:text/html,${encodeURIComponent(srcDoc)}`;\n    return [srcDoc, src];\n};\n\nexport const iframeStyles: string = iframeStyles_;\n","import { waitIframeReady } from \"../utils/iframe\";\nimport { callProxy, waitProxy } from \"../core/proxy\";\nimport { DemoServiceName, IDemoService } from \"../type\";\n\nexport interface IOptions {\n    iframe: HTMLIFrameElement | null;\n    index?: string;\n    code?: string;\n    html?: string;\n    css?: string;\n    className?: string;\n    style?: string;\n}\n\nexport const getSandboxRefresher = (opt: IOptions) => {\n    const { iframe, code, index, html, css, className, style } = opt;\n\n    /**\n     * 定义并运行一个模块\n     * @param name 模块的名称/路径\n     * @param deps 模块的依赖\n     * @param code 模块的代码\n     */\n    const defineAndRunModule = async (name: string, deps: string[], code: string) => {\n        if (!iframe || !code) return;\n        // 等待 demo iframe 提供的服务准备好\n        await waitIframeReady(iframe);\n        await waitProxy(iframe.contentWindow, DemoServiceName);\n        // 调用 iframe 提供的服务\n        await callProxy<IDemoService, 'defineModule'>({\n            win: iframe.contentWindow,\n            serviceId: DemoServiceName,\n            method: 'defineModule',\n            payload: [name, deps, code]\n        });\n        await callProxy<IDemoService, 'executeModule'>({\n            win: iframe.contentWindow,\n            serviceId: DemoServiceName,\n            method: 'executeModule',\n            payload: [name]\n        });\n    };\n\n    const refreshIndex = async () => {\n        await defineAndRunModule('/index', ['require'], index);\n    }\n\n    const refreshApp = async () => {\n        await defineAndRunModule('/App', ['require'], code);\n        await refreshIndex();\n    }\n\n    const refreshHtml = async () => {\n        // 等待 demo iframe 提供的服务准备好\n        await waitIframeReady(iframe);\n        await waitProxy(iframe.contentWindow, DemoServiceName);\n        await callProxy<IDemoService>({\n            win: iframe.contentWindow,\n            serviceId: DemoServiceName,\n            method: 'setBodyHtml',\n            payload: [html]\n        });\n        await refreshApp();\n    }\n\n    const refreshStyle = async () => {\n        if (!iframe || !css) return;\n        await waitIframeReady(iframe);\n        await waitProxy(iframe.contentWindow, DemoServiceName);\n        await callProxy<IDemoService, 'setStyle'>({\n            win: iframe.contentWindow,\n            serviceId: DemoServiceName,\n            method: 'setStyle',\n            payload: [css]\n        });\n    };\n\n    return { refreshApp, refreshIndex, refreshHtml, refreshStyle };\n};\nexport { getIframeHTML, iframeStyles } from './html';\n\nexport const setSandboxPlugins = async (iframe: HTMLIFrameElement | null, pluginsId: string[]) => {\n    await waitIframeReady(iframe);\n    await waitProxy(iframe.contentWindow, DemoServiceName);\n    return await callProxy<IDemoService>({\n        win: iframe.contentWindow,\n        serviceId: DemoServiceName,\n        method: 'setPlugins',\n        payload: [pluginsId]\n    });\n};\n","export const DefaultDemoCode =\n`// ⚠️require function is asynchronous !\n// const React = await require('react');\nimport React from 'react';\n\nconst App = () => {\n    return (\n        React.createElement(\n            'div',\n            {},\n            React.createElement(\n                'div',\n                {\n                    className: 'title'\n                },\n                'DemoSandbox'\n            ),\n            'welcome to use code sandbox'\n        )\n    );\n};\n\nmodule.exports = App`;\n\nexport const DefaultIndexCode =\n`const React = await require('react');\nconst ReactDom = await require('react-dom');\nconst App = await require('./App');\n\nReactDom.render(React.createElement(App, {}), document.getElementById('root'));`;\n\nexport const DefaultHtml =\n`<noscript>Need javascript to run this demo page.</noscript>\n<div id=\"root\">\n    <h3> 🚀 Welcome to use code sandbox. </h3>\n</div>`;\n\nexport const DefaultCssCode =\n`.title { color: blue }`;\n","import { registerProxy } from '../core/proxy';\nimport { BasePlugin, IPlugin } from './types';\n\nlet pluginsId: string[] = [];\n\n/**\n * 默认的兜底插件\n */\nexport class DefaultPlugin extends BasePlugin {\n    constructor() {\n        super();\n        this.pluginId = 'default-plugin';\n    }\n\n    async resolveModuleUrl(meta) {\n        const { packageName, version, file } = meta;\n        const versionSuffix = version ? `@${version}` : '';\n        const fileSuffix = file ? `${file}` : '';\n        // `return false` to cancel auto require deps.\n        return `https://unpkg.com/${packageName}${versionSuffix}${fileSuffix}`;\n    }\n\n    async beforeModuleGenerate(ctx, meta) {\n        // 把代码段包装为函数\n        meta.factory = `async (require, exports, module) => {\\n${meta.factory}\\n}`;\n        meta.deps = ['require', 'exports', 'module'];\n        return meta;\n    }\n}\n\nexport const registerPlugins = (_plugins: IPlugin[]) => {\n    const plugins = _plugins.concat(new DefaultPlugin());\n    plugins.forEach(plugin => {\n        registerProxy(plugin.pluginId, plugin);\n    });\n    pluginsId = plugins.map(plugin => plugin.pluginId);\n    return pluginsId;\n};\n\nexport const getPlugins = () => {\n    return pluginsId;\n}\n"],"names":["code","pluginsId"],"mappings":"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"}
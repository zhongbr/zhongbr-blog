{"version":3,"file":"webcomponent.js","sources":["../src/webcomponent.tsx"],"sourcesContent":["import { getIframeHTML, iframeStyles, getSandboxRefresher, setSandboxPlugins } from './iframe';\nimport * as DefaultCodes from './default';\nimport { IProps as IDemoProps } from \"./index\";\nimport { onIframeLoadingModule, initMainThreadService } from './utils/iframe';\nimport { getPlugins, registerPlugins } from './plugins';\n\ninitMainThreadService();\n\ndeclare global {\n    namespace JSX {\n        interface IntrinsicElements {\n            'code-sandbox': IDemoProps;\n        }\n    }\n}\n\nclass CodeSandbox extends HTMLElement {\n    private iframe: HTMLIFrameElement;\n    private styleElement: HTMLStyleElement;\n\n    public onLoadingModule: (moduleName: string, url: string) => void;\n\n    constructor() {\n        super();\n        this.initIframe();\n\n        const shadowRoot = this.attachShadow({ mode: 'open' });\n        shadowRoot.append(this.styleElement, this.iframe);\n        // 设置插件\n        setSandboxPlugins(this.iframe, getPlugins());\n    }\n\n    private initIframe() {\n        const [srcDoc] = getIframeHTML();\n\n        this.iframe = document.createElement('iframe');\n        this.iframe.srcdoc = srcDoc;\n        this.iframe.setAttribute('sandbox', 'allow-scripts');\n        this.iframe.setAttribute('class', `code-sandbox-iframe ${this.getAttribute('class') || ''}`);\n        this.iframe.setAttribute('style', this.getAttribute('style'));\n\n        // 监听 iframe 内加载模块，并分发对象的事件\n        onIframeLoadingModule(this.iframe, (moduleName, extraInfo) => {\n            this.onLoadingModule?.(moduleName, extraInfo);\n            this.dispatchEvent(new CustomEvent('loading-module', {\n                detail: {\n                    moduleName,\n                    url: extraInfo\n                }\n            }));\n        });\n\n        this.styleElement = document.createElement('style');\n        this.styleElement.innerText = iframeStyles;\n    }\n\n    static get observedAttributes() {\n        return ['code', 'css', 'index', 'html', 'class', 'style'];\n    }\n\n    public async attributeChangedCallback(name: string, oldValue, newValue) {\n        const html = this.getAttribute('html') || DefaultCodes.DefaultHtml;\n        const index = this.getAttribute('index') || DefaultCodes.DefaultIndexCode;\n        const code = this.getAttribute('code') || DefaultCodes.DefaultDemoCode;\n        const css = this.getAttribute('css') || DefaultCodes.DefaultCssCode;\n\n        const { refreshHtml, refreshApp, refreshIndex, refreshStyle } = getSandboxRefresher({\n            iframe: this.iframe,\n            html,\n            index,\n            code,\n            css\n        });\n        const tasks = [];\n        switch (name) {\n            case 'html': {\n                tasks.push(refreshHtml())\n                break;\n            }\n            case 'code': {\n                tasks.push(refreshApp());\n                break;\n            }\n            case 'index': {\n                tasks.push(refreshIndex());\n                break;\n            }\n            case 'css': {\n                tasks.push(refreshStyle());\n                break;\n            }\n            default: {\n                this.iframe.setAttribute(name, newValue);\n            }\n        }\n        const res = Promise.all(tasks);\n        this.dispatchEvent(new CustomEvent('ready'));\n        return res;\n    }\n}\n\nexport { DefaultCodes, CodeSandbox, registerPlugins };\n"],"names":["DefaultCodes.DefaultHtml","DefaultCodes.DefaultIndexCode","DefaultCodes.DefaultDemoCode","DefaultCodes.DefaultCssCode"],"mappings":";;;;;AAMA;AAUA,MAAM,oBAAoB,YAAY;AAAA,EAMlC,cAAc;AACJ;AACN,SAAK,WAAW;AAEhB,UAAM,aAAa,KAAK,aAAa,EAAE,MAAM,QAAQ;AACrD,eAAW,OAAO,KAAK,cAAc,KAAK,MAAM;AAE9B,sBAAA,KAAK,QAAQ,WAAY,CAAA;AAAA,EAC/C;AAAA,EAEQ,aAAa;AACX,UAAA,CAAC,MAAM,IAAI;AAEZ,SAAA,SAAS,SAAS,cAAc,QAAQ;AAC7C,SAAK,OAAO,SAAS;AAChB,SAAA,OAAO,aAAa,WAAW,eAAe;AAC9C,SAAA,OAAO,aAAa,SAAS,uBAAuB,KAAK,aAAa,OAAO,KAAK,IAAI;AAC3F,SAAK,OAAO,aAAa,SAAS,KAAK,aAAa,OAAO,CAAC;AAG5D,0BAAsB,KAAK,QAAQ,CAAC,YAAY,cAAc;;AACrD,iBAAA,oBAAA,8BAAkB,YAAY;AAC9B,WAAA,cAAc,IAAI,YAAY,kBAAkB;AAAA,QACjD,QAAQ;AAAA,UACJ;AAAA,UACA,KAAK;AAAA,QACT;AAAA,MACH,CAAA,CAAC;AAAA,IAAA,CACL;AAEI,SAAA,eAAe,SAAS,cAAc,OAAO;AAClD,SAAK,aAAa,YAAY;AAAA,EAClC;AAAA,EAEA,WAAW,qBAAqB;AAC5B,WAAO,CAAC,QAAQ,OAAO,SAAS,QAAQ,SAAS,OAAO;AAAA,EAC5D;AAAA,EAEA,MAAa,yBAAyB,MAAc,UAAU,UAAU;AACpE,UAAM,OAAO,KAAK,aAAa,MAAM,KAAKA;AAC1C,UAAM,QAAQ,KAAK,aAAa,OAAO,KAAKC;AAC5C,UAAM,OAAO,KAAK,aAAa,MAAM,KAAKC;AAC1C,UAAM,MAAM,KAAK,aAAa,KAAK,KAAKC;AAExC,UAAM,EAAE,aAAa,YAAY,cAAc,aAAA,IAAiB,oBAAoB;AAAA,MAChF,QAAQ,KAAK;AAAA,MACb;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA,CACH;AACD,UAAM,QAAQ,CAAA;AACd,YAAQ,MAAM;AAAA,MACV,KAAK,QAAQ;AACH,cAAA,KAAK,aAAa;AACxB;AAAA,MACJ;AAAA,MACA,KAAK,QAAQ;AACH,cAAA,KAAK,YAAY;AACvB;AAAA,MACJ;AAAA,MACA,KAAK,SAAS;AACJ,cAAA,KAAK,cAAc;AACzB;AAAA,MACJ;AAAA,MACA,KAAK,OAAO;AACF,cAAA,KAAK,cAAc;AACzB;AAAA,MACJ;AAAA,MACA,SAAS;AACA,aAAA,OAAO,aAAa,MAAM,QAAQ;AAAA,MAC3C;AAAA,IACJ;AACM,UAAA,MAAM,QAAQ,IAAI,KAAK;AAC7B,SAAK,cAAc,IAAI,YAAY,OAAO,CAAC;AACpC,WAAA;AAAA,EACX;AACJ;"}
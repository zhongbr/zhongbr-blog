import { createEventSubscribeManager } from "./core/event/index.js";
import { registerProxy, callProxy, waitProxy } from "./core/proxy/index.js";
import { B as BasePlugin } from "./types-9fd137f3.js";
import { p as pathBrowserify } from "./index-a3b3cc38.js";
const NOTIFICATION_SERVICE = "iframe-notification-service";
const emitter = createEventSubscribeManager();
const initMainThreadService = () => {
  const service = {
    iframeReady: async (e) => {
      emitter.trigger("iframeReady", e);
      return true;
    },
    iframeLoadingModule: async (moduleName, moduleUrl, e) => {
      emitter.trigger("iframeLoadingModule", moduleName, moduleUrl, e);
    }
  };
  return registerProxy(NOTIFICATION_SERVICE, service);
};
const waitIframeReady = async (iframe, timeout = 1e4) => {
  const listenTask = new Promise((resolve, reject) => {
    if (iframe.getAttribute("data-iframe-status") !== "ready") {
      emitter.once(
        "iframeReady",
        (...args) => {
          iframe.setAttribute("data-iframe-status", "ready");
          resolve(null);
        },
        (e) => e.source === iframe.contentWindow,
        reject,
        timeout
      );
    } else {
      resolve(null);
    }
  });
  const queryTask = async () => {
    await new Promise((resolve) => {
      const onload = () => {
        iframe.setAttribute("data-iframe-status", "loaded");
        resolve(null);
        iframe.removeEventListener("load", onload);
      };
      iframe.addEventListener("load", onload);
    });
    await callProxy({
      win: iframe.contentWindow,
      serviceId: NOTIFICATION_SERVICE,
      method: "iframeReady",
      payload: [],
      timeout
    });
  };
  return Promise.race([listenTask, queryTask()]);
};
const onIframeLoadingModule = (iframe, cb) => {
  emitter.listen("iframeLoadingModule", cb, (moduleName, extraInfo, e) => e.source === iframe.contentWindow);
};
const DemoServiceName = "demo-service";
const iframeScriptUrl = "data:application/javascript;base64,Y29uc3QgZGVidWdPbmx5TGV2ZWwgPSBbImxvZyIsICJkZWJ1ZyJdOwpjb25zdCBsb2dnZXIgPSBkZWJ1Z09ubHlMZXZlbC5yZWR1Y2UoKHByZSwga2V5KSA9PiB7CiAgcmV0dXJuIE9iamVjdC5hc3NpZ24ocHJlLCB7CiAgICBba2V5XTogKC4uLmFyZ3MpID0+IHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfSk7Cn0sIHt9KTsKbGV0IE1lc3NhZ2VJRCA9IDA7CmNvbnN0IGdldE1lc3NhZ2VJZCA9ICgpID0+IE1lc3NhZ2VJRCsrOwpjb25zdCBzZXJ2aWNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CmNvbnN0IHdhaXRTZXJ2aWNlQ2FsbGJhY2tzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKc2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKGUpID0+IHsKICBjb25zdCBtZXNzYWdlID0gZS5kYXRhOwogIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgUmVmbGVjdC5nZXQobWVzc2FnZSwgIl9fcHJveHlfaW50ZXJuYWwiKSAhPT0gIndhaXQiKSB7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IHNlcnZpY2VJZCA9IG1lc3NhZ2UucmVjZWl2ZXI7CiAgY29uc3QgdGltZW91dF8gPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgIGNvbnN0IGNhbGxiYWNrczIgPSAod2FpdFNlcnZpY2VDYWxsYmFja3MuZ2V0KHNlcnZpY2VJZCkgfHwgW10pLmZpbHRlcigoYykgPT4gYyAhPT0gY2FsbGJhY2spOwogICAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzMik7CiAgICAoZS5zb3VyY2UgfHwgc2VsZikucG9zdE1lc3NhZ2UoewogICAgICBfX3Byb3h5X2ludGVybmFsOiAid2FpdC1yZXBseSIsCiAgICAgIGVycm9yOiB0cnVlLAogICAgICBpZDogbWVzc2FnZS5pZCwKICAgICAgcGF5bG9hZDogW2BbcHJveHldd2FpdCBmb3Igc2VydmljZSAke3NlcnZpY2VJZH0gdGltZW91dC5gXQogICAgfSwgewogICAgICB0YXJnZXRPcmlnaW46ICIqIgogICAgfSk7CiAgfSwgbWVzc2FnZS50aW1lb3V0KTsKICBjb25zdCBjYWxsYmFjayA9ICgpID0+IHsKICAgIGNsZWFyVGltZW91dCh0aW1lb3V0Xyk7CiAgICAoZS5zb3VyY2UgfHwgc2VsZikucG9zdE1lc3NhZ2UoewogICAgICBfX3Byb3h5X2ludGVybmFsOiAid2FpdC1yZXBseSIsCiAgICAgIGlkOiBtZXNzYWdlLmlkLAogICAgICBlcnJvcjogZmFsc2UsCiAgICAgIHBheWxvYWQ6IFtdCiAgICB9LCB7CiAgICAgIHRhcmdldE9yaWdpbjogIioiCiAgICB9KTsKICAgIGNvbnN0IGNhbGxiYWNrczIgPSAod2FpdFNlcnZpY2VDYWxsYmFja3MuZ2V0KHNlcnZpY2VJZCkgfHwgW10pLmZpbHRlcigoYykgPT4gYyAhPT0gY2FsbGJhY2spOwogICAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzMik7CiAgfTsKICBjb25zdCBjYWxsYmFja3MgPSB3YWl0U2VydmljZUNhbGxiYWNrcy5nZXQoc2VydmljZUlkKSB8fCBbXTsKICBjYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzKTsKICBpZiAoc2VydmljZXMuaGFzKHNlcnZpY2VJZCkpIHsKICAgIGNhbGxiYWNrKCk7CiAgfQp9KTsKZnVuY3Rpb24gcmVnaXN0ZXJQcm94eShzZXJ2aWNlSWQsIG9iaikgewogIGNvbnN0IGNhbGxiYWNrcyA9IHdhaXRTZXJ2aWNlQ2FsbGJhY2tzLmdldChzZXJ2aWNlSWQpOwogIGlmIChjYWxsYmFja3MpCiAgICBjYWxsYmFja3MuZm9yRWFjaCgoY2FsbGJhY2spID0+IGNhbGxiYWNrKCkpOwogIGNvbnN0IHNlcnZpY2VIYW5kbGVyID0gYXN5bmMgKGUpID0+IHsKICAgIHZhciBfYTsKICAgIGNvbnN0IG1lc3NhZ2UgPSBlLmRhdGE7CiAgICBpZiAodHlwZW9mIG1lc3NhZ2UgIT09ICJvYmplY3QiIHx8IFJlZmxlY3QuZ2V0KG1lc3NhZ2UsICJfX3Byb3h5X2ludGVybmFsIikgIT09ICJjYWxsIikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAobWVzc2FnZS5yZWNlaXZlciA9PT0gc2VydmljZUlkKSB7CiAgICAgIGNvbnN0IG1ldGhvZCA9IFJlZmxlY3QuZ2V0KG9iaiwgbWVzc2FnZS5tZXRob2QpOwogICAgICBpZiAoIW1ldGhvZCkgewogICAgICAgIChlLnNvdXJjZSB8fCBzZWxmKS5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBfX3Byb3h5X2ludGVybmFsOiAicmVwbHkiLAogICAgICAgICAgaWQ6IG1lc3NhZ2UuaWQsCiAgICAgICAgICBlcnJvcjogdHJ1ZSwKICAgICAgICAgIHBheWxvYWQ6IFtgW3Byb3h5XSBtZXRob2QgXGAke21lc3NhZ2UubWV0aG9kfVxgIGRvZXMgbm90IGV4aXN0IG9uIHJlbW90ZSBvYmplY3QgJHttZXNzYWdlLnJlY2VpdmVyfSBvciBpdCBpcyBub3QgYSBmdW5jdGlvbi5gXQogICAgICAgIH0sIHsKICAgICAgICAgIHRhcmdldE9yaWdpbjogIioiCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgbGV0IHJlcyA9IG1ldGhvZDsKICAgICAgaWYgKHR5cGVvZiBtZXRob2QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXMgPSBhd2FpdCBtZXRob2QuY2FsbChvYmosIC4uLm1lc3NhZ2UucGF5bG9hZCwgZSk7CiAgICAgIH0KICAgICAgbG9nZ2VyLmRlYnVnKCJbcHJveHldIHJlcGx5IiwgKChfYSA9IHNlbGYgPT0gbnVsbCA/IHZvaWQgMCA6IHNlbGYubG9jYXRpb24pID09IG51bGwgPyB2b2lkIDAgOiBfYS5ocmVmKSB8fCAid29ya2VyIiwgZS5zb3VyY2UsIG1lc3NhZ2UucmVjZWl2ZXIsIG1lc3NhZ2UubWV0aG9kLCBlLnNvdXJjZSB8fCBzZWxmKTsKICAgICAgKGUuc291cmNlIHx8IHNlbGYpLnBvc3RNZXNzYWdlKHsKICAgICAgICBfX3Byb3h5X2ludGVybmFsOiAicmVwbHkiLAogICAgICAgIGlkOiBtZXNzYWdlLmlkLAogICAgICAgIGVycm9yOiBmYWxzZSwKICAgICAgICBwYXlsb2FkOiBbcmVzXQogICAgICB9LCB7CiAgICAgICAgdGFyZ2V0T3JpZ2luOiAiKiIKICAgICAgfSk7CiAgICB9CiAgfTsKICBzZWxmLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBzZXJ2aWNlSGFuZGxlcik7CiAgcmV0dXJuICgpID0+IHsKICAgIHNlbGYucmVtb3ZlRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIHNlcnZpY2VIYW5kbGVyKTsKICB9Owp9CmFzeW5jIGZ1bmN0aW9uIHdhaXRQcm94eSh3aW4sIHNlcnZpY2VJZCwgdGltZW91dCA9IDFlNCkgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTMsIHJlamVjdCkgPT4gewogICAgY29uc3QgbWVzc2FnZUlkID0gZ2V0TWVzc2FnZUlkKCk7CiAgICBjb25zdCB0aW1lb3V0XyA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICBzZWxmLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICAgIHJlamVjdChgW3Byb3h5XSB3YWl0IGZvciAke3NlcnZpY2VJZH0gdGltZW91dCAuYCk7CiAgICB9LCB0aW1lb3V0KTsKICAgIGNvbnN0IGNhbGxiYWNrID0gKGUpID0+IHsKICAgICAgaWYgKChlLnNvdXJjZSB8fCBzZWxmKSAhPT0gd2luKQogICAgICAgIHJldHVybjsKICAgICAgY29uc3QgbWVzc2FnZSA9IGUuZGF0YTsKICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBSZWZsZWN0LmdldChtZXNzYWdlLCAiX19wcm94eV9pbnRlcm5hbCIpICE9PSAid2FpdC1yZXBseSIgfHwgbWVzc2FnZS5pZCAhPT0gbWVzc2FnZUlkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHJlc29sdmUzKG51bGwpOwogICAgICBjbGVhclRpbWVvdXQodGltZW91dF8pOwogICAgICBzZWxmLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICB9OwogICAgc2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgY2FsbGJhY2spOwogICAgd2luLnBvc3RNZXNzYWdlKHsKICAgICAgX19wcm94eV9pbnRlcm5hbDogIndhaXQiLAogICAgICByZWNlaXZlcjogc2VydmljZUlkLAogICAgICBwYXlsb2FkOiBbXSwKICAgICAgZXJyb3I6IGZhbHNlLAogICAgICBpZDogbWVzc2FnZUlkCiAgICB9LCB7CiAgICAgIHRhcmdldE9yaWdpbjogIioiCiAgICB9KTsKICB9KTsKfQphc3luYyBmdW5jdGlvbiBjYWxsUHJveHkoeyB3aW4sIHNlcnZpY2VJZCwgbWV0aG9kLCBwYXlsb2FkLCB0aW1lb3V0ID0gMWU0IH0pIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUzLCByZWplY3QpID0+IHsKICAgIHZhciBfYTsKICAgIGNvbnN0IG1lc3NhZ2VJZCA9IGdldE1lc3NhZ2VJZCgpOwogICAgbGV0IGhhbmRsZXIgPSBzZWxmOwogICAgaWYgKHdpbiBpbnN0YW5jZW9mIFdvcmtlcikgewogICAgICBoYW5kbGVyID0gd2luOwogICAgfQogICAgbGV0IHRpbWVvdXRfID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHJlamVjdChgY2FsbCByZW1vdGUgb2JqZWN0ICR7c2VydmljZUlkfSBtZXRob2QgJHttZXRob2QudG9TdHJpbmcoKX0gdGltZW91dGApOwogICAgICBoYW5kbGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICB9LCB0aW1lb3V0KTsKICAgIGNvbnN0IGNhbGxiYWNrID0gKGUpID0+IHsKICAgICAgdmFyIF9hMjsKICAgICAgaWYgKCEod2luIGluc3RhbmNlb2YgV29ya2VyKSAmJiAoZS5zb3VyY2UgfHwgc2VsZikgIT09IHdpbikKICAgICAgICByZXR1cm47CiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlLmRhdGE7CiAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgUmVmbGVjdC5nZXQobWVzc2FnZSwgIl9fcHJveHlfaW50ZXJuYWwiKSAhPT0gInJlcGx5IiB8fCBtZXNzYWdlLmlkICE9PSBtZXNzYWdlSWQpCiAgICAgICAgcmV0dXJuOwogICAgICBoYW5kbGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0Xyk7CiAgICAgIGxvZ2dlci5kZWJ1ZygiW3Byb3h5XSByZWNlaXZlIHJlcGx5IiwgKChfYTIgPSBzZWxmID09IG51bGwgPyB2b2lkIDAgOiBzZWxmLmxvY2F0aW9uKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmhyZWYpIHx8ICJ3b3JrZXIiLCBtZXNzYWdlLmlkKTsKICAgICAgaWYgKG1lc3NhZ2UuZXJyb3IpIHsKICAgICAgICByZWplY3QobWVzc2FnZS5wYXlsb2FkWzBdKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmVzb2x2ZTMobWVzc2FnZS5wYXlsb2FkWzBdKTsKICAgIH07CiAgICBoYW5kbGVyLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICBsb2dnZXIuZGVidWcoIltwcm94eV0gY2FsbCIsICgoX2EgPSBzZWxmID09IG51bGwgPyB2b2lkIDAgOiBzZWxmLmxvY2F0aW9uKSA9PSBudWxsID8gdm9pZCAwIDogX2EuaHJlZikgfHwgIndvcmtlciIsIHNlcnZpY2VJZCwgbWV0aG9kKTsKICAgIHdpbi5wb3N0TWVzc2FnZSh7CiAgICAgIGlkOiBtZXNzYWdlSWQsCiAgICAgIF9fcHJveHlfaW50ZXJuYWw6ICJjYWxsIiwKICAgICAgcmVjZWl2ZXI6IHNlcnZpY2VJZCwKICAgICAgbWV0aG9kLAogICAgICBwYXlsb2FkLAogICAgICBlcnJvcjogZmFsc2UKICAgIH0sIHsKICAgICAgdGFyZ2V0T3JpZ2luOiAiKiIKICAgIH0pOwogIH0pOwp9CmZ1bmN0aW9uIGJpbmRTY3JpcHRMb2FkZXJUb0N0eChjdHgyKSB7CiAgbGV0IGxvYWRpbmdNb2R1bGVOYW1lID0gIiI7CiAgY29uc3Qgc2NyaXB0TG9hZGluZ1Rhc2tzID0gW107CiAgY29uc3QgbG9hZFNjcmlwdCA9IGFzeW5jIChkb20sIHVybCwgbW9kdWxlTmFtZTIgPSAiZ2xvYmFsT2JqIikgPT4gewogICAgaWYgKGxvYWRpbmdNb2R1bGVOYW1lKSB7CiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlMykgPT4gewogICAgICAgIHJlc29sdmUzLm1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lMjsKICAgICAgICBzY3JpcHRMb2FkaW5nVGFza3MucHVzaChyZXNvbHZlMyk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlMywgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIGN0eDIubG9nZ2VyLmxvZygiW2FtZF0gc2NyaXB0IGxvYWQgdGltZW91dCAiICsgbW9kdWxlTmFtZTIpOwogICAgICAgIHJlamVjdChuZXcgRXJyb3IoYGxvYWQgbW9kdWxlICR7bW9kdWxlTmFtZTJ9IHRpbWVvdXRgKSk7CiAgICAgICAgKF9hID0gc2NyaXB0TG9hZGluZ1Rhc2tzLnNoaWZ0KCkpID09IG51bGwgPyB2b2lkIDAgOiBfYSgpOwogICAgICB9LCBjdHgyLnNjcmlwdFRpbWVvdXQpOwogICAgICBzY3JpcHQub25sb2FkID0gKCkgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICBjdHgyLmxvZ2dlci5sb2coIlthbWRdIHNjcmlwdCByZXNvbHZlZCIsIGxvYWRpbmdNb2R1bGVOYW1lKTsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgcmVzb2x2ZTMobnVsbCk7CiAgICAgICAgbG9hZGluZ01vZHVsZU5hbWUgPSAiIjsKICAgICAgICAoX2EgPSBzY3JpcHRMb2FkaW5nVGFza3Muc2hpZnQoKSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hKCk7CiAgICAgIH07CiAgICAgIHNjcmlwdC5vbmVycm9yID0gKGVycikgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICBjdHgyLmxvZ2dlci5sb2coIlthbWRdIHNjcmlwdCByZWplY3RlZCIsIGxvYWRpbmdNb2R1bGVOYW1lKTsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgbG9hZGluZ01vZHVsZU5hbWUgPSAiIjsKICAgICAgICAoX2EgPSBzY3JpcHRMb2FkaW5nVGFza3Muc2hpZnQoKSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hKCk7CiAgICAgIH07CiAgICAgIHNjcmlwdC5jcm9zc09yaWdpbiA9ICJhbm9ueW1vdXMiOwogICAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgICBzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwogICAgICBjdHgyLmxvZ2dlci5sb2coIlthbWRdIHN0YXJ0IGxvYWQgc2NyaXB0IiwgbW9kdWxlTmFtZTIpOwogICAgICBsb2FkaW5nTW9kdWxlTmFtZSA9IG1vZHVsZU5hbWUyOwogICAgICBkb20uYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgIH0pOwogIH07CiAgY3R4Mi5zY3JpcHRMb2FkZXIgPSB7CiAgICBnZXRMb2FkaW5nTW9kdWxlTmFtZTogKCkgPT4gbG9hZGluZ01vZHVsZU5hbWUsCiAgICBsb2FkU2NyaXB0LAogICAgc2NyaXB0TG9hZGluZ1Rhc2tzCiAgfTsKfQp2YXIgSUV2ZW50VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gKChJRXZlbnRUeXBlczIpID0+IHsKICBJRXZlbnRUeXBlczJbIk1vZHVsZVVwZGF0ZSJdID0gIm1vZHVsZS11cGRhdGUiOwogIElFdmVudFR5cGVzMlsiTG9hZGluZ1NjcmlwdCJdID0gImxvYWRpbmctc2NyaXB0IjsKICBJRXZlbnRUeXBlczJbIk1vZHVsZURlcHMiXSA9ICJtb2R1bGUtZGVwcyI7CiAgcmV0dXJuIElFdmVudFR5cGVzMjsKfSkoSUV2ZW50VHlwZXMgfHwge30pOwpmdW5jdGlvbiBiaW5kRGVmaW5lVG9DdHgoY3R4MikgewogIGZ1bmN0aW9uIGRlZmluZShtb2R1bGVOYW1lMiwgZGVwZW5kZW5jaWVzXywgZmFjdG9yeTIpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlTmFtZTIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZmFjdG9yeTIgPSBtb2R1bGVOYW1lMjsKICAgICAgZGVwZW5kZW5jaWVzXyA9IFsicmVxdWlyZSIsICJleHBvcnRzIiwgIm1vZHVsZSJdOwogICAgICBtb2R1bGVOYW1lMiA9IGN0eDIuc2NyaXB0TG9hZGVyLmdldExvYWRpbmdNb2R1bGVOYW1lKCk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheShtb2R1bGVOYW1lMikpIHsKICAgICAgZmFjdG9yeTIgPSBkZXBlbmRlbmNpZXNfOwogICAgICBkZXBlbmRlbmNpZXNfID0gbW9kdWxlTmFtZTI7CiAgICAgIG1vZHVsZU5hbWUyID0gY3R4Mi5zY3JpcHRMb2FkZXIuZ2V0TG9hZGluZ01vZHVsZU5hbWUoKTsKICAgIH0KICAgIGN0eDIubG9nZ2VyLmxvZygiW2FtZF0gZGVmaW5lIG1vZHVsZSIsIG1vZHVsZU5hbWUyLCBkZXBlbmRlbmNpZXNfKTsKICAgIGNvbnN0IG1vZHVsZVBhdGgyID0gY3R4Mi5yZXF1aXJlLnJlc29sdmUobW9kdWxlTmFtZTIpOwogICAgY29uc3QgeyBmYWN0b3JpZXM6IGZhY3RvcmllczIsIGNhY2hlOiBjYWNoZTIsIGRlcGVuZGVuY2llczogZGVwZW5kZW5jaWVzMiB9ID0gY3R4Mi5yZXF1aXJlOwogICAgaWYgKGZhY3RvcmllczIuaGFzKG1vZHVsZVBhdGgyKSkgewogICAgICBmYWN0b3JpZXMyLmRlbGV0ZShtb2R1bGVQYXRoMik7CiAgICB9CiAgICBpZiAoY2FjaGUyLmhhcyhtb2R1bGVQYXRoMikpIHsKICAgICAgY2FjaGUyLmRlbGV0ZShtb2R1bGVQYXRoMik7CiAgICB9CiAgICBpZiAoZGVwZW5kZW5jaWVzMi5oYXMobW9kdWxlUGF0aDIpKSB7CiAgICAgIGRlcGVuZGVuY2llczIuZGVsZXRlKG1vZHVsZVBhdGgyKTsKICAgIH0KICAgIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLnRyaWdnZXIoSUV2ZW50VHlwZXMuTW9kdWxlVXBkYXRlLCBtb2R1bGVQYXRoMik7CiAgICBmYWN0b3JpZXMyLnNldChtb2R1bGVQYXRoMiwgZmFjdG9yeTIpOwogICAgZGVwZW5kZW5jaWVzMi5zZXQobW9kdWxlUGF0aDIsIGRlcGVuZGVuY2llc18pOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgY3R4Mi5sb2dnZXIubG9nKCJbYW1kXSBtb2R1bGUgZGlzcG9zZSIsIG1vZHVsZU5hbWUyKTsKICAgICAgZmFjdG9yaWVzMi5kZWxldGUobW9kdWxlUGF0aDIpOwogICAgfTsKICB9CiAgY3R4Mi5kZWZpbmUgPSBPYmplY3QuYXNzaWduKGRlZmluZSwgewogICAgYW1kOiB7fQogIH0pOwp9CmZ1bmN0aW9uIGFzc2VydFBhdGgocGF0aCkgewogIGlmICh0eXBlb2YgcGF0aCAhPT0gInN0cmluZyIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlBhdGggbXVzdCBiZSBhIHN0cmluZy4gUmVjZWl2ZWQgIiArIEpTT04uc3RyaW5naWZ5KHBhdGgpKTsKICB9Cn0KZnVuY3Rpb24gbm9ybWFsaXplU3RyaW5nUG9zaXgocGF0aCwgYWxsb3dBYm92ZVJvb3QpIHsKICB2YXIgcmVzID0gIiI7CiAgdmFyIGxhc3RTZWdtZW50TGVuZ3RoID0gMDsKICB2YXIgbGFzdFNsYXNoID0gLTE7CiAgdmFyIGRvdHMgPSAwOwogIHZhciBjb2RlOwogIGZvciAodmFyIGkgPSAwOyBpIDw9IHBhdGgubGVuZ3RoOyArK2kpIHsKICAgIGlmIChpIDwgcGF0aC5sZW5ndGgpCiAgICAgIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSk7CiAgICBlbHNlIGlmIChjb2RlID09PSA0NykKICAgICAgYnJlYWs7CiAgICBlbHNlCiAgICAgIGNvZGUgPSA0NzsKICAgIGlmIChjb2RlID09PSA0NykgewogICAgICBpZiAobGFzdFNsYXNoID09PSBpIC0gMSB8fCBkb3RzID09PSAxKQogICAgICAgIDsKICAgICAgZWxzZSBpZiAobGFzdFNsYXNoICE9PSBpIC0gMSAmJiBkb3RzID09PSAyKSB7CiAgICAgICAgaWYgKHJlcy5sZW5ndGggPCAyIHx8IGxhc3RTZWdtZW50TGVuZ3RoICE9PSAyIHx8IHJlcy5jaGFyQ29kZUF0KHJlcy5sZW5ndGggLSAxKSAhPT0gNDYgfHwgcmVzLmNoYXJDb2RlQXQocmVzLmxlbmd0aCAtIDIpICE9PSA0NikgewogICAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgIHZhciBsYXN0U2xhc2hJbmRleCA9IHJlcy5sYXN0SW5kZXhPZigiLyIpOwogICAgICAgICAgICBpZiAobGFzdFNsYXNoSW5kZXggIT09IHJlcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgaWYgKGxhc3RTbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgcmVzID0gIiI7CiAgICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDA7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlcyA9IHJlcy5zbGljZSgwLCBsYXN0U2xhc2hJbmRleCk7CiAgICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IHJlcy5sZW5ndGggLSAxIC0gcmVzLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgICAgICAgICAgZG90cyA9IDA7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAocmVzLmxlbmd0aCA9PT0gMiB8fCByZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHJlcyA9ICIiOwogICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDA7CiAgICAgICAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgICAgICAgIGRvdHMgPSAwOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGFsbG93QWJvdmVSb290KSB7CiAgICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDApCiAgICAgICAgICAgIHJlcyArPSAiLy4uIjsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgcmVzID0gIi4uIjsKICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAwKQogICAgICAgICAgcmVzICs9ICIvIiArIHBhdGguc2xpY2UobGFzdFNsYXNoICsgMSwgaSk7CiAgICAgICAgZWxzZQogICAgICAgICAgcmVzID0gcGF0aC5zbGljZShsYXN0U2xhc2ggKyAxLCBpKTsKICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IGkgLSBsYXN0U2xhc2ggLSAxOwogICAgICB9CiAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgIGRvdHMgPSAwOwogICAgfSBlbHNlIGlmIChjb2RlID09PSA0NiAmJiBkb3RzICE9PSAtMSkgewogICAgICArK2RvdHM7CiAgICB9IGVsc2UgewogICAgICBkb3RzID0gLTE7CiAgICB9CiAgfQogIHJldHVybiByZXM7Cn0KZnVuY3Rpb24gX2Zvcm1hdChzZXAsIHBhdGhPYmplY3QpIHsKICB2YXIgZGlyID0gcGF0aE9iamVjdC5kaXIgfHwgcGF0aE9iamVjdC5yb290OwogIHZhciBiYXNlID0gcGF0aE9iamVjdC5iYXNlIHx8IChwYXRoT2JqZWN0Lm5hbWUgfHwgIiIpICsgKHBhdGhPYmplY3QuZXh0IHx8ICIiKTsKICBpZiAoIWRpcikgewogICAgcmV0dXJuIGJhc2U7CiAgfQogIGlmIChkaXIgPT09IHBhdGhPYmplY3Qucm9vdCkgewogICAgcmV0dXJuIGRpciArIGJhc2U7CiAgfQogIHJldHVybiBkaXIgKyBzZXAgKyBiYXNlOwp9CnZhciBwb3NpeCA9IHsKICAvLyBwYXRoLnJlc29sdmUoW2Zyb20gLi4uXSwgdG8pCiAgcmVzb2x2ZTogZnVuY3Rpb24gcmVzb2x2ZTIoKSB7CiAgICB2YXIgcmVzb2x2ZWRQYXRoID0gIiI7CiAgICB2YXIgcmVzb2x2ZWRBYnNvbHV0ZSA9IGZhbHNlOwogICAgdmFyIGN3ZDsKICAgIGZvciAodmFyIGkgPSBhcmd1bWVudHMubGVuZ3RoIC0gMTsgaSA+PSAtMSAmJiAhcmVzb2x2ZWRBYnNvbHV0ZTsgaS0tKSB7CiAgICAgIHZhciBwYXRoOwogICAgICBpZiAoaSA+PSAwKQogICAgICAgIHBhdGggPSBhcmd1bWVudHNbaV07CiAgICAgIGVsc2UgewogICAgICAgIGlmIChjd2QgPT09IHZvaWQgMCkKICAgICAgICAgIGN3ZCA9IHByb2Nlc3MuY3dkKCk7CiAgICAgICAgcGF0aCA9IGN3ZDsKICAgICAgfQogICAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICByZXNvbHZlZFBhdGggPSBwYXRoICsgIi8iICsgcmVzb2x2ZWRQYXRoOwogICAgICByZXNvbHZlZEFic29sdXRlID0gcGF0aC5jaGFyQ29kZUF0KDApID09PSA0NzsKICAgIH0KICAgIHJlc29sdmVkUGF0aCA9IG5vcm1hbGl6ZVN0cmluZ1Bvc2l4KHJlc29sdmVkUGF0aCwgIXJlc29sdmVkQWJzb2x1dGUpOwogICAgaWYgKHJlc29sdmVkQWJzb2x1dGUpIHsKICAgICAgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPiAwKQogICAgICAgIHJldHVybiAiLyIgKyByZXNvbHZlZFBhdGg7CiAgICAgIGVsc2UKICAgICAgICByZXR1cm4gIi8iOwogICAgfSBlbHNlIGlmIChyZXNvbHZlZFBhdGgubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gcmVzb2x2ZWRQYXRoOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICIuIjsKICAgIH0KICB9LAogIG5vcm1hbGl6ZTogZnVuY3Rpb24gbm9ybWFsaXplKHBhdGgpIHsKICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICBpZiAocGF0aC5sZW5ndGggPT09IDApCiAgICAgIHJldHVybiAiLiI7CiAgICB2YXIgaXNBYnNvbHV0ZTIgPSBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IDQ3OwogICAgdmFyIHRyYWlsaW5nU2VwYXJhdG9yID0gcGF0aC5jaGFyQ29kZUF0KHBhdGgubGVuZ3RoIC0gMSkgPT09IDQ3OwogICAgcGF0aCA9IG5vcm1hbGl6ZVN0cmluZ1Bvc2l4KHBhdGgsICFpc0Fic29sdXRlMik7CiAgICBpZiAocGF0aC5sZW5ndGggPT09IDAgJiYgIWlzQWJzb2x1dGUyKQogICAgICBwYXRoID0gIi4iOwogICAgaWYgKHBhdGgubGVuZ3RoID4gMCAmJiB0cmFpbGluZ1NlcGFyYXRvcikKICAgICAgcGF0aCArPSAiLyI7CiAgICBpZiAoaXNBYnNvbHV0ZTIpCiAgICAgIHJldHVybiAiLyIgKyBwYXRoOwogICAgcmV0dXJuIHBhdGg7CiAgfSwKICBpc0Fic29sdXRlOiBmdW5jdGlvbiBpc0Fic29sdXRlKHBhdGgpIHsKICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICByZXR1cm4gcGF0aC5sZW5ndGggPiAwICYmIHBhdGguY2hhckNvZGVBdCgwKSA9PT0gNDc7CiAgfSwKICBqb2luOiBmdW5jdGlvbiBqb2luKCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApCiAgICAgIHJldHVybiAiLiI7CiAgICB2YXIgam9pbmVkOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGFyZyA9IGFyZ3VtZW50c1tpXTsKICAgICAgYXNzZXJ0UGF0aChhcmcpOwogICAgICBpZiAoYXJnLmxlbmd0aCA+IDApIHsKICAgICAgICBpZiAoam9pbmVkID09PSB2b2lkIDApCiAgICAgICAgICBqb2luZWQgPSBhcmc7CiAgICAgICAgZWxzZQogICAgICAgICAgam9pbmVkICs9ICIvIiArIGFyZzsKICAgICAgfQogICAgfQogICAgaWYgKGpvaW5lZCA9PT0gdm9pZCAwKQogICAgICByZXR1cm4gIi4iOwogICAgcmV0dXJuIHBvc2l4Lm5vcm1hbGl6ZShqb2luZWQpOwogIH0sCiAgcmVsYXRpdmU6IGZ1bmN0aW9uIHJlbGF0aXZlKGZyb20sIHRvKSB7CiAgICBhc3NlcnRQYXRoKGZyb20pOwogICAgYXNzZXJ0UGF0aCh0byk7CiAgICBpZiAoZnJvbSA9PT0gdG8pCiAgICAgIHJldHVybiAiIjsKICAgIGZyb20gPSBwb3NpeC5yZXNvbHZlKGZyb20pOwogICAgdG8gPSBwb3NpeC5yZXNvbHZlKHRvKTsKICAgIGlmIChmcm9tID09PSB0bykKICAgICAgcmV0dXJuICIiOwogICAgdmFyIGZyb21TdGFydCA9IDE7CiAgICBmb3IgKDsgZnJvbVN0YXJ0IDwgZnJvbS5sZW5ndGg7ICsrZnJvbVN0YXJ0KSB7CiAgICAgIGlmIChmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0KSAhPT0gNDcpCiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB2YXIgZnJvbUVuZCA9IGZyb20ubGVuZ3RoOwogICAgdmFyIGZyb21MZW4gPSBmcm9tRW5kIC0gZnJvbVN0YXJ0OwogICAgdmFyIHRvU3RhcnQgPSAxOwogICAgZm9yICg7IHRvU3RhcnQgPCB0by5sZW5ndGg7ICsrdG9TdGFydCkgewogICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0KSAhPT0gNDcpCiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB2YXIgdG9FbmQgPSB0by5sZW5ndGg7CiAgICB2YXIgdG9MZW4gPSB0b0VuZCAtIHRvU3RhcnQ7CiAgICB2YXIgbGVuZ3RoID0gZnJvbUxlbiA8IHRvTGVuID8gZnJvbUxlbiA6IHRvTGVuOwogICAgdmFyIGxhc3RDb21tb25TZXAgPSAtMTsKICAgIHZhciBpID0gMDsKICAgIGZvciAoOyBpIDw9IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChpID09PSBsZW5ndGgpIHsKICAgICAgICBpZiAodG9MZW4gPiBsZW5ndGgpIHsKICAgICAgICAgIGlmICh0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKSA9PT0gNDcpIHsKICAgICAgICAgICAgcmV0dXJuIHRvLnNsaWNlKHRvU3RhcnQgKyBpICsgMSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGkgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHRvLnNsaWNlKHRvU3RhcnQgKyBpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGZyb21MZW4gPiBsZW5ndGgpIHsKICAgICAgICAgIGlmIChmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSkgPT09IDQ3KSB7CiAgICAgICAgICAgIGxhc3RDb21tb25TZXAgPSBpOwogICAgICAgICAgfSBlbHNlIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgIGxhc3RDb21tb25TZXAgPSAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgfQogICAgICB2YXIgZnJvbUNvZGUgPSBmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSk7CiAgICAgIHZhciB0b0NvZGUgPSB0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKTsKICAgICAgaWYgKGZyb21Db2RlICE9PSB0b0NvZGUpCiAgICAgICAgYnJlYWs7CiAgICAgIGVsc2UgaWYgKGZyb21Db2RlID09PSA0NykKICAgICAgICBsYXN0Q29tbW9uU2VwID0gaTsKICAgIH0KICAgIHZhciBvdXQgPSAiIjsKICAgIGZvciAoaSA9IGZyb21TdGFydCArIGxhc3RDb21tb25TZXAgKyAxOyBpIDw9IGZyb21FbmQ7ICsraSkgewogICAgICBpZiAoaSA9PT0gZnJvbUVuZCB8fCBmcm9tLmNoYXJDb2RlQXQoaSkgPT09IDQ3KSB7CiAgICAgICAgaWYgKG91dC5sZW5ndGggPT09IDApCiAgICAgICAgICBvdXQgKz0gIi4uIjsKICAgICAgICBlbHNlCiAgICAgICAgICBvdXQgKz0gIi8uLiI7CiAgICAgIH0KICAgIH0KICAgIGlmIChvdXQubGVuZ3RoID4gMCkKICAgICAgcmV0dXJuIG91dCArIHRvLnNsaWNlKHRvU3RhcnQgKyBsYXN0Q29tbW9uU2VwKTsKICAgIGVsc2UgewogICAgICB0b1N0YXJ0ICs9IGxhc3RDb21tb25TZXA7CiAgICAgIGlmICh0by5jaGFyQ29kZUF0KHRvU3RhcnQpID09PSA0NykKICAgICAgICArK3RvU3RhcnQ7CiAgICAgIHJldHVybiB0by5zbGljZSh0b1N0YXJ0KTsKICAgIH0KICB9LAogIF9tYWtlTG9uZzogZnVuY3Rpb24gX21ha2VMb25nKHBhdGgpIHsKICAgIHJldHVybiBwYXRoOwogIH0sCiAgZGlybmFtZTogZnVuY3Rpb24gZGlybmFtZShwYXRoKSB7CiAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKQogICAgICByZXR1cm4gIi4iOwogICAgdmFyIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCk7CiAgICB2YXIgaGFzUm9vdCA9IGNvZGUgPT09IDQ3OwogICAgdmFyIGVuZCA9IC0xOwogICAgdmFyIG1hdGNoZWRTbGFzaCA9IHRydWU7CiAgICBmb3IgKHZhciBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDE7IC0taSkgewogICAgICBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICBpZiAoY29kZSA9PT0gNDcpIHsKICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgZW5kID0gaTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgaWYgKGVuZCA9PT0gLTEpCiAgICAgIHJldHVybiBoYXNSb290ID8gIi8iIDogIi4iOwogICAgaWYgKGhhc1Jvb3QgJiYgZW5kID09PSAxKQogICAgICByZXR1cm4gIi8vIjsKICAgIHJldHVybiBwYXRoLnNsaWNlKDAsIGVuZCk7CiAgfSwKICBiYXNlbmFtZTogZnVuY3Rpb24gYmFzZW5hbWUocGF0aCwgZXh0KSB7CiAgICBpZiAoZXh0ICE9PSB2b2lkIDAgJiYgdHlwZW9mIGV4dCAhPT0gInN0cmluZyIpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJleHQiIGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcnKTsKICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICB2YXIgc3RhcnQgPSAwOwogICAgdmFyIGVuZCA9IC0xOwogICAgdmFyIG1hdGNoZWRTbGFzaCA9IHRydWU7CiAgICB2YXIgaTsKICAgIGlmIChleHQgIT09IHZvaWQgMCAmJiBleHQubGVuZ3RoID4gMCAmJiBleHQubGVuZ3RoIDw9IHBhdGgubGVuZ3RoKSB7CiAgICAgIGlmIChleHQubGVuZ3RoID09PSBwYXRoLmxlbmd0aCAmJiBleHQgPT09IHBhdGgpCiAgICAgICAgcmV0dXJuICIiOwogICAgICB2YXIgZXh0SWR4ID0gZXh0Lmxlbmd0aCAtIDE7CiAgICAgIHZhciBmaXJzdE5vblNsYXNoRW5kID0gLTE7CiAgICAgIGZvciAoaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB2YXIgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKTsKICAgICAgICBpZiAoY29kZSA9PT0gNDcpIHsKICAgICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICAgIHN0YXJ0ID0gaSArIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZmlyc3ROb25TbGFzaEVuZCA9PT0gLTEpIHsKICAgICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgICAgIGZpcnN0Tm9uU2xhc2hFbmQgPSBpICsgMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHRJZHggPj0gMCkgewogICAgICAgICAgICBpZiAoY29kZSA9PT0gZXh0LmNoYXJDb2RlQXQoZXh0SWR4KSkgewogICAgICAgICAgICAgIGlmICgtLWV4dElkeCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGVuZCA9IGk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGV4dElkeCA9IC0xOwogICAgICAgICAgICAgIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHN0YXJ0ID09PSBlbmQpCiAgICAgICAgZW5kID0gZmlyc3ROb25TbGFzaEVuZDsKICAgICAgZWxzZSBpZiAoZW5kID09PSAtMSkKICAgICAgICBlbmQgPSBwYXRoLmxlbmd0aDsKICAgICAgcmV0dXJuIHBhdGguc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgaWYgKHBhdGguY2hhckNvZGVBdChpKSA9PT0gNDcpIHsKICAgICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICAgIHN0YXJ0ID0gaSArIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZW5kID09PSAtMSkgewogICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgICBlbmQgPSBpICsgMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGVuZCA9PT0gLTEpCiAgICAgICAgcmV0dXJuICIiOwogICAgICByZXR1cm4gcGF0aC5zbGljZShzdGFydCwgZW5kKTsKICAgIH0KICB9LAogIGV4dG5hbWU6IGZ1bmN0aW9uIGV4dG5hbWUocGF0aCkgewogICAgYXNzZXJ0UGF0aChwYXRoKTsKICAgIHZhciBzdGFydERvdCA9IC0xOwogICAgdmFyIHN0YXJ0UGFydCA9IDA7CiAgICB2YXIgZW5kID0gLTE7CiAgICB2YXIgbWF0Y2hlZFNsYXNoID0gdHJ1ZTsKICAgIHZhciBwcmVEb3RTdGF0ZSA9IDA7CiAgICBmb3IgKHZhciBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICB2YXIgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKTsKICAgICAgaWYgKGNvZGUgPT09IDQ3KSB7CiAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgIHN0YXJ0UGFydCA9IGkgKyAxOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChlbmQgPT09IC0xKSB7CiAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgZW5kID0gaSArIDE7CiAgICAgIH0KICAgICAgaWYgKGNvZGUgPT09IDQ2KSB7CiAgICAgICAgaWYgKHN0YXJ0RG90ID09PSAtMSkKICAgICAgICAgIHN0YXJ0RG90ID0gaTsKICAgICAgICBlbHNlIGlmIChwcmVEb3RTdGF0ZSAhPT0gMSkKICAgICAgICAgIHByZURvdFN0YXRlID0gMTsKICAgICAgfSBlbHNlIGlmIChzdGFydERvdCAhPT0gLTEpIHsKICAgICAgICBwcmVEb3RTdGF0ZSA9IC0xOwogICAgICB9CiAgICB9CiAgICBpZiAoc3RhcnREb3QgPT09IC0xIHx8IGVuZCA9PT0gLTEgfHwgLy8gV2Ugc2F3IGEgbm9uLWRvdCBjaGFyYWN0ZXIgaW1tZWRpYXRlbHkgYmVmb3JlIHRoZSBkb3QKICAgIHByZURvdFN0YXRlID09PSAwIHx8IC8vIFRoZSAocmlnaHQtbW9zdCkgdHJpbW1lZCBwYXRoIGNvbXBvbmVudCBpcyBleGFjdGx5ICcuLicKICAgIHByZURvdFN0YXRlID09PSAxICYmIHN0YXJ0RG90ID09PSBlbmQgLSAxICYmIHN0YXJ0RG90ID09PSBzdGFydFBhcnQgKyAxKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KICAgIHJldHVybiBwYXRoLnNsaWNlKHN0YXJ0RG90LCBlbmQpOwogIH0sCiAgZm9ybWF0OiBmdW5jdGlvbiBmb3JtYXQocGF0aE9iamVjdCkgewogICAgaWYgKHBhdGhPYmplY3QgPT09IG51bGwgfHwgdHlwZW9mIHBhdGhPYmplY3QgIT09ICJvYmplY3QiKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RoZSAicGF0aE9iamVjdCIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIE9iamVjdC4gUmVjZWl2ZWQgdHlwZSAnICsgdHlwZW9mIHBhdGhPYmplY3QpOwogICAgfQogICAgcmV0dXJuIF9mb3JtYXQoIi8iLCBwYXRoT2JqZWN0KTsKICB9LAogIHBhcnNlOiBmdW5jdGlvbiBwYXJzZShwYXRoKSB7CiAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgdmFyIHJldCA9IHsgcm9vdDogIiIsIGRpcjogIiIsIGJhc2U6ICIiLCBleHQ6ICIiLCBuYW1lOiAiIiB9OwogICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKQogICAgICByZXR1cm4gcmV0OwogICAgdmFyIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCk7CiAgICB2YXIgaXNBYnNvbHV0ZTIgPSBjb2RlID09PSA0NzsKICAgIHZhciBzdGFydDsKICAgIGlmIChpc0Fic29sdXRlMikgewogICAgICByZXQucm9vdCA9ICIvIjsKICAgICAgc3RhcnQgPSAxOwogICAgfSBlbHNlIHsKICAgICAgc3RhcnQgPSAwOwogICAgfQogICAgdmFyIHN0YXJ0RG90ID0gLTE7CiAgICB2YXIgc3RhcnRQYXJ0ID0gMDsKICAgIHZhciBlbmQgPSAtMTsKICAgIHZhciBtYXRjaGVkU2xhc2ggPSB0cnVlOwogICAgdmFyIGkgPSBwYXRoLmxlbmd0aCAtIDE7CiAgICB2YXIgcHJlRG90U3RhdGUgPSAwOwogICAgZm9yICg7IGkgPj0gc3RhcnQ7IC0taSkgewogICAgICBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICBpZiAoY29kZSA9PT0gNDcpIHsKICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgc3RhcnRQYXJ0ID0gaSArIDE7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGVuZCA9PT0gLTEpIHsKICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICBlbmQgPSBpICsgMTsKICAgICAgfQogICAgICBpZiAoY29kZSA9PT0gNDYpIHsKICAgICAgICBpZiAoc3RhcnREb3QgPT09IC0xKQogICAgICAgICAgc3RhcnREb3QgPSBpOwogICAgICAgIGVsc2UgaWYgKHByZURvdFN0YXRlICE9PSAxKQogICAgICAgICAgcHJlRG90U3RhdGUgPSAxOwogICAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewogICAgICAgIHByZURvdFN0YXRlID0gLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChzdGFydERvdCA9PT0gLTEgfHwgZW5kID09PSAtMSB8fCAvLyBXZSBzYXcgYSBub24tZG90IGNoYXJhY3RlciBpbW1lZGlhdGVseSBiZWZvcmUgdGhlIGRvdAogICAgcHJlRG90U3RhdGUgPT09IDAgfHwgLy8gVGhlIChyaWdodC1tb3N0KSB0cmltbWVkIHBhdGggY29tcG9uZW50IGlzIGV4YWN0bHkgJy4uJwogICAgcHJlRG90U3RhdGUgPT09IDEgJiYgc3RhcnREb3QgPT09IGVuZCAtIDEgJiYgc3RhcnREb3QgPT09IHN0YXJ0UGFydCArIDEpIHsKICAgICAgaWYgKGVuZCAhPT0gLTEpIHsKICAgICAgICBpZiAoc3RhcnRQYXJ0ID09PSAwICYmIGlzQWJzb2x1dGUyKQogICAgICAgICAgcmV0LmJhc2UgPSByZXQubmFtZSA9IHBhdGguc2xpY2UoMSwgZW5kKTsKICAgICAgICBlbHNlCiAgICAgICAgICByZXQuYmFzZSA9IHJldC5uYW1lID0gcGF0aC5zbGljZShzdGFydFBhcnQsIGVuZCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChzdGFydFBhcnQgPT09IDAgJiYgaXNBYnNvbHV0ZTIpIHsKICAgICAgICByZXQubmFtZSA9IHBhdGguc2xpY2UoMSwgc3RhcnREb3QpOwogICAgICAgIHJldC5iYXNlID0gcGF0aC5zbGljZSgxLCBlbmQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldC5uYW1lID0gcGF0aC5zbGljZShzdGFydFBhcnQsIHN0YXJ0RG90KTsKICAgICAgICByZXQuYmFzZSA9IHBhdGguc2xpY2Uoc3RhcnRQYXJ0LCBlbmQpOwogICAgICB9CiAgICAgIHJldC5leHQgPSBwYXRoLnNsaWNlKHN0YXJ0RG90LCBlbmQpOwogICAgfQogICAgaWYgKHN0YXJ0UGFydCA+IDApCiAgICAgIHJldC5kaXIgPSBwYXRoLnNsaWNlKDAsIHN0YXJ0UGFydCAtIDEpOwogICAgZWxzZSBpZiAoaXNBYnNvbHV0ZTIpCiAgICAgIHJldC5kaXIgPSAiLyI7CiAgICByZXR1cm4gcmV0OwogIH0sCiAgc2VwOiAiLyIsCiAgZGVsaW1pdGVyOiAiOiIsCiAgd2luMzI6IG51bGwsCiAgcG9zaXg6IG51bGwKfTsKcG9zaXgucG9zaXggPSBwb3NpeDsKdmFyIHBhdGhCcm93c2VyaWZ5ID0gcG9zaXg7CmZ1bmN0aW9uIGJpbmRSZXF1aXJlVG9DdHgoY3R4KSB7CiAgY29uc3QgY2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IGZhY3RvcmllcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgZGVwZW5kZW5jaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCBtb2R1bGVSZXF1aXJpbmdUYXNrcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgcGFyc2VNb2R1bGVOYW1lID0gZnVuY3Rpb24obW9kdWxlTmFtZTIpIHsKICAgIGNvbnN0IFssIG5hbWUsIHZlcnNpb24sIGZpbGVdID0gbW9kdWxlTmFtZTIubWF0Y2goLyheQD9bXi9AXSspKD86QChbXi9dKykpPyguKikvKSB8fCBbXTsKICAgIHJldHVybiBbbmFtZSwgdmVyc2lvbiwgZmlsZV07CiAgfTsKICBjb25zdCByZXNvbHZlID0gKG1vZHVsZU5hbWUyLCBfX2ZpbGVwYXRoKSA9PiB7CiAgICBpZiAoWyJyZXF1aXJlIiwgIm1vZHVsZSIsICJleHBvcnRzIl0uaW5jbHVkZXMobW9kdWxlTmFtZTIpKSB7CiAgICAgIHJldHVybiBtb2R1bGVOYW1lMjsKICAgIH0KICAgIGlmIChwYXRoQnJvd3NlcmlmeS5pc0Fic29sdXRlKG1vZHVsZU5hbWUyKSkgewogICAgICByZXR1cm4gbW9kdWxlTmFtZTI7CiAgICB9CiAgICBpZiAobW9kdWxlTmFtZTIuc3RhcnRzV2l0aCgiLiIpKSB7CiAgICAgIGlmICghX19maWxlcGF0aCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgW2FtZF0gY2FuJ3Qgbm90IHJlc29sdmUgcmVsYXRpdmUgcGF0aCAke21vZHVsZU5hbWUyfSB3aXRob3V0IF9fZGlybmFtZWApOwogICAgICB9CiAgICAgIHJldHVybiBwYXRoQnJvd3NlcmlmeS5yZXNvbHZlKHBhdGhCcm93c2VyaWZ5LmRpcm5hbWUoX19maWxlcGF0aCksIG1vZHVsZU5hbWUyKTsKICAgIH0KICAgIGlmIChtb2R1bGVOYW1lMi5zdGFydHNXaXRoKCIvIikpIHsKICAgICAgcmV0dXJuIHBhdGhCcm93c2VyaWZ5LnJlc29sdmUoY3R4LnJvb3QsIG1vZHVsZU5hbWUyKTsKICAgIH0KICAgIGNvbnN0IFttb2R1bGVQYXRoMl0gPSBwYXJzZU1vZHVsZU5hbWUobW9kdWxlTmFtZTIpOwogICAgcmV0dXJuIHBhdGhCcm93c2VyaWZ5LnJlc29sdmUoY3R4LnJvb3QsICJub2RlX21vZHVsZXMiLCBtb2R1bGVQYXRoMik7CiAgfTsKICBjb25zdCByZXNvbHZlRGVwcyA9IGFzeW5jIChfcGFja2FnZU5hbWUsIF92ZXJzaW9uLCBfZmlsZSkgPT4gewogICAgY29uc3QgcGFyYW1zID0gewogICAgICBwYWNrYWdlTmFtZTogX3BhY2thZ2VOYW1lLAogICAgICB2ZXJzaW9uOiBfdmVyc2lvbiwKICAgICAgZmlsZTogX2ZpbGUKICAgIH07CiAgICBjb25zdCByZXMgPSBhd2FpdCBjdHgucGx1Z2luUmVkdWNlKAogICAgICBhc3luYyAocHJlVmFsdWUsIHBsdWdpbikgPT4gewogICAgICAgIGNvbnN0IHJlczIgPSBhd2FpdCBwbHVnaW4ucmVzb2x2ZU1vZHVsZVVybChwcmVWYWx1ZSk7CiAgICAgICAgaWYgKHR5cGVvZiByZXMyID09PSAic3RyaW5nIikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdWx0OiByZXMyLAogICAgICAgICAgICBicmVhazogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsgcmVzdWx0OiByZXMyIH07CiAgICAgIH0sCiAgICAgIHBhcmFtcwogICAgKTsKICAgIHJldHVybiByZXM7CiAgfTsKICBjb25zdCBtb2R1bGVGYWN0b3J5ID0gYXN5bmMgKG1vZHVsZU5hbWUsIF90aGlzKSA9PiB7CiAgICBjb25zdCBtb2R1bGVQYXRoID0gcmVzb2x2ZShtb2R1bGVOYW1lLCBfdGhpcy5fX2Rpcm5hbWUpOwogICAgaWYgKG1vZHVsZVJlcXVpcmluZ1Rhc2tzLmhhcyhtb2R1bGVQYXRoKSkgewogICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUyMiwgcmVqZWN0KSA9PiB7CiAgICAgICAgY29uc3QgdGFza3MgPSBtb2R1bGVSZXF1aXJpbmdUYXNrcy5nZXQobW9kdWxlUGF0aCk7CiAgICAgICAgdGFza3MucHVzaChbcmVzb2x2ZTIyLCByZWplY3RdKTsKICAgICAgICBjdHgubG9nZ2VyLmxvZyhgW2FtZF0gcmVxdWlyZSAke21vZHVsZU5hbWV9LCBhbHJlYWR5IGhhcyB0YXNrIHJlcXVpcmluZywgd2FpdGluZyB0YXNrczogJHt0YXNrcy5sZW5ndGh9LmApOwogICAgICB9KTsKICAgIH0KICAgIGN0eC5sb2dnZXIubG9nKCJbYW1kXSBzdGFydCByZXF1aXJlIiwgbW9kdWxlUGF0aCk7CiAgICBtb2R1bGVSZXF1aXJpbmdUYXNrcy5zZXQobW9kdWxlUGF0aCwgW10pOwogICAgY29uc3QgY2xlYXJBbGxUYXNrcyA9IChlcnIsIG1vZHVsZV8yKSA9PiB7CiAgICAgIGNvbnN0IHRhc2tzID0gbW9kdWxlUmVxdWlyaW5nVGFza3MuZ2V0KG1vZHVsZVBhdGgpOwogICAgICBpZiAodGFza3MgPT0gbnVsbCA/IHZvaWQgMCA6IHRhc2tzLmxlbmd0aCkgewogICAgICAgIHRhc2tzLmZvckVhY2goKFtyZXNvbHZlMjIsIHJlamVjdF0sIGluZGV4KSA9PiB7CiAgICAgICAgICBjdHgubG9nZ2VyLmxvZygiW2FtZF0gcmVzb2x2ZSBpdGVtIiwgaW5kZXgsIG1vZHVsZU5hbWUpOwogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc29sdmUyMihtb2R1bGVfMik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgbW9kdWxlUmVxdWlyaW5nVGFza3MuZGVsZXRlKG1vZHVsZVBhdGgpOwogICAgICBpZiAoZXJyKSB7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGVfMjsKICAgIH07CiAgICBpZiAoY2FjaGUuaGFzKG1vZHVsZVBhdGgpKSB7CiAgICAgIGN0eC5sb2dnZXIubG9nKGBbYW1kXSByZXF1aXJlICR7bW9kdWxlTmFtZX0sIHJlc29sdmVkIGZyb20gY2FjaGVgKTsKICAgICAgcmV0dXJuIGNsZWFyQWxsVGFza3Modm9pZCAwLCBjYWNoZS5nZXQobW9kdWxlUGF0aCkpOwogICAgfQogICAgbGV0IGZhY3RvcnkgPSBmYWN0b3JpZXMuZ2V0KG1vZHVsZVBhdGgpOwogICAgaWYgKCFmYWN0b3J5KSB7CiAgICAgIGlmICghbW9kdWxlTmFtZS5zdGFydHNXaXRoKCIuIikgJiYgIXBhdGhCcm93c2VyaWZ5LmlzQWJzb2x1dGUobW9kdWxlTmFtZSkpIHsKICAgICAgICBjb25zdCBbbmFtZSwgdmVyc2lvbiwgZmlsZV0gPSBwYXJzZU1vZHVsZU5hbWUobW9kdWxlTmFtZSk7CiAgICAgICAgY29uc3Qgc2NyaXB0VXJsID0gYXdhaXQgcmVzb2x2ZURlcHMobmFtZSwgdmVyc2lvbiwgZmlsZSk7CiAgICAgICAgY3R4LmV2ZW50U3Vic2NyaWJlTWFuYWdlci50cmlnZ2VyKElFdmVudFR5cGVzLkxvYWRpbmdTY3JpcHQsIG1vZHVsZU5hbWUsIHNjcmlwdFVybCk7CiAgICAgICAgaWYgKHR5cGVvZiBzY3JpcHRVcmwgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICBhd2FpdCBjdHguc2NyaXB0TG9hZGVyLmxvYWRTY3JpcHQoZG9jdW1lbnQuYm9keSwgc2NyaXB0VXJsLCBtb2R1bGVOYW1lKTsKICAgICAgICAgIGZhY3RvcnkgPSBmYWN0b3JpZXMuZ2V0KG1vZHVsZVBhdGgpOwogICAgICAgICAgY3R4LmxvZ2dlci5sb2coIlthbWRdIHNjcmlwdCBsb2FkZWQiLCBmYWN0b3J5LCBtb2R1bGVQYXRoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgW2V4aXN0LCBmaWxlXSA9IGN0eC5mcy5wYXRoUmVkdWNlKG1vZHVsZVBhdGgpOwogICAgICAgIGlmIChleGlzdCAmJiBSZWZsZWN0LmhhcyhmaWxlLCAiY29udGVudCIpKSB7CiAgICAgICAgICBjb25zdCBjb250ZW50ID0gZmlsZS5jb250ZW50OwogICAgICAgICAgZmFjdG9yaWVzLnNldChtb2R1bGVQYXRoLCBjb250ZW50KTsKICAgICAgICAgIGZhY3RvcnkgPSBjb250ZW50OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWZhY3RvcnkpIHsKICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoYFthbWRdIG1vZHVsZSBlcnJvcjogJHttb2R1bGVQYXRofSBkb2VzIG5vdCBleGlzdC5gKTsKICAgICAgICByZXR1cm4gY2xlYXJBbGxUYXNrcyhlcnIpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBtb2R1bGVEZXBzID0gW107CiAgICBjb25zdCByZXF1aXJlQ3R4ID0geyBfX2Rpcm5hbWU6IG1vZHVsZVBhdGgsIGRlcHM6IG1vZHVsZURlcHMgfTsKICAgIGNvbnN0IHJlcXVpcmVfID0gZ2V0UmVxdWlyZUZ1bmMocmVxdWlyZUN0eCk7CiAgICBsZXQgZGVwTW9kdWxlTmFtZXMgPSBkZXBlbmRlbmNpZXMuZ2V0KG1vZHVsZVBhdGgpOwogICAgaWYgKHR5cGVvZiBmYWN0b3J5ID09PSAic3RyaW5nIikgewogICAgICBjb25zdCB7IGRlcHM6IF9kZXBNb2R1bGVOYW1lcywgZmFjdG9yeTogZmFjdG9yeV8gfSA9IGF3YWl0IGN0eC5wbHVnaW5SZWR1Y2UoYXN5bmMgKHByZVZhbHVlLCBwbHVnaW4pID0+IHsKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwbHVnaW4uYmVmb3JlTW9kdWxlR2VuZXJhdGUoX3RoaXMsIHByZVZhbHVlKTsKICAgICAgICByZXR1cm4geyByZXN1bHQ6IHsgLi4ucmVzdWx0LCBuYW1lOiBtb2R1bGVOYW1lIH0gfTsKICAgICAgfSwgeyBuYW1lOiBtb2R1bGVOYW1lLCBkZXBzOiBkZXBNb2R1bGVOYW1lcywgZmFjdG9yeSB9KTsKICAgICAgZmFjdG9yeSA9IGZhY3RvcnlfOwogICAgICBkZXBNb2R1bGVOYW1lcyA9IF9kZXBNb2R1bGVOYW1lczsKICAgIH0KICAgIGNvbnN0IF9leHBvcnRzID0ge307CiAgICBjb25zdCBjb21tb25qcyA9IHsKICAgICAgcmVxdWlyZTogcmVxdWlyZV8sCiAgICAgIG1vZHVsZTogeyBleHBvcnRzOiBfZXhwb3J0cyB9LAogICAgICBleHBvcnRzOiBfZXhwb3J0cwogICAgfTsKICAgIGxldCBkZXBzID0gW107CiAgICBpZiAoZGVwTW9kdWxlTmFtZXMgPT0gbnVsbCA/IHZvaWQgMCA6IGRlcE1vZHVsZU5hbWVzLmxlbmd0aCkgewogICAgICBkZXBzID0gYXdhaXQgUHJvbWlzZS5hbGwoZGVwTW9kdWxlTmFtZXMubWFwKChkZXBOYW1lKSA9PiB7CiAgICAgICAgaWYgKGNvbW1vbmpzW2RlcE5hbWVdKQogICAgICAgICAgcmV0dXJuIGNvbW1vbmpzW2RlcE5hbWVdOwogICAgICAgIHJldHVybiByZXF1aXJlXyhkZXBOYW1lKTsKICAgICAgfSkpOwogICAgfQogICAgdHJ5IHsKICAgICAgbGV0IGV4cG9ydHNSZXR1cm47CiAgICAgIGlmICh0eXBlb2YgZmFjdG9yeSA9PT0gInN0cmluZyIpIHsKICAgICAgICBleHBvcnRzUmV0dXJuID0gYXdhaXQgZXZhbChmYWN0b3J5KSguLi5kZXBzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBleHBvcnRzUmV0dXJuID0gYXdhaXQgZmFjdG9yeSguLi5kZXBzKTsKICAgICAgfQogICAgICBjdHguZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLnRyaWdnZXIoSUV2ZW50VHlwZXMuTW9kdWxlRGVwcywgcmVxdWlyZUN0eCk7CiAgICAgIGNvbnN0IG1vZHVsZV8gPSAoKCkgPT4gewogICAgICAgIGlmIChPYmplY3Qua2V5cyhjb21tb25qcy5tb2R1bGUuZXhwb3J0cykubGVuZ3RoIHx8IHR5cGVvZiBjb21tb25qcy5tb2R1bGUuZXhwb3J0cyAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiBjb21tb25qcy5tb2R1bGUuZXhwb3J0czsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cG9ydHNSZXR1cm47CiAgICAgIH0pKCk7CiAgICAgIGNhY2hlLnNldChtb2R1bGVQYXRoLCBtb2R1bGVfKTsKICAgICAgY3R4LmxvZ2dlci5sb2coIlthbWRdIHJlc29sdmUgbW9kdWxlIHRhc2tzIGhlYWQiLCBtb2R1bGVQYXRoLCBtb2R1bGVfKTsKICAgICAgcmV0dXJuIGNsZWFyQWxsVGFza3Modm9pZCAwLCBtb2R1bGVfKTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICByZXR1cm4gY2xlYXJBbGxUYXNrcyhlcnIsIHZvaWQgMCk7CiAgICB9CiAgfTsKICBjb25zdCBnZXRSZXF1aXJlRnVuYyA9IChfdGhpczIpID0+IHsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKGFzeW5jICguLi5hcmdzKSA9PiB7CiAgICAgIHZhciBfYSwgX2I7CiAgICAgIGNvbnN0IFttb2R1bGVOYW1lc18sIGNiXSA9IGFyZ3M7CiAgICAgIGNvbnN0IG1vZHVsZU5hbWVzID0gYXdhaXQgY3R4LnBsdWdpblJlZHVjZShhc3luYyAocHJlVmFsdWUsIHBsdWdpbikgPT4gewogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN1bHQ6IGF3YWl0IHBsdWdpbi5yZXF1aXJlKF90aGlzMiwgcHJlVmFsdWUpCiAgICAgICAgfTsKICAgICAgfSwgbW9kdWxlTmFtZXNfKTsKICAgICAgaWYgKHR5cGVvZiBtb2R1bGVOYW1lcyA9PT0gInN0cmluZyIpIHsKICAgICAgICAoX2EgPSBfdGhpczIuZGVwcykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnB1c2gocmVzb2x2ZShtb2R1bGVOYW1lcywgX3RoaXMyLl9fZGlybmFtZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIChfYiA9IF90aGlzMi5kZXBzKSA9PSBudWxsID8gdm9pZCAwIDogX2IucHVzaCguLi5tb2R1bGVOYW1lcy5yZWR1Y2UoKHByZXZpb3VzVmFsdWUsIGN1cnJlbnRWYWx1ZSkgPT4gewogICAgICAgICAgcHJldmlvdXNWYWx1ZS5wdXNoKHJlc29sdmUoY3VycmVudFZhbHVlLCBfdGhpczIuX19kaXJuYW1lKSk7CiAgICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZTsKICAgICAgICB9LCBbXSkpOwogICAgICB9CiAgICAgIGxldCBtb2R1bGVzOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShtb2R1bGVOYW1lcykpIHsKICAgICAgICBtb2R1bGVzID0gYXdhaXQgUHJvbWlzZS5hbGwobW9kdWxlTmFtZXMubWFwKChuYW1lKSA9PiBtb2R1bGVGYWN0b3J5KG5hbWUsIF90aGlzMikpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtb2R1bGVzID0gYXdhaXQgbW9kdWxlRmFjdG9yeShtb2R1bGVOYW1lcywgX3RoaXMyKTsKICAgICAgfQogICAgICBjYiA9PSBudWxsID8gdm9pZCAwIDogY2IobW9kdWxlcyk7CiAgICAgIHJldHVybiBtb2R1bGVzOwogICAgfSwgewogICAgICBjYWNoZSwKICAgICAgZmFjdG9yaWVzLAogICAgICByZXNvbHZlLAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgIG1vZHVsZVJlcXVpcmluZ1Rhc2tzLAogICAgICByZXNvbHZlRGVwcwogICAgfSk7CiAgfTsKICBjdHgucmVxdWlyZSA9IGdldFJlcXVpcmVGdW5jKHsgX19kaXJuYW1lOiBjdHgucm9vdCB9KTsKfQpjb25zdCBjcmVhdGVFdmVudFN1YnNjcmliZU1hbmFnZXIgPSAoKSA9PiB7CiAgY29uc3QgZXZlbnRzSGFuZGxlcnNNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IHRyaWdnZXIgPSAoa2V5LCAuLi5wYXJhbXMpID0+IHsKICAgIGNvbnN0IGhhbmRsZXJzID0gZXZlbnRzSGFuZGxlcnNNYXAuZ2V0KGtleSk7CiAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgY29uc3QgZHJvcHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBoYW5kbGVycy5mb3JFYWNoKChoYW5kbGVyLCBpbmRleCkgPT4gewogICAgICAgIGlmIChoYW5kbGVyLmZpbHRlciAmJiAhaGFuZGxlci5maWx0ZXIoLi4ucGFyYW1zKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBoYW5kbGVyKC4uLnBhcmFtcyk7CiAgICAgICAgaWYgKGhhbmRsZXIub25jZSkgewogICAgICAgICAgZHJvcHMuc2V0KGluZGV4LCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBldmVudHNIYW5kbGVyc01hcC5zZXQoa2V5LCBoYW5kbGVycy5maWx0ZXIoKF8sIGluZGV4KSA9PiAhZHJvcHMuZ2V0KGluZGV4KSkpOwogICAgfQogIH07CiAgY29uc3QgbGlzdGVuID0gKGtleSwgY2IsIGZpbHRlcikgPT4gewogICAgdmFyIF9hLCBfYjsKICAgIGlmICghZXZlbnRzSGFuZGxlcnNNYXAuaGFzKGtleSkpIHsKICAgICAgZXZlbnRzSGFuZGxlcnNNYXAuc2V0KGtleSwgW10pOwogICAgfQogICAgY29uc3QgX2NiID0gT2JqZWN0LmFzc2lnbihjYiwgewogICAgICBmaWx0ZXIKICAgIH0pOwogICAgKF9iID0gKF9hID0gZXZlbnRzSGFuZGxlcnNNYXAuZ2V0KGtleSkpID09IG51bGwgPyB2b2lkIDAgOiBfYS5wdXNoKSA9PSBudWxsID8gdm9pZCAwIDogX2IuY2FsbChfYSwgX2NiKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBfYTI7CiAgICAgIGV2ZW50c0hhbmRsZXJzTWFwLnNldChrZXksIChfYTIgPSBldmVudHNIYW5kbGVyc01hcC5nZXQoa2V5KSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5maWx0ZXIoKGhhbmRsZXIpID0+IGhhbmRsZXIgIT09IF9jYikpOwogICAgfTsKICB9OwogIGNvbnN0IG9uY2UgPSAoa2V5LCBjYiwgZmlsdGVyLCBvblRpbWVvdXQsIHRpbWVvdXQgPSAtMSkgPT4gewogICAgdmFyIF9hLCBfYjsKICAgIGlmICghZXZlbnRzSGFuZGxlcnNNYXAuaGFzKGtleSkpIHsKICAgICAgZXZlbnRzSGFuZGxlcnNNYXAuc2V0KGtleSwgW10pOwogICAgfQogICAgY29uc3QgZGlzcG9zZSA9ICgpID0+IHsKICAgICAgdmFyIF9hMjsKICAgICAgZXZlbnRzSGFuZGxlcnNNYXAuc2V0KGtleSwgKF9hMiA9IGV2ZW50c0hhbmRsZXJzTWFwLmdldChrZXkpKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmZpbHRlcigoaGFuZGxlcikgPT4gaGFuZGxlciAhPT0gX2NiKSk7CiAgICB9OwogICAgbGV0IF90aW1lb3V0OwogICAgaWYgKHRpbWVvdXQgIT09IC0xKSB7CiAgICAgIF90aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgZGlzcG9zZSgpOwogICAgICAgIG9uVGltZW91dCA9PSBudWxsID8gdm9pZCAwIDogb25UaW1lb3V0KCk7CiAgICAgIH0sIHRpbWVvdXQpOwogICAgfQogICAgY29uc3QgX2NiID0gT2JqZWN0LmFzc2lnbigoLi4uYXJncykgPT4gewogICAgICBpZiAoX3RpbWVvdXQpCiAgICAgICAgY2xlYXJUaW1lb3V0KF90aW1lb3V0KTsKICAgICAgY2IoLi4uYXJncyk7CiAgICB9LCB7CiAgICAgIG9uY2U6IHRydWUsCiAgICAgIGZpbHRlcgogICAgfSk7CiAgICAoX2IgPSAoX2EgPSBldmVudHNIYW5kbGVyc01hcC5nZXQoa2V5KSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnB1c2gpID09IG51bGwgPyB2b2lkIDAgOiBfYi5jYWxsKF9hLCBfY2IpOwogICAgcmV0dXJuIGRpc3Bvc2U7CiAgfTsKICByZXR1cm4geyB0cmlnZ2VyLCBsaXN0ZW4sIG9uY2UgfTsKfTsKZnVuY3Rpb24gY3JlYXRlQW1kTWFuYWdlcihmczIsIHJvb3QgPSAiLyIsIHNjcmlwdFRpbWVvdXQgPSAxZTQsIGxvZ2dlcjIgPSBjb25zb2xlKSB7CiAgY29uc3QgY3R4MiA9IHt9OwogIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyID0gY3JlYXRlRXZlbnRTdWJzY3JpYmVNYW5hZ2VyKCk7CiAgY3R4Mi5mcyA9IGZzMjsKICBjdHgyLnJvb3QgPSByb290OwogIGN0eDIuc2NyaXB0VGltZW91dCA9IHNjcmlwdFRpbWVvdXQ7CiAgY3R4Mi5sb2dnZXIgPSBsb2dnZXIyOwogIGN0eDIucGx1Z2lucyA9IFtdOwogIGN0eDIucGx1Z2luUmVkdWNlID0gYXN5bmMgKHJlZHVjZXIsIGluaXRWYWx1ZSkgPT4gewogICAgbGV0IHJlc3VsdCA9IGluaXRWYWx1ZTsKICAgIGZvciAoY29uc3QgcGx1Z2luIG9mIGN0eDIucGx1Z2lucykgewogICAgICBjb25zdCB7IHJlc3VsdDogcmVzLCBicmVhazogYnJlYWtfIH0gPSBhd2FpdCByZWR1Y2VyKHJlc3VsdCwgcGx1Z2luKTsKICAgICAgaWYgKGJyZWFrXykgewogICAgICAgIHJldHVybiByZXM7CiAgICAgIH0KICAgICAgcmVzdWx0ID0gcmVzOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIGJpbmRSZXF1aXJlVG9DdHgoY3R4Mik7CiAgYmluZERlZmluZVRvQ3R4KGN0eDIpOwogIGJpbmRTY3JpcHRMb2FkZXJUb0N0eChjdHgyKTsKICBmdW5jdGlvbiBpbXBvcnRHbG9iYWxPYmplY3RTY3JpcHQodGFyZ2V0LCB1cmwsIG5hbWUpIHsKICAgIHJldHVybiBhc3luYyAoX3JlcXVpcmUpID0+IHsKICAgICAgYXdhaXQgY3R4Mi5zY3JpcHRMb2FkZXIubG9hZFNjcmlwdCh0YXJnZXQsIHVybCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgImRlZmF1bHQiOiBSZWZsZWN0LmdldCh3aW5kb3csIG5hbWUpLAogICAgICAgIC4uLlJlZmxlY3QuZ2V0KHdpbmRvdywgbmFtZSkKICAgICAgfTsKICAgIH07CiAgfQogIGNvbnN0IG1vZHVsZV8yID0gewogICAgcmVxdWlyZV86IGN0eDIucmVxdWlyZSwKICAgIGRlZmluZTogY3R4Mi5kZWZpbmUsCiAgICBfaW1wb3J0OiBpbXBvcnRHbG9iYWxPYmplY3RTY3JpcHQuYmluZChudWxsLCBkb2N1bWVudC5ib2R5KSwKICAgIG9uTW9kdWxlVXBkYXRlKHRhcmdldHMsIGNiKSB7CiAgICAgIHJldHVybiBjdHgyLmV2ZW50U3Vic2NyaWJlTWFuYWdlci5saXN0ZW4oSUV2ZW50VHlwZXMuTW9kdWxlVXBkYXRlLCAobW9kdWxlTmFtZTIpID0+IHsKICAgICAgICBpZiAoIXRhcmdldHMgfHwgdGFyZ2V0cy5pbmNsdWRlcyhtb2R1bGVOYW1lMikpIHsKICAgICAgICAgIGNiKFttb2R1bGVOYW1lMl0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgb25Nb2R1bGVMb2FkaW5nKGNiKSB7CiAgICAgIHJldHVybiBjdHgyLmV2ZW50U3Vic2NyaWJlTWFuYWdlci5saXN0ZW4oSUV2ZW50VHlwZXMuTG9hZGluZ1NjcmlwdCwgKG1vZHVsZU5hbWUyLCB1cmwpID0+IHsKICAgICAgICBjYihtb2R1bGVOYW1lMiwgdXJsKTsKICAgICAgfSk7CiAgICB9LAogICAgb25Nb2R1bGVEZXBzKGNiKSB7CiAgICAgIHJldHVybiBjdHgyLmV2ZW50U3Vic2NyaWJlTWFuYWdlci5saXN0ZW4oSUV2ZW50VHlwZXMuTW9kdWxlRGVwcywgKF90aGlzMikgPT4gewogICAgICAgIGlmICghX3RoaXMyLmRlcHMpIHsKICAgICAgICAgIGRlYnVnZ2VyOwogICAgICAgIH0KICAgICAgICBjYihfdGhpczIuZGVwcyB8fCBbXSwgX3RoaXMyLl9fZGlybmFtZSk7CiAgICAgIH0pOwogICAgfSwKICAgIG1vdW50VG9HbG9iYWwoZ2xvYmFsXyA9IHdpbmRvdykgewogICAgICBjb25zdCBjdXJyZW50RGVmaW5lID0gUmVmbGVjdC5nZXQoZ2xvYmFsXywgImRlZmluZSIpOwogICAgICBjb25zdCBjdXJyZW50UmVxdWlyZSA9IFJlZmxlY3QuZ2V0KGdsb2JhbF8sICJyZXF1aXJlIik7CiAgICAgIFJlZmxlY3Quc2V0KGdsb2JhbF8sICJkZWZpbmUiLCBjdHgyLmRlZmluZSk7CiAgICAgIFJlZmxlY3Quc2V0KGdsb2JhbF8sICJyZXF1aXJlIiwgY3R4Mi5yZXF1aXJlKTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICBSZWZsZWN0LnNldChnbG9iYWxfLCAiZGVmaW5lIiwgY3VycmVudERlZmluZSk7CiAgICAgICAgUmVmbGVjdC5zZXQoZ2xvYmFsXywgInJlcXVpcmUiLCBjdXJyZW50UmVxdWlyZSk7CiAgICAgIH07CiAgICB9LAogICAgc2V0UGx1Z2lucyhwbHVnaW5zKSB7CiAgICAgIGN0eDIucGx1Z2lucyA9IHBsdWdpbnM7CiAgICB9CiAgfTsKICByZXR1cm4gbW9kdWxlXzI7Cn0KdmFyIEZpbGVzQ2hhbmdlVHlwZSA9IC8qIEBfX1BVUkVfXyAqLyAoKEZpbGVzQ2hhbmdlVHlwZTIpID0+IHsKICBGaWxlc0NoYW5nZVR5cGUyWyJEZWxldGUiXSA9ICJkZWxldGUiOwogIEZpbGVzQ2hhbmdlVHlwZTJbIkNoYW5nZSJdID0gImNoYW5nZSI7CiAgRmlsZXNDaGFuZ2VUeXBlMlsiTmV3Il0gPSAibmV3IjsKICByZXR1cm4gRmlsZXNDaGFuZ2VUeXBlMjsKfSkoRmlsZXNDaGFuZ2VUeXBlIHx8IHt9KTsKY29uc3QgZ2V0UGF0aEZpbGVOYW1lID0gKHBhdGhPYmplY3QpID0+IGAke3BhdGhPYmplY3QubmFtZX0ke3BhdGhPYmplY3QuZXh0fWA7CmNvbnN0IHRyYXZlcnNlID0gKGRpciA9ICIiLCBkaXJlY3RvcnksIGNiKSA9PiB7CiAgZGlyZWN0b3J5LmNoaWxkcmVuLmZvckVhY2goKGl0ZW0pID0+IHsKICAgIGlmIChSZWZsZWN0LmhhcyhpdGVtLCAiY2hpbGRyZW4iKSkgewogICAgICB0cmF2ZXJzZShgJHtwYXRoQnJvd3NlcmlmeX0vJHtpdGVtLm5hbWV9YCwgaXRlbSwgY2IpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjYihgJHtwYXRoQnJvd3NlcmlmeX0vJHtpdGVtLm5hbWV9YCwgaXRlbSk7CiAgfSk7Cn07CmNsYXNzIEZpbGVzU3lzdGVtIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMucm9vdCA9IHsKICAgICAgbmFtZTogIiIsCiAgICAgIGNoaWxkcmVuOiB0aGlzLmdldFByb3h5TWFwKCIiLCBbXSkKICAgIH07CiAgICB0aGlzLmV2ZW50Q291bnQgPSAwOwogICAgdGhpcy5ldmVudCA9IGNyZWF0ZUV2ZW50U3Vic2NyaWJlTWFuYWdlcigpOwogICAgdGhpcy5jcCA9IHRoaXMuY3BPck12LmJpbmQodGhpcywgZmFsc2UpOwogICAgdGhpcy5tdiA9IHRoaXMuY3BPck12LmJpbmQodGhpcywgdHJ1ZSk7CiAgfQogIGdldFByb3h5TWFwKHBhdGgyLCBlbnRyaWVzKSB7CiAgICBjb25zdCBfdGhpczIgPSB0aGlzOwogICAgY29uc3QgbWFwID0gbmV3IE1hcChlbnRyaWVzKTsKICAgIGNvbnN0IHByb3h5TWV0aG9kID0gKG1ldGhvZE5hbWUsIGV2ZW50TmFtZSkgPT4gewogICAgICBjb25zdCBfbWV0aG9kID0gUmVmbGVjdC5nZXQobWFwLCBtZXRob2ROYW1lKTsKICAgICAgaWYgKHR5cGVvZiBfbWV0aG9kID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgY29uc3QgbWV0aG9kID0gZnVuY3Rpb24oLi4uYXJncykgewogICAgICAgICAgX3RoaXMyLmV2ZW50LnRyaWdnZXIoZXZlbnROYW1lLCBfdGhpczIuZXZlbnRDb3VudCsrLCBwYXRoMiwgLi4uYXJncyk7CiAgICAgICAgICByZXR1cm4gX21ldGhvZC5jYWxsKG1hcCwgLi4uYXJncyk7CiAgICAgICAgfTsKICAgICAgICBSZWZsZWN0LnNldChtYXAsIG1ldGhvZE5hbWUsIG1ldGhvZCk7CiAgICAgIH0KICAgIH07CiAgICBwcm94eU1ldGhvZCgic2V0IiwgImRpci1zZXQiKTsKICAgIHByb3h5TWV0aG9kKCJkZWxldGUiLCAiZGlyLWRlbGV0ZSIpOwogICAgcHJveHlNZXRob2QoImNsZWFyIiwgImRpci1jbGVhciIpOwogICAgcmV0dXJuIG1hcDsKICB9CiAgcGF0aFJlZHVjZSh0YXJnZXQpIHsKICAgIGNvbnN0IHBhdGhzID0gdGFyZ2V0LnNwbGl0KHBhdGhCcm93c2VyaWZ5LnNlcCk7CiAgICByZXR1cm4gcGF0aHMucmVkdWNlKChbc3RhdHVzLCBkaXJdLCBjdXIsIGluZGV4LCBhcnIpID0+IHsKICAgICAgdmFyIF9hLCBfYjsKICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgcmV0dXJuIFtzdGF0dXMsIGRpcl07CiAgICAgIH0KICAgICAgaWYgKGluZGV4ID09PSBhcnIubGVuZ3RoIC0gMSAmJiBjdXIgPT09ICIiKSB7CiAgICAgICAgcmV0dXJuIFtzdGF0dXMsIGRpcl07CiAgICAgIH0KICAgICAgcmV0dXJuIFtzdGF0dXMgJiYgKChfYSA9IGRpci5jaGlsZHJlbikgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmhhcyhjdXIpKSwgKF9iID0gZGlyLmNoaWxkcmVuKSA9PSBudWxsID8gdm9pZCAwIDogX2IuZ2V0KGN1cildOwogICAgfSwgW3RydWUsIHRoaXMucm9vdF0pOwogIH0KICBleGlzdCh0YXJnZXQpIHsKICAgIGNvbnN0IFtleGlzdF0gPSB0aGlzLnBhdGhSZWR1Y2UodGFyZ2V0KTsKICAgIHJldHVybiBleGlzdDsKICB9CiAgbWtkaXIodGFyZ2V0KSB7CiAgICBjb25zdCBwYXRoT2JqZWN0ID0gcGF0aEJyb3dzZXJpZnkucGFyc2UodGFyZ2V0KTsKICAgIGlmICh0aGlzLmV4aXN0KHRhcmdldCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBbZnNdIGZhaWxlZCB0byBta2RpciAke3RhcmdldH0sIGl0IGlzIGFscmVhZHkgZXhpc3RlZC5gKTsKICAgIH0KICAgIGNvbnN0IFtwYXJlbnRFeGlzdCwgcGFyZW50XSA9IHRoaXMucGF0aFJlZHVjZShwYXRoT2JqZWN0LmRpcik7CiAgICBpZiAoIXBhcmVudEV4aXN0KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgW2ZzXSBmYWlsZWQgdG8gbWtkaXIgJHt0YXJnZXR9LCBwYXJlbnQgcGF0aCAke3BhdGhPYmplY3QuZGlyfSBpcyBub3QgZXhpc3RlZC5gKTsKICAgIH0KICAgIGlmICghUmVmbGVjdC5oYXMocGFyZW50LCAiY2hpbGRyZW4iKSB8fCBSZWZsZWN0LmhhcyhwYXJlbnQsICJjb250ZW50IikpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBbZnNdIGZhaWxlZCB0byBta2RpciAke3RhcmdldH0sIHBhcmVudCBwYXRoICR7cGF0aE9iamVjdC5kaXJ9IGlzIG5vdCBhIGRpcmVjdG9yeS5gKTsKICAgIH0KICAgIHBhcmVudC5jaGlsZHJlbi5zZXQoZ2V0UGF0aEZpbGVOYW1lKHBhdGhPYmplY3QpLCB7CiAgICAgIG5hbWU6IGdldFBhdGhGaWxlTmFtZShwYXRoT2JqZWN0KSwKICAgICAgY2hpbGRyZW46IHRoaXMuZ2V0UHJveHlNYXAocGF0aEJyb3dzZXJpZnkuZm9ybWF0KHBhdGhPYmplY3QpLCBbXSkKICAgIH0pOwogIH0KICByZWFkRGlyZWN0b3J5KHRhcmdldCkgewogICAgY29uc3QgcGF0aE9iamVjdCA9IHBhdGhCcm93c2VyaWZ5LnBhcnNlKHRhcmdldCk7CiAgICBjb25zdCBbcGFyZW50RXhpc3QsIHBhcmVudF0gPSB0aGlzLnBhdGhSZWR1Y2UocGF0aE9iamVjdC5kaXIpOwogICAgaWYgKCFwYXJlbnRFeGlzdCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFtmc10gZmFpbGVkIHRvIHJlYWQgZGlyZWN0b3J5ICR7dGFyZ2V0fSwgcGFyZW50IHBhdGggJHtwYXRoT2JqZWN0LmRpcn0gaXMgbm90IGV4aXN0ZWQuYCk7CiAgICB9CiAgICByZXR1cm4gcGFyZW50LmNoaWxkcmVuLmdldChnZXRQYXRoRmlsZU5hbWUocGF0aE9iamVjdCkpOwogIH0KICByZWFkRmlsZSh0YXJnZXQpIHsKICAgIGNvbnN0IFtleGlzdCwgZmlsZV0gPSB0aGlzLnBhdGhSZWR1Y2UodGFyZ2V0KTsKICAgIGlmICghZXhpc3QpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBbZnNdIGZhaWxlZCB0byByZWFkIGZpbGUgJHt0YXJnZXR9LCBpdCBpcyBub3QgZXhpc3RlZC5gKTsKICAgIH0KICAgIGlmIChSZWZsZWN0LmhhcyhmaWxlLCAiY2hpbGRyZW4iKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFtmc10gZmFpbGVkIHRvIHJlYWQgZmlsZSAke3RhcmdldH0sIGl0IGlzIGEgZGlyZWN0b3J5LmApOwogICAgfQogICAgcmV0dXJuIGZpbGU7CiAgfQogIHdyaXRlRmlsZSh0YXJnZXQsIGNvbnRlbnRzKSB7CiAgICBjb25zdCBwYXRoT2JqZWN0ID0gcGF0aEJyb3dzZXJpZnkucGFyc2UodGFyZ2V0KTsKICAgIGNvbnN0IFtwYXJlbnRFeGlzdCwgcGFyZW50XSA9IHRoaXMucGF0aFJlZHVjZShwYXRoT2JqZWN0LmRpcik7CiAgICBpZiAoIXBhcmVudEV4aXN0KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgW2ZzXSBmYWlsZWQgdG8gd3JpdGUgZmlsZSAke3RhcmdldH0sIHBhcmVudCBwYXRoICR7cGF0aE9iamVjdC5kaXJ9IGlzIG5vdCBleGlzdGVkLmApOwogICAgfQogICAgbGV0IHdyaXRlQ29udGVudCA9IGNvbnRlbnRzOwogICAgaWYgKHR5cGVvZiBjb250ZW50cyAhPT0gInN0cmluZyIpIHsKICAgICAgd3JpdGVDb250ZW50ID0gYnRvYShTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIG5ldyBVaW50OEFycmF5KGNvbnRlbnRzKSkpOwogICAgfQogICAgY29uc3QgZXhpc3RCZWZvcmUgPSBwYXJlbnQuY2hpbGRyZW4uaGFzKGdldFBhdGhGaWxlTmFtZShwYXRoT2JqZWN0KSk7CiAgICBwYXJlbnQuY2hpbGRyZW4uc2V0KGdldFBhdGhGaWxlTmFtZShwYXRoT2JqZWN0KSwgewogICAgICBuYW1lOiBnZXRQYXRoRmlsZU5hbWUocGF0aE9iamVjdCksCiAgICAgIGNvbnRlbnQ6IHdyaXRlQ29udGVudAogICAgfSk7CiAgICB0aGlzLmV2ZW50LnRyaWdnZXIoImZpbGVzLWNoYW5nZSIsIHRoaXMuZXZlbnRDb3VudCsrLCBleGlzdEJlZm9yZSA/ICJjaGFuZ2UiIDogIm5ldyIsIFt0YXJnZXRdKTsKICB9CiAgY3BPck12KGlzTXYgPSBmYWxzZSwgc291cmNlLCB0YXJnZXQpIHsKICAgIGNvbnN0IHNvdXJjZVBhdGhPYmplY3QgPSBwYXRoQnJvd3NlcmlmeS5wYXJzZShzb3VyY2UpOwogICAgY29uc3QgdGFyZ2V0UGF0aE9iamVjdCA9IHBhdGhCcm93c2VyaWZ5LnBhcnNlKHRhcmdldCk7CiAgICBjb25zdCBbc291cmNlUGFyZW50RXhpc3QsIHNvdXJjZVBhcmVudF0gPSB0aGlzLnBhdGhSZWR1Y2Uoc291cmNlUGF0aE9iamVjdC5kaXIpOwogICAgY29uc3QgW3RhcmdldFBhcmVudEV4aXN0LCB0YXJnZXRQYXJlbnRdID0gdGhpcy5wYXRoUmVkdWNlKHRhcmdldFBhdGhPYmplY3QuZGlyKTsKICAgIGlmICghc291cmNlUGFyZW50RXhpc3QgfHwgIXRhcmdldFBhcmVudEV4aXN0KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgW2ZzXSBmYWlsZWQgdG8gJHtpc012ID8gIm12IiA6ICJjcCJ9ICR7c291cmNlfSB0byAke3RhcmdldH0sIHNvdXJjZSBvciB0YXJnZXQgcGF0aCBpcyBub3QgZXhpc3RlZC5gKTsKICAgIH0KICAgIGlmICh0YXJnZXRQYXJlbnQuY2hpbGRyZW4uaGFzKGdldFBhdGhGaWxlTmFtZSh0YXJnZXRQYXRoT2JqZWN0KSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBbZnNdIGZhaWxlZCB0byAke2lzTXYgPyAibXYiIDogImNwIn0gJHtzb3VyY2V9IHRvICR7dGFyZ2V0fSwgdGFyZ2V0IHBhdGggaXMgYWxyZWFkeSBleGlzdGVkLmApOwogICAgfQogICAgdGFyZ2V0UGFyZW50LmNoaWxkcmVuLnNldChnZXRQYXRoRmlsZU5hbWUodGFyZ2V0UGF0aE9iamVjdCksIHNvdXJjZVBhcmVudC5jaGlsZHJlbi5nZXQoZ2V0UGF0aEZpbGVOYW1lKHNvdXJjZVBhdGhPYmplY3QpKSk7CiAgICBjb25zdCBzb3VyY2VGaWxlT3JEaXJlY3RvcnkgPSBzb3VyY2VQYXJlbnQuY2hpbGRyZW4uZ2V0KHNvdXJjZSk7CiAgICBjb25zdCBkZWxldGVkRmlsZXMgPSBbXTsKICAgIGNvbnN0IG5ld0ZpbGVzID0gW107CiAgICBpZiAoUmVmbGVjdC5oYXMoc291cmNlRmlsZU9yRGlyZWN0b3J5LCAiY29udGVudCIpKSB7CiAgICAgIGRlbGV0ZWRGaWxlcy5wdXNoKHNvdXJjZSk7CiAgICAgIG5ld0ZpbGVzLnB1c2godGFyZ2V0KTsKICAgIH0gZWxzZSB7CiAgICAgIHRyYXZlcnNlKHZvaWQgMCwgc291cmNlRmlsZU9yRGlyZWN0b3J5LCAocGF0aF8pID0+IHsKICAgICAgICBkZWxldGVkRmlsZXMucHVzaChwYXRoQnJvd3NlcmlmeS5qb2luKHNvdXJjZVBhdGhPYmplY3QuZGlyLCBwYXRoXykpOwogICAgICAgIG5ld0ZpbGVzLnB1c2gocGF0aEJyb3dzZXJpZnkuam9pbih0YXJnZXRQYXRoT2JqZWN0LmRpciwgcGF0aF8pKTsKICAgICAgfSk7CiAgICB9CiAgICBpZiAoaXNNdikgewogICAgICBzb3VyY2VQYXJlbnQuY2hpbGRyZW4uZGVsZXRlKGdldFBhdGhGaWxlTmFtZShzb3VyY2VQYXRoT2JqZWN0KSk7CiAgICAgIHRoaXMuZXZlbnQudHJpZ2dlcigiZmlsZXMtY2hhbmdlIiwgdGhpcy5ldmVudENvdW50KyssICJkZWxldGUiLCBkZWxldGVkRmlsZXMpOwogICAgfQogICAgdGhpcy5ldmVudC50cmlnZ2VyKCJmaWxlcy1jaGFuZ2UiLCB0aGlzLmV2ZW50Q291bnQrKywgIm5ldyIsIG5ld0ZpbGVzKTsKICB9CiAgcm0odGFyZ2V0KSB7CiAgICBjb25zdCBwYXRoT2JqZWN0ID0gcGF0aEJyb3dzZXJpZnkucGFyc2UodGFyZ2V0KTsKICAgIGNvbnN0IFtwYXJlbnRFeGlzdCwgcGFyZW50XSA9IHRoaXMucGF0aFJlZHVjZShwYXRoT2JqZWN0LmRpcik7CiAgICBpZiAoIXBhcmVudEV4aXN0IHx8ICFwYXJlbnQuY2hpbGRyZW4uaGFzKGdldFBhdGhGaWxlTmFtZShwYXRoT2JqZWN0KSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBbZnNdIGZhaWxlZCB0byBybSAke3RhcmdldH0sIGl0IGlzIG5vdCBleGlzdGVkLmApOwogICAgfQogICAgY29uc3QgdGFyZ2V0RmlsZU9yRGlyZWN0b3J5ID0gcGFyZW50LmNoaWxkcmVuLmdldCh0YXJnZXQpOwogICAgY29uc3QgZGVsZXRlZEZpbGVzID0gW107CiAgICBpZiAoUmVmbGVjdC5oYXModGFyZ2V0RmlsZU9yRGlyZWN0b3J5LCAiY29udGVudCIpKSB7CiAgICAgIGRlbGV0ZWRGaWxlcy5wdXNoKHRhcmdldCk7CiAgICB9IGVsc2UgewogICAgICB0cmF2ZXJzZSh2b2lkIDAsIHRhcmdldEZpbGVPckRpcmVjdG9yeSwgKHBhdGhfKSA9PiB7CiAgICAgICAgZGVsZXRlZEZpbGVzLnB1c2gocGF0aEJyb3dzZXJpZnkuam9pbihwYXRoT2JqZWN0LmRpciwgcGF0aF8pKTsKICAgICAgfSk7CiAgICB9CiAgICBwYXJlbnQuY2hpbGRyZW4uZGVsZXRlKGdldFBhdGhGaWxlTmFtZShwYXRoT2JqZWN0KSk7CiAgICB0aGlzLmV2ZW50LnRyaWdnZXIoImZpbGVzLWNoYW5nZSIsIHRoaXMuZXZlbnRDb3VudCsrLCAiZGVsZXRlIiwgZGVsZXRlZEZpbGVzKTsKICB9CiAgLyoqCiAgICog5bqP5YiX5YyW5YaF6YOo5a2Y5YKo55qE5omA5pyJ5pWw5o2uCiAgICovCiAgZ2V0RGF0YVBheWxvYWQoKSB7CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy5yb290LCAoa2V5LCB2YWx1ZSkgPT4gewogICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBNYXApIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgX19kYXRhVHlwZTogIk1hcCIsCiAgICAgICAgICBlbnRyaWVzOiBBcnJheS5mcm9tKHZhbHVlLmVudHJpZXMoKSkKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0pOwogIH0KICAvKioKICAgKiDop6blj5HlsIbmlofku7blr7nosaHlrZjlgqjnmoTmlbDmja7kvKDovpPliLDov5znq6/nmoTkuovku7YKICAgKi8KICB0cmFuc2ZlcigpIHsKICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmdldERhdGFQYXlsb2FkKCk7CiAgICB0aGlzLmV2ZW50LnRyaWdnZXIoInRyYW5zZmVyIiwgdGhpcy5ldmVudENvdW50KyssICIiLCBwYXlsb2FkKTsKICB9CiAgLyoqCiAgICog5o6l5pS25aSW6YOo6K6+572u55qE5pWw5o2uCiAgICogQHBhcmFtIHBheWxvYWQg5bqV5bGC5pWw5o2uCiAgICovCiAgcmVjZWl2ZShwYXlsb2FkKSB7CiAgICBjb25zdCB0cmF2ZXJzZTIgPSAob2JqLCBwYXRoMiA9ICIiKSA9PiB7CiAgICAgIGlmIChvYmouY2hpbGRyZW4gJiYgUmVmbGVjdC5nZXQob2JqLmNoaWxkcmVuLCAiX19kYXRhVHlwZSIpID09PSAiTWFwIikgewogICAgICAgIGNvbnN0IGVudHJpZXMgPSBvYmouY2hpbGRyZW4uZW50cmllcy5tYXAoKFtrZXksIHZhbHVlXSkgPT4gW2tleSwgdHJhdmVyc2UyKHZhbHVlLCBbcGF0aDIsIGtleV0uam9pbigiLyIpKV0pOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAuLi5vYmosCiAgICAgICAgICBjaGlsZHJlbjogdGhpcy5nZXRQcm94eU1hcChwYXRoMiwgZW50cmllcykKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiBvYmo7CiAgICB9OwogICAgY29uc3Qgcm9vdCA9IHRyYXZlcnNlMihKU09OLnBhcnNlKHBheWxvYWQpKTsKICAgIHRoaXMucm9vdCA9IHJvb3Q7CiAgICBjb25zb2xlLmxvZygidGhpcy5yb290Iiwgcm9vdCk7CiAgICB0aGlzLmV2ZW50LnRyaWdnZXIoInJlY2VpdmUiLCB0aGlzLmV2ZW50Q291bnQrKyk7CiAgfQp9CmNvbnN0IE5PVElGSUNBVElPTl9TRVJWSUNFID0gImlmcmFtZS1ub3RpZmljYXRpb24tc2VydmljZSI7CmNvbnN0IGlmcmFtZVJlYWR5ID0gYXN5bmMgKCkgPT4gewogIHJlZ2lzdGVyUHJveHkoTk9USUZJQ0FUSU9OX1NFUlZJQ0UsIHsKICAgIGlmcmFtZVJlYWR5OiBhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0pOwogIGNvbnN0IHBhcmVudCA9IHdpbmRvdy50b3AgfHwgd2luZG93LnBhcmVudCB8fCB3aW5kb3cub3BlbmVyOwogIGlmICghcGFyZW50KQogICAgcmV0dXJuOwogIHJldHVybiBjYWxsUHJveHkoewogICAgd2luOiBwYXJlbnQsCiAgICBzZXJ2aWNlSWQ6IE5PVElGSUNBVElPTl9TRVJWSUNFLAogICAgbWV0aG9kOiAiaWZyYW1lUmVhZHkiLAogICAgcGF5bG9hZDogW10KICB9KTsKfTsKY29uc3QgaWZyYW1lTG9hZGluZ01vZHVsZSA9IGFzeW5jIChtb2R1bGVOYW1lMiwgZXh0cmFJbmZvKSA9PiB7CiAgY29uc3QgcGFyZW50ID0gd2luZG93LnRvcCB8fCB3aW5kb3cucGFyZW50IHx8IHdpbmRvdy5vcGVuZXI7CiAgaWYgKCFwYXJlbnQpCiAgICByZXR1cm47CiAgcmV0dXJuIGNhbGxQcm94eSh7CiAgICB3aW46IHBhcmVudCwKICAgIHNlcnZpY2VJZDogTk9USUZJQ0FUSU9OX1NFUlZJQ0UsCiAgICBtZXRob2Q6ICJpZnJhbWVMb2FkaW5nTW9kdWxlIiwKICAgIHBheWxvYWQ6IFttb2R1bGVOYW1lMiwgZXh0cmFJbmZvXQogIH0pOwp9Owpjb25zdCBTeW5jU2VydmljZU5hbWUgPSAiY29kZS1zYW5kYm94LXN5bmMtZmlsZXMiOwphc3luYyBmdW5jdGlvbiBpbml0SWZyYW1lRmlsZXNTeW5jU2VydmljZShmczIpIHsKICBjb25zdCBjYWNoZVF1ZXVlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBsZXQgY3VycmVudENvdW50ID0gMDsKICBjb25zdCBkaXNwb3NlID0gcmVnaXN0ZXJQcm94eShTeW5jU2VydmljZU5hbWUsIHsKICAgIHN5bmM6IGFzeW5jIChldmVudFR5cGUsIG9yZGVyQ291bnQsIHBhdGgsIC4uLmFyZ3MpID0+IHsKICAgICAgY2FjaGVRdWV1ZS5zZXQob3JkZXJDb3VudCwgW2V2ZW50VHlwZSwgcGF0aCwgLi4uYXJnc10pOwogICAgICB3aGlsZSAoY2FjaGVRdWV1ZS5nZXQoY3VycmVudENvdW50KSkgewogICAgICAgIGNvbnN0IFtldmVudFR5cGUyLCBwYXRoMiwgLi4uYXJnczJdID0gY2FjaGVRdWV1ZS5nZXQoY3VycmVudENvdW50KTsKICAgICAgICBjYWNoZVF1ZXVlLmRlbGV0ZShjdXJyZW50Q291bnQpOwogICAgICAgIGN1cnJlbnRDb3VudCsrOwogICAgICAgIGNvbnN0IFssIGRpcl9dID0gZnMyLnBhdGhSZWR1Y2UocGF0aDIpOwogICAgICAgIGNvbnN0IGRpciA9IGRpcl87CiAgICAgICAgc3dpdGNoIChldmVudFR5cGUyKSB7CiAgICAgICAgICBjYXNlICJ0cmFuc2ZlciI6IHsKICAgICAgICAgICAgZnMyLnJlY2VpdmUuYXBwbHkoZnMyLCBhcmdzMik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAiZGlyLWNsZWFyIjogewogICAgICAgICAgICBkaXIuY2hpbGRyZW4uY2xlYXIoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJkaXItc2V0IjogewogICAgICAgICAgICBkaXIuY2hpbGRyZW4uc2V0LmFwcGx5KGRpci5jaGlsZHJlbiwgYXJnczIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgImRpci1kZWxldGUiOiB7CiAgICAgICAgICAgIGRpci5jaGlsZHJlbi5kZWxldGUuYXBwbHkoZGlyLmNoaWxkcmVuLCBhcmdzMik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAiZmlsZXMtY2hhbmdlIjogewogICAgICAgICAgICBmczIuZXZlbnQudHJpZ2dlcihldmVudFR5cGUyLCBwYXRoMiwgLi4uYXJnczIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICBjb25zdCBwYXlsb2FkID0gYXdhaXQgY2FsbFByb3h5KHsKICAgIHdpbjogc2VsZi5wYXJlbnQgfHwgc2VsZi5vcGVuZXIgfHwgc2VsZi50b3AsCiAgICBtZXRob2Q6ICJyZXF1ZXN0RnMiLAogICAgc2VydmljZUlkOiBTeW5jU2VydmljZU5hbWUsCiAgICBwYXlsb2FkOiBbXQogIH0pOwogIGlmIChwYXlsb2FkKSB7CiAgICBmczIucmVjZWl2ZShwYXlsb2FkKTsKICAgIGNvbnNvbGUubG9nKCJyZWNlaXZlIiwgcGF5bG9hZCwgZnMyKTsKICAgIHJldHVybjsKICB9CiAgcmV0dXJuIGRpc3Bvc2U7Cn0KY29uc3QgRGVtb1NlcnZpY2VOYW1lID0gImRlbW8tc2VydmljZSI7CmZ1bmN0aW9uIGdlbmVyYXRlUGx1Z2lucyhwbHVnaW5zU2VydmljZUlkKSB7CiAgY29uc3QgcGFyZW50ID0gd2luZG93LnBhcmVudCB8fCB3aW5kb3cudG9wIHx8IHdpbmRvdy5vcGVuZXI7CiAgY29uc3QgZ2VuZXJhdGVNZXRob2QgPSAoa2V5LCBzZXJ2aWNlSWQpID0+IGFzeW5jICguLi5hcmdzKSA9PiB7CiAgICBhd2FpdCB3YWl0UHJveHkocGFyZW50LCBzZXJ2aWNlSWQpOwogICAgcmV0dXJuIGF3YWl0IGNhbGxQcm94eSh7CiAgICAgIHdpbjogcGFyZW50LAogICAgICBzZXJ2aWNlSWQsCiAgICAgIG1ldGhvZDoga2V5LAogICAgICBwYXlsb2FkOiBhcmdzCiAgICB9KTsKICB9OwogIHJldHVybiBwbHVnaW5zU2VydmljZUlkLm1hcCgoc2VydmljZUlkKSA9PiB7CiAgICBjb25zdCBrZXlzID0gWyJyZXF1aXJlIiwgImJlZm9yZU1vZHVsZUdlbmVyYXRlIiwgInJlc29sdmVNb2R1bGVVcmwiXTsKICAgIHJldHVybiBrZXlzLnJlZHVjZSgocHJlLCBrZXkpID0+IHsKICAgICAgcmV0dXJuIHsKICAgICAgICAuLi5wcmUsCiAgICAgICAgW2tleV06IGdlbmVyYXRlTWV0aG9kKGtleSwgc2VydmljZUlkKQogICAgICB9OwogICAgfSwge30pOwogIH0pOwp9CmNsYXNzIERlcHNHcmFwaCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLkRlcE5vZGVJbmRleGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICB9CiAgZ2V0RGVwTm9kZShfdGFyZ2V0LCBjcmVhdGUgPSBmYWxzZSkgewogICAgY29uc3QgdGFyZ2V0ID0gX3RhcmdldC5yZXBsYWNlKC9cLyQvLCAiIik7CiAgICBpZiAoIXRoaXMuRGVwTm9kZUluZGV4ZXMuaGFzKHRhcmdldCkgJiYgY3JlYXRlKSB7CiAgICAgIHRoaXMuRGVwTm9kZUluZGV4ZXMuc2V0KHRhcmdldCwgewogICAgICAgIHBhdGg6IHRhcmdldCwKICAgICAgICBjb21lOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLAogICAgICAgIG91dDogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB0aGlzLkRlcE5vZGVJbmRleGVzLmdldCh0YXJnZXQpOwogIH0KICAvKioKICAgKiDmm7TmlrAgZnJvbSAtPiB0byDnmoTot6/lvoQKICAgKiBAcGFyYW0gZnJvbSDotbfngrkgbm9kZSDmlbDnu4QKICAgKiBAcGFyYW0gdG8g57uI54K5IG5vZGUKICAgKi8KICB1cGRhdGVQYXRocyhmcm9tLCB0bykgewogICAgY29uc3QgdGFyZ2V0Tm9kZSA9IHRoaXMuZ2V0RGVwTm9kZSh0bywgdHJ1ZSk7CiAgICBpZiAodGFyZ2V0Tm9kZS5jb21lLnNpemUpIHsKICAgICAgdGFyZ2V0Tm9kZS5jb21lLmZvckVhY2goKGRlcE5vZGUpID0+IHsKICAgICAgICBkZXBOb2RlLm91dC5kZWxldGUodGFyZ2V0Tm9kZSk7CiAgICAgIH0pOwogICAgICB0YXJnZXROb2RlLmNvbWUuY2xlYXIoKTsKICAgIH0KICAgIGZyb20uZm9yRWFjaCgobm9kZVBhdGgpID0+IHsKICAgICAgY29uc3QgZGVwTm9kZSA9IHRoaXMuZ2V0RGVwTm9kZShub2RlUGF0aCwgdHJ1ZSk7CiAgICAgIHRhcmdldE5vZGUuY29tZS5hZGQoZGVwTm9kZSk7CiAgICAgIGRlcE5vZGUub3V0LmFkZCh0YXJnZXROb2RlKTsKICAgIH0pOwogIH0KICAvKioKICAgKiDliKDpmaQgZnJvbSAtPiB0byDnmoTot6/lvoQKICAgKiBAcGFyYW0gZnJvbSDotbfngrkgbm9kZSDmlbDnu4QKICAgKiBAcGFyYW0gdG8g57uI54K5IG5vZGUKICAgKi8KICBkZWxldGVQYXRocyhmcm9tLCB0bykgewogICAgY29uc3QgdGFyZ2V0Tm9kZSA9IHRoaXMuZ2V0RGVwTm9kZSh0byk7CiAgICBpZiAoIXRhcmdldE5vZGUpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIGZyb20uZm9yRWFjaCgoc291cmNlUGF0aCkgPT4gewogICAgICBjb25zdCBzb3VyY2VOb2RlID0gdGhpcy5nZXREZXBOb2RlKHNvdXJjZVBhdGgpOwogICAgICBpZiAoIXNvdXJjZU5vZGUpCiAgICAgICAgcmV0dXJuOwogICAgICBzb3VyY2VOb2RlLm91dC5kZWxldGUodGFyZ2V0Tm9kZSk7CiAgICAgIHRhcmdldE5vZGUuY29tZS5kZWxldGUoc291cmNlTm9kZSk7CiAgICAgIHRoaXMuZGVsZXRlTm9kZShzb3VyY2VOb2RlLnBhdGgpOwogICAgfSk7CiAgfQogIC8qKgogICAqIOWIoOmZpOaMh+WumueahOS+nei1luiKgueCuQogICAqIEBwYXJhbSBzb3VyY2UKICAgKi8KICBkZWxldGVOb2RlKHNvdXJjZSkgewogICAgY29uc3Qgc291cmNlTm9kZSA9IHRoaXMuZ2V0RGVwTm9kZShzb3VyY2UpOwogICAgaWYgKCFzb3VyY2VOb2RlKQogICAgICByZXR1cm4gZmFsc2U7CiAgICB0aGlzLkRlcE5vZGVJbmRleGVzLmRlbGV0ZShzb3VyY2UpOwogICAgaWYgKHNvdXJjZU5vZGUuY29tZS5zaXplKSB7CiAgICAgIHNvdXJjZU5vZGUuY29tZS5mb3JFYWNoKChjb21lTm9kZSkgPT4gewogICAgICAgIGNvbWVOb2RlLm91dC5kZWxldGUoc291cmNlTm9kZSk7CiAgICAgICAgaWYgKCFjb21lTm9kZS5vdXQuc2l6ZSkgewogICAgICAgICAgdGhpcy5kZWxldGVOb2RlKGNvbWVOb2RlLnBhdGgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgLyoqCiAgICog6YGN5Y6G5omA5pyJ55u05o6l5oiW6ICF6Ze05o6l5L6d6LWWIHNvdXJjZSDnmoToioLngrkKICAgKiBAcGFyYW0gc291cmNlIOimgemBjeWOhueahOiKgueCuQogICAqIEBwYXJhbSBjYiDlr7nmr4/kuKroioLngrnnmoTlpITnkIYKICAgKiBAcGFyYW0gdHJhY2tlZCDnlKjkuo7lrZjlgqjpgY3ljobov4fnmoToioLngrkKICAgKiBAcGFyYW0gd2FpdCDnlKjkuo7lrZjlgqjpnIDopoHpgY3ljobnmoToioLngrkKICAgKiBAcGFyYW0gb3JkZXIg5piv5ZCm5oyJ54Wn6aG65bqP5byA5aeL6YGN5Y6GCiAgICovCiAgdHJhdmVyc2Uoc291cmNlLCBjYiwgdHJhY2tlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksIHdhaXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLCBvcmRlciA9IHRydWUpIHsKICAgIGNvbnN0IGlzQWxsRGVwc1RyYWNrZWQgPSAobm9kZSkgPT4gQXJyYXkuZnJvbShub2RlLmNvbWUpLmV2ZXJ5KChkZXApID0+ICF3YWl0LmhhcyhkZXAucGF0aCkgfHwgdHJhY2tlZC5oYXMoZGVwLnBhdGgpKTsKICAgIGNvbnN0IHRyYXZlcnNlMiA9IChub2RlLCBvcmRlcjIgPSBmYWxzZSwgY2JfKSA9PiB7CiAgICAgIGlmICghb3JkZXIyKSB7CiAgICAgICAgd2FpdC5hZGQobm9kZS5wYXRoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIWlzQWxsRGVwc1RyYWNrZWQobm9kZSkpCiAgICAgICAgICByZXR1cm47CiAgICAgICAgdHJhY2tlZC5hZGQobm9kZS5wYXRoKTsKICAgICAgICBjYl8gPT0gbnVsbCA/IHZvaWQgMCA6IGNiXyhub2RlLCB0cmFja2VkLnNpemUsIHdhaXQuc2l6ZSk7CiAgICAgIH0KICAgICAgbm9kZS5vdXQuZm9yRWFjaCgoY2hpbGQpID0+IHsKICAgICAgICBpZiAoIW9yZGVyMiB8fCBpc0FsbERlcHNUcmFja2VkKGNoaWxkKSkgewogICAgICAgICAgdHJhdmVyc2UyKGNoaWxkLCBvcmRlcjIsIGNiXyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgICBjb25zdCBzb3VyY2VOb2RlID0gdGhpcy5nZXREZXBOb2RlKHNvdXJjZSk7CiAgICBpZiAoIXNvdXJjZU5vZGUpCiAgICAgIHJldHVybjsKICAgIHRyYXZlcnNlMihzb3VyY2VOb2RlLCBmYWxzZSwgY2IpOwogICAgaWYgKG9yZGVyKSB7CiAgICAgIHRyYXZlcnNlMihzb3VyY2VOb2RlLCB0cnVlLCBjYik7CiAgICB9CiAgfQogIC8qKgogICAqIOaJuemHj+mBjeWOhuebtOaOpeaIluiAhemXtOaOpSBzb3VyY2VzIOiKgueCueeahOaJgOacieiKgueCuQogICAqIEBwYXJhbSBzb3VyY2VzIOiiq+S+nei1lueahOiKgueCueaVsOe7hAogICAqIEBwYXJhbSBjYiDlr7nmr4/kuKroioLngrnnmoTlpITnkIYKICAgKi8KICBiYXRjaFRyYXZlcnNlKHNvdXJjZXMsIGNiKSB7CiAgICBjb25zdCB0cmFja2VkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGNvbnN0IHdhaXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgc291cmNlcy5mb3JFYWNoKChzb3VyY2UpID0+IHsKICAgICAgdGhpcy50cmF2ZXJzZShzb3VyY2UsIGNiLCB0cmFja2VkLCB3YWl0LCBmYWxzZSk7CiAgICB9KTsKICAgIHNvdXJjZXMuZm9yRWFjaCgoc291cmNlKSA9PiB7CiAgICAgIHRoaXMudHJhdmVyc2Uoc291cmNlLCBjYiwgdHJhY2tlZCwgd2FpdCwgdHJ1ZSk7CiAgICB9KTsKICAgIHJldHVybiBBcnJheS5mcm9tKHRyYWNrZWQpOwogIH0KfQpjb25zdCBmcyA9IG5ldyBGaWxlc1N5c3RlbSgpOwpjb25zdCBmc1N5bmNQcm9taXNlID0gaW5pdElmcmFtZUZpbGVzU3luY1NlcnZpY2UoZnMpOwpjb25zdCBkZXBzR3JhcGggPSBuZXcgRGVwc0dyYXBoKCk7CmNvbnN0IG1hbmFnZXIgPSBjcmVhdGVBbWRNYW5hZ2VyKGZzLCB2b2lkIDAsIHZvaWQgMCwgbG9nZ2VyKTsKbWFuYWdlci5tb3VudFRvR2xvYmFsKCk7CmNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7Cm1hbmFnZXIub25Nb2R1bGVMb2FkaW5nKGlmcmFtZUxvYWRpbmdNb2R1bGUpOwptYW5hZ2VyLm9uTW9kdWxlRGVwcyhkZXBzR3JhcGgudXBkYXRlUGF0aHMuYmluZChkZXBzR3JhcGgpKTsKZnMuZXZlbnQubGlzdGVuKCJmaWxlcy1jaGFuZ2UiLCBhc3luYyAodHlwZSwgZmlsZXMpID0+IHsKICBpZiAodHlwZSA9PT0gRmlsZXNDaGFuZ2VUeXBlLkNoYW5nZSkgewogICAgY29uc29sZS5sb2coImZpbGVzIGNoYW5nZSIsIGZpbGVzKTsKICAgIGRlcHNHcmFwaC5iYXRjaFRyYXZlcnNlKGZpbGVzLCAobm9kZSkgPT4gewogICAgICBjb25zb2xlLmxvZygidXBkYXRlIGRlcCIsIG5vZGUucGF0aCk7CiAgICAgIG1hbmFnZXIucmVxdWlyZV8uZmFjdG9yaWVzLmRlbGV0ZShub2RlLnBhdGgpOwogICAgICBtYW5hZ2VyLnJlcXVpcmVfLmNhY2hlLmRlbGV0ZShub2RlLnBhdGgpOwogICAgICBpZiAobm9kZS5vdXQuc2l6ZSkgewogICAgICAgIG1hbmFnZXIucmVxdWlyZV8obm9kZS5wYXRoKTsKICAgICAgfQogICAgfSk7CiAgfQp9KTsKcmVnaXN0ZXJQcm94eShEZW1vU2VydmljZU5hbWUsIHsKICBydW46IGFzeW5jIChqc0VudHJ5LCBodG1sRW50cnksIHN0eWxlc0VudHJ5KSA9PiB7CiAgICBhd2FpdCBmc1N5bmNQcm9taXNlOwogICAgaWYgKHR5cGVvZiBodG1sRW50cnkgPT09ICJzdHJpbmciKSB7CiAgICAgIGNvbnN0IFtodG1sRXhpc3QsIGh0bWxdID0gZnMucGF0aFJlZHVjZShodG1sRW50cnkpOwogICAgICBpZiAoIWh0bWxFeGlzdCkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gaHRtbC5jb250ZW50OwogICAgfQogICAgaWYgKHR5cGVvZiBzdHlsZXNFbnRyeSA9PT0gInN0cmluZyIpIHsKICAgICAgY29uc3QgW3N0eWxlc0V4aXN0LCBzdHlsZXNdID0gZnMucGF0aFJlZHVjZShzdHlsZXNFbnRyeSk7CiAgICAgIGlmICghc3R5bGVzRXhpc3QpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICBzdHlsZS5pbm5lckhUTUwgPSBzdHlsZXMuY29udGVudDsKICAgIH0KICAgIGlmICh0eXBlb2YganNFbnRyeSA9PT0gInN0cmluZyIpIHsKICAgICAgY29uc3QgW2pzRXhpc3RdID0gZnMucGF0aFJlZHVjZShqc0VudHJ5KTsKICAgICAgaWYgKCFqc0V4aXN0KQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgYXdhaXQgbWFuYWdlci5yZXF1aXJlXyhqc0VudHJ5KTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgc2V0UGx1Z2luczogYXN5bmMgKHBsdWdpbklkcykgPT4gewogICAgY29uc3QgcGx1Z2lucyA9IGdlbmVyYXRlUGx1Z2lucyhwbHVnaW5JZHMpOwogICAgbWFuYWdlci5zZXRQbHVnaW5zKHBsdWdpbnMpOwogIH0KfSk7CndpbmRvdy5vbmVycm9yID0gKGVycikgPT4gewogIGNvbnNvbGUuZXJyb3IoZXJyKTsKfTsKaWZyYW1lUmVhZHkoKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9aWZyYW1lLmpzLm1hcAo=";
const iframeStyles_ = ".code-sandbox-iframe {\n    border-width: 0;\n    width: 100%;\n    height: 100%;\n}\n";
const getIframeHTML = () => {
  const srcDoc = `<html lang="en">
    <head>
        <title>Demo Sandbox</title>
        <script type="module" src="${iframeScriptUrl}"><\/script>
    </head>
    <body></body>
</html>`;
  return [srcDoc];
};
const iframeStyles = iframeStyles_;
const JSEntry = "/index.js";
const StylesEntry = "/styles.css";
const HTMLEntry = "/index.html";
const getSandboxRefresher = (opt) => {
  const iframe = opt.iframe;
  return async (payload = [JSEntry, HTMLEntry, StylesEntry]) => {
    if (!iframe)
      return;
    await waitIframeReady(iframe);
    await waitProxy(iframe.contentWindow, DemoServiceName);
    await callProxy({
      win: iframe.contentWindow,
      serviceId: DemoServiceName,
      method: "run",
      payload
    });
  };
};
const setSandboxPlugins = async (iframe, pluginsId2) => {
  await waitIframeReady(iframe);
  await waitProxy(iframe.contentWindow, DemoServiceName);
  return await callProxy({
    win: iframe.contentWindow,
    serviceId: DemoServiceName,
    method: "setPlugins",
    payload: [pluginsId2]
  });
};
const DefaultDemoFileName = "/Demo.js";
const DefaultDemoCode = `// require function is asynchronous !
const React = await require('react');

// if you register \`EsmToAmdPlugin\`, following statements will be support
// import React from 'react';

const App = () => {
    // if you register \`JsxPlugin\`, jsx can be used.
    // return <div>hello world</div>;
    return (
        React.createElement(
            'div',
            {},
            React.createElement(
                'div',
                {
                    className: 'title'
                },
                'DemoSandbox'
            ),
            'welcome to use code sandbox'
        )
    );
};

module.exports.default = App
// if you register \`EsmToAmdPlugin\`, following statements will be support
// export default App;`;
const DefaultIndexCode = `const React = await require('react');
const ReactDom = await require('react-dom');
const App = (await require('./Demo.js')).default;

// if you register \`EsmToAmdPlugin\`, following statements will be support
// import React from 'react';
// import ReactDom from 'react-dom';
// import App from './App';

ReactDom.render(React.createElement(App, {}), document.getElementById('root'));`;
const DefaultHtml = `<noscript>Need javascript to run this demo page.</noscript>
<div id="root">
    <h3>  Welcome to use code sandbox. </h3>
</div>`;
const DefaultCssCode = `.title { color: blue }`;
const _default = /* @__PURE__ */ Object.freeze(/* @__PURE__ */ Object.defineProperty({
  __proto__: null,
  DefaultCssCode,
  DefaultDemoCode,
  DefaultDemoFileName,
  DefaultHtml,
  DefaultIndexCode
}, Symbol.toStringTag, { value: "Module" }));
let pluginsId = [];
class DefaultPlugin extends BasePlugin {
  constructor() {
    super();
    this.pluginId = "default-plugin";
  }
  async resolveModuleUrl(meta) {
    const { packageName, version, file } = meta;
    const versionSuffix = version ? `@${version}` : "";
    const fileSuffix = file ? `${file}` : "";
    return `https://unpkg.com/${packageName}${versionSuffix}${fileSuffix}`;
  }
  async beforeModuleGenerate(ctx, meta) {
    meta.factory = `async (require, exports, module) => {
${meta.factory}
}`;
    meta.deps = ["require", "exports", "module"];
    return meta;
  }
}
const registerPlugins = (_plugins) => {
  const plugins = _plugins.concat(new DefaultPlugin());
  plugins.forEach((plugin) => {
    registerProxy(plugin.pluginId, plugin);
  });
  pluginsId = plugins.map((plugin) => plugin.pluginId);
  return pluginsId;
};
const getPlugins = () => {
  return pluginsId;
};
const getPathFileName = (pathObject) => `${pathObject.name}${pathObject.ext}`;
const traverse = (dir = "", directory, cb) => {
  directory.children.forEach((item) => {
    if (Reflect.has(item, "children")) {
      traverse(`${pathBrowserify}/${item.name}`, item, cb);
      return;
    }
    cb(`${pathBrowserify}/${item.name}`, item);
  });
};
class FilesSystem {
  constructor() {
    this.root = {
      name: "",
      children: this.getProxyMap("", [])
    };
    this.eventCount = 0;
    this.event = createEventSubscribeManager();
    this.cp = this.cpOrMv.bind(this, false);
    this.mv = this.cpOrMv.bind(this, true);
  }
  getProxyMap(path2, entries) {
    const _this = this;
    const map = new Map(entries);
    const proxyMethod = (methodName, eventName) => {
      const _method = Reflect.get(map, methodName);
      if (typeof _method === "function") {
        const method = function(...args) {
          _this.event.trigger(eventName, _this.eventCount++, path2, ...args);
          return _method.call(map, ...args);
        };
        Reflect.set(map, methodName, method);
      }
    };
    proxyMethod("set", "dir-set");
    proxyMethod("delete", "dir-delete");
    proxyMethod("clear", "dir-clear");
    return map;
  }
  pathReduce(target) {
    const paths = target.split(pathBrowserify.sep);
    return paths.reduce(([status, dir], cur, index, arr) => {
      var _a, _b;
      if (index === 0) {
        return [status, dir];
      }
      if (index === arr.length - 1 && cur === "") {
        return [status, dir];
      }
      return [status && ((_a = dir.children) == null ? void 0 : _a.has(cur)), (_b = dir.children) == null ? void 0 : _b.get(cur)];
    }, [true, this.root]);
  }
  exist(target) {
    const [exist] = this.pathReduce(target);
    return exist;
  }
  mkdir(target) {
    const pathObject = pathBrowserify.parse(target);
    if (this.exist(target)) {
      throw new Error(`[fs] failed to mkdir ${target}, it is already existed.`);
    }
    const [parentExist, parent] = this.pathReduce(pathObject.dir);
    if (!parentExist) {
      throw new Error(`[fs] failed to mkdir ${target}, parent path ${pathObject.dir} is not existed.`);
    }
    if (!Reflect.has(parent, "children") || Reflect.has(parent, "content")) {
      throw new Error(`[fs] failed to mkdir ${target}, parent path ${pathObject.dir} is not a directory.`);
    }
    parent.children.set(getPathFileName(pathObject), {
      name: getPathFileName(pathObject),
      children: this.getProxyMap(pathBrowserify.format(pathObject), [])
    });
  }
  readDirectory(target) {
    const pathObject = pathBrowserify.parse(target);
    const [parentExist, parent] = this.pathReduce(pathObject.dir);
    if (!parentExist) {
      throw new Error(`[fs] failed to read directory ${target}, parent path ${pathObject.dir} is not existed.`);
    }
    return parent.children.get(getPathFileName(pathObject));
  }
  readFile(target) {
    const [exist, file] = this.pathReduce(target);
    if (!exist) {
      throw new Error(`[fs] failed to read file ${target}, it is not existed.`);
    }
    if (Reflect.has(file, "children")) {
      throw new Error(`[fs] failed to read file ${target}, it is a directory.`);
    }
    return file;
  }
  writeFile(target, contents) {
    const pathObject = pathBrowserify.parse(target);
    const [parentExist, parent] = this.pathReduce(pathObject.dir);
    if (!parentExist) {
      throw new Error(`[fs] failed to write file ${target}, parent path ${pathObject.dir} is not existed.`);
    }
    let writeContent = contents;
    if (typeof contents !== "string") {
      writeContent = btoa(String.fromCharCode.apply(null, new Uint8Array(contents)));
    }
    const existBefore = parent.children.has(getPathFileName(pathObject));
    parent.children.set(getPathFileName(pathObject), {
      name: getPathFileName(pathObject),
      content: writeContent
    });
    this.event.trigger("files-change", this.eventCount++, existBefore ? "change" : "new", [target]);
  }
  cpOrMv(isMv = false, source, target) {
    const sourcePathObject = pathBrowserify.parse(source);
    const targetPathObject = pathBrowserify.parse(target);
    const [sourceParentExist, sourceParent] = this.pathReduce(sourcePathObject.dir);
    const [targetParentExist, targetParent] = this.pathReduce(targetPathObject.dir);
    if (!sourceParentExist || !targetParentExist) {
      throw new Error(`[fs] failed to ${isMv ? "mv" : "cp"} ${source} to ${target}, source or target path is not existed.`);
    }
    if (targetParent.children.has(getPathFileName(targetPathObject))) {
      throw new Error(`[fs] failed to ${isMv ? "mv" : "cp"} ${source} to ${target}, target path is already existed.`);
    }
    targetParent.children.set(getPathFileName(targetPathObject), sourceParent.children.get(getPathFileName(sourcePathObject)));
    const sourceFileOrDirectory = sourceParent.children.get(source);
    const deletedFiles = [];
    const newFiles = [];
    if (Reflect.has(sourceFileOrDirectory, "content")) {
      deletedFiles.push(source);
      newFiles.push(target);
    } else {
      traverse(void 0, sourceFileOrDirectory, (path_) => {
        deletedFiles.push(pathBrowserify.join(sourcePathObject.dir, path_));
        newFiles.push(pathBrowserify.join(targetPathObject.dir, path_));
      });
    }
    if (isMv) {
      sourceParent.children.delete(getPathFileName(sourcePathObject));
      this.event.trigger("files-change", this.eventCount++, "delete", deletedFiles);
    }
    this.event.trigger("files-change", this.eventCount++, "new", newFiles);
  }
  rm(target) {
    const pathObject = pathBrowserify.parse(target);
    const [parentExist, parent] = this.pathReduce(pathObject.dir);
    if (!parentExist || !parent.children.has(getPathFileName(pathObject))) {
      throw new Error(`[fs] failed to rm ${target}, it is not existed.`);
    }
    const targetFileOrDirectory = parent.children.get(target);
    const deletedFiles = [];
    if (Reflect.has(targetFileOrDirectory, "content")) {
      deletedFiles.push(target);
    } else {
      traverse(void 0, targetFileOrDirectory, (path_) => {
        deletedFiles.push(pathBrowserify.join(pathObject.dir, path_));
      });
    }
    parent.children.delete(getPathFileName(pathObject));
    this.event.trigger("files-change", this.eventCount++, "delete", deletedFiles);
  }
  /**
   * 
   */
  getDataPayload() {
    return JSON.stringify(this.root, (key, value) => {
      if (value instanceof Map) {
        return {
          __dataType: "Map",
          entries: Array.from(value.entries())
        };
      }
      return value;
    });
  }
  /**
   * 
   */
  transfer() {
    const payload = this.getDataPayload();
    this.event.trigger("transfer", this.eventCount++, "", payload);
  }
  /**
   * 
   * @param payload 
   */
  receive(payload) {
    const traverse2 = (obj, path2 = "") => {
      if (obj.children && Reflect.get(obj.children, "__dataType") === "Map") {
        const entries = obj.children.entries.map(([key, value]) => [key, traverse2(value, [path2, key].join("/"))]);
        return {
          ...obj,
          children: this.getProxyMap(path2, entries)
        };
      }
      return obj;
    };
    const root = traverse2(JSON.parse(payload));
    this.root = root;
    console.log("this.root", root);
    this.event.trigger("receive", this.eventCount++);
  }
}
const SyncServiceName = "code-sandbox-sync-files";
function initMainFilesSyncCaller(fs, iframe) {
  const onEvent = (eventType) => {
    return fs.event.listen(eventType, async (...args) => {
      await waitIframeReady(iframe);
      await waitProxy(iframe.contentWindow, SyncServiceName);
      await callProxy({
        win: iframe.contentWindow,
        serviceId: SyncServiceName,
        method: "sync",
        payload: [eventType, ...args]
      });
    });
  };
  const disposes = [];
  disposes.push(onEvent("transfer"));
  disposes.push(onEvent("dir-delete"));
  disposes.push(onEvent("dir-set"));
  disposes.push(onEvent("dir-clear"));
  disposes.push(onEvent("files-change"));
  disposes.push(registerProxy(SyncServiceName, {
    requestFs: async () => {
      return fs.getDataPayload();
    }
  }));
  return () => {
    disposes.forEach((dispose) => dispose());
  };
}
const defaultCodes = {
  html: [HTMLEntry, DefaultHtml],
  code: [DefaultDemoFileName, DefaultDemoCode],
  index: [JSEntry, DefaultIndexCode],
  css: [StylesEntry, DefaultCssCode]
};
class CodeSandbox extends HTMLElement {
  constructor() {
    super();
    this.fs = new FilesSystem();
    this.fsSyncServiceDispose = null;
    this.mainThreadServiceDispose = null;
    this.root = null;
    this.root = this.attachShadow({ mode: "open" });
    this.initIframe();
  }
  addEventListener(type, listener, options) {
    super.addEventListener(type, listener, options);
  }
  removeEventListener(type, listener, options) {
    super.removeEventListener(type, listener, options);
  }
  initIframe() {
    var _a, _b;
    if (this.iframe) {
      this.root.removeChild(this.iframe);
    }
    (_a = this.fsSyncServiceDispose) == null ? void 0 : _a.call(this);
    (_b = this.mainThreadServiceDispose) == null ? void 0 : _b.call(this);
    this.mainThreadServiceDispose = initMainThreadService();
    const [srcDoc] = getIframeHTML();
    this.iframe = document.createElement("iframe");
    this.iframe.srcdoc = srcDoc;
    this.iframe.setAttribute("title", this.iframe.getAttribute("title"));
    this.iframe.setAttribute("sandbox", "allow-scripts");
    this.iframe.setAttribute("class", `code-sandbox-iframe ${this.getAttribute("class") || ""}`);
    this.iframe.setAttribute("style", this.getAttribute("style"));
    onIframeLoadingModule(this.iframe, (moduleName, extraInfo) => {
      this.dispatchEvent(new CustomEvent("loading-module", {
        detail: {
          moduleName,
          url: extraInfo
        }
      }));
    });
    this.styleElement = document.createElement("style");
    this.styleElement.innerHTML = iframeStyles;
    this.root.append(this.styleElement, this.iframe);
    this.fsSyncServiceDispose = initMainFilesSyncCaller(this.fs, this.iframe);
    setSandboxPlugins(this.iframe, getPlugins());
    this.writeFile("html");
    this.writeFile("css");
    this.writeFile("code");
    this.writeFile("index");
  }
  static get observedAttributes() {
    return ["code", "css", "index", "html", "class", "style"];
  }
  async execute(files) {
    await getSandboxRefresher({ iframe: this.iframe })(files);
    this.dispatchEvent(new CustomEvent("ready"));
  }
  async attributeChangedCallback(name, oldValue, newValue) {
    if (["html", "code", "index", "css"].includes(name)) {
      await waitIframeReady(this.iframe);
      await this.writeFile(name, newValue);
      const files = [null, null, null];
      if (name === "index")
        files[0] = defaultCodes[name][0];
      if (name === "html")
        files[1] = defaultCodes[name][0];
      if (name === "css")
        files[2] = defaultCodes[name][0];
      await this.execute(files);
    } else {
      this.iframe.setAttribute(name, newValue);
    }
  }
  async refresh() {
    this.initIframe();
    await waitIframeReady(this.iframe);
    return this.execute();
  }
  async writeFile(name, value) {
    await waitIframeReady(this.iframe);
    const [fileName, defaultCode] = defaultCodes[name];
    this.fs.writeFile(fileName, value || this.getAttribute(name) || defaultCode);
  }
}
export {
  CodeSandbox,
  _default as DefaultCodes,
  registerPlugins
};
//# sourceMappingURL=webcomponent.js.map

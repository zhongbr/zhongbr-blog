import { createEventSubscribeManager } from "./core/event/index.js";
import { registerProxy, callProxy, waitProxy } from "./core/proxy/index.js";
import { B as BasePlugin } from "./types-9fd137f3.js";
import { p as pathBrowserify } from "./index-a3b3cc38.js";
const NOTIFICATION_SERVICE = "iframe-notification-service";
const emitter = createEventSubscribeManager();
const initMainThreadService = () => {
  const service = {
    iframeReady: async (e) => {
      emitter.trigger("iframeReady", e);
      return true;
    },
    iframeLoadingModule: async (moduleName, moduleUrl, e) => {
      emitter.trigger("iframeLoadingModule", moduleName, moduleUrl, e);
    }
  };
  return registerProxy(NOTIFICATION_SERVICE, service);
};
const waitIframeReady = async (iframe, timeout = 1e4) => {
  const listenTask = new Promise((resolve, reject) => {
    if (iframe.getAttribute("data-iframe-status") !== "ready") {
      emitter.once(
        "iframeReady",
        (...args) => {
          iframe.setAttribute("data-iframe-status", "ready");
          resolve(null);
        },
        (e) => e.source === iframe.contentWindow,
        reject,
        timeout
      );
    } else {
      resolve(null);
    }
  });
  const queryTask = async () => {
    await new Promise((resolve) => {
      const onload = () => {
        iframe.setAttribute("data-iframe-status", "loaded");
        resolve(null);
        iframe.removeEventListener("load", onload);
      };
      iframe.addEventListener("load", onload);
    });
    await callProxy({
      win: iframe.contentWindow,
      serviceId: NOTIFICATION_SERVICE,
      method: "iframeReady",
      payload: [],
      timeout
    });
  };
  return Promise.race([listenTask, queryTask()]);
};
const onIframeLoadingModule = (iframe, cb) => {
  emitter.listen("iframeLoadingModule", cb, (moduleName, extraInfo, e) => e.source === iframe.contentWindow);
};
const DemoServiceName = "demo-service";
const iframeScriptUrl = "data:application/javascript;base64,Y29uc3QgZGVidWdPbmx5TGV2ZWwgPSBbImxvZyIsICJkZWJ1ZyJdOwpjb25zdCBsb2dnZXIgPSBkZWJ1Z09ubHlMZXZlbC5yZWR1Y2UoKHByZSwga2V5KSA9PiB7CiAgcmV0dXJuIE9iamVjdC5hc3NpZ24ocHJlLCB7CiAgICBba2V5XTogKC4uLmFyZ3MpID0+IHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfSk7Cn0sIHt9KTsKbGV0IE1lc3NhZ2VJRCA9IDA7CmNvbnN0IGdldE1lc3NhZ2VJZCA9ICgpID0+IE1lc3NhZ2VJRCsrOwpjb25zdCBzZXJ2aWNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CmNvbnN0IHdhaXRTZXJ2aWNlQ2FsbGJhY2tzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKc2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKGUpID0+IHsKICBjb25zdCBtZXNzYWdlID0gZS5kYXRhOwogIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgUmVmbGVjdC5nZXQobWVzc2FnZSwgIl9fcHJveHlfaW50ZXJuYWwiKSAhPT0gIndhaXQiKSB7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IHNlcnZpY2VJZCA9IG1lc3NhZ2UucmVjZWl2ZXI7CiAgY29uc3QgdGltZW91dF8gPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgIGNvbnN0IGNhbGxiYWNrczIgPSAod2FpdFNlcnZpY2VDYWxsYmFja3MuZ2V0KHNlcnZpY2VJZCkgfHwgW10pLmZpbHRlcigoYykgPT4gYyAhPT0gY2FsbGJhY2spOwogICAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzMik7CiAgICAoZS5zb3VyY2UgfHwgc2VsZikucG9zdE1lc3NhZ2UoewogICAgICBfX3Byb3h5X2ludGVybmFsOiAid2FpdC1yZXBseSIsCiAgICAgIGVycm9yOiB0cnVlLAogICAgICBpZDogbWVzc2FnZS5pZCwKICAgICAgcGF5bG9hZDogW2BbcHJveHldd2FpdCBmb3Igc2VydmljZSAke3NlcnZpY2VJZH0gdGltZW91dC5gXQogICAgfSwgewogICAgICB0YXJnZXRPcmlnaW46ICIqIgogICAgfSk7CiAgfSwgbWVzc2FnZS50aW1lb3V0KTsKICBjb25zdCBjYWxsYmFjayA9ICgpID0+IHsKICAgIGNsZWFyVGltZW91dCh0aW1lb3V0Xyk7CiAgICAoZS5zb3VyY2UgfHwgc2VsZikucG9zdE1lc3NhZ2UoewogICAgICBfX3Byb3h5X2ludGVybmFsOiAid2FpdC1yZXBseSIsCiAgICAgIGlkOiBtZXNzYWdlLmlkLAogICAgICBlcnJvcjogZmFsc2UsCiAgICAgIHBheWxvYWQ6IFtdCiAgICB9LCB7CiAgICAgIHRhcmdldE9yaWdpbjogIioiCiAgICB9KTsKICAgIGNvbnN0IGNhbGxiYWNrczIgPSAod2FpdFNlcnZpY2VDYWxsYmFja3MuZ2V0KHNlcnZpY2VJZCkgfHwgW10pLmZpbHRlcigoYykgPT4gYyAhPT0gY2FsbGJhY2spOwogICAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzMik7CiAgfTsKICBjb25zdCBjYWxsYmFja3MgPSB3YWl0U2VydmljZUNhbGxiYWNrcy5nZXQoc2VydmljZUlkKSB8fCBbXTsKICBjYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgd2FpdFNlcnZpY2VDYWxsYmFja3Muc2V0KHNlcnZpY2VJZCwgY2FsbGJhY2tzKTsKICBpZiAoc2VydmljZXMuaGFzKHNlcnZpY2VJZCkpIHsKICAgIGNhbGxiYWNrKCk7CiAgfQp9KTsKZnVuY3Rpb24gcmVnaXN0ZXJQcm94eShzZXJ2aWNlSWQsIG9iaikgewogIGNvbnN0IGNhbGxiYWNrcyA9IHdhaXRTZXJ2aWNlQ2FsbGJhY2tzLmdldChzZXJ2aWNlSWQpOwogIGlmIChjYWxsYmFja3MpCiAgICBjYWxsYmFja3MuZm9yRWFjaCgoY2FsbGJhY2spID0+IGNhbGxiYWNrKCkpOwogIGNvbnN0IHNlcnZpY2VIYW5kbGVyID0gYXN5bmMgKGUpID0+IHsKICAgIHZhciBfYTsKICAgIGNvbnN0IG1lc3NhZ2UgPSBlLmRhdGE7CiAgICBpZiAodHlwZW9mIG1lc3NhZ2UgIT09ICJvYmplY3QiIHx8IFJlZmxlY3QuZ2V0KG1lc3NhZ2UsICJfX3Byb3h5X2ludGVybmFsIikgIT09ICJjYWxsIikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAobWVzc2FnZS5yZWNlaXZlciA9PT0gc2VydmljZUlkKSB7CiAgICAgIGNvbnN0IG1ldGhvZCA9IFJlZmxlY3QuZ2V0KG9iaiwgbWVzc2FnZS5tZXRob2QpOwogICAgICBpZiAoIW1ldGhvZCkgewogICAgICAgIChlLnNvdXJjZSB8fCBzZWxmKS5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBfX3Byb3h5X2ludGVybmFsOiAicmVwbHkiLAogICAgICAgICAgaWQ6IG1lc3NhZ2UuaWQsCiAgICAgICAgICBlcnJvcjogdHJ1ZSwKICAgICAgICAgIHBheWxvYWQ6IFtgW3Byb3h5XSBtZXRob2QgXGAke21lc3NhZ2UubWV0aG9kfVxgIGRvZXMgbm90IGV4aXN0IG9uIHJlbW90ZSBvYmplY3QgJHttZXNzYWdlLnJlY2VpdmVyfSBvciBpdCBpcyBub3QgYSBmdW5jdGlvbi5gXQogICAgICAgIH0sIHsKICAgICAgICAgIHRhcmdldE9yaWdpbjogIioiCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgbGV0IHJlcyA9IG1ldGhvZDsKICAgICAgaWYgKHR5cGVvZiBtZXRob2QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXMgPSBhd2FpdCBtZXRob2QuY2FsbChvYmosIC4uLm1lc3NhZ2UucGF5bG9hZCwgZSk7CiAgICAgIH0KICAgICAgbG9nZ2VyLmRlYnVnKCJbcHJveHldIHJlcGx5IiwgKChfYSA9IHNlbGYgPT0gbnVsbCA/IHZvaWQgMCA6IHNlbGYubG9jYXRpb24pID09IG51bGwgPyB2b2lkIDAgOiBfYS5ocmVmKSB8fCAid29ya2VyIiwgZS5zb3VyY2UsIG1lc3NhZ2UucmVjZWl2ZXIsIG1lc3NhZ2UubWV0aG9kLCBlLnNvdXJjZSB8fCBzZWxmKTsKICAgICAgKGUuc291cmNlIHx8IHNlbGYpLnBvc3RNZXNzYWdlKHsKICAgICAgICBfX3Byb3h5X2ludGVybmFsOiAicmVwbHkiLAogICAgICAgIGlkOiBtZXNzYWdlLmlkLAogICAgICAgIGVycm9yOiBmYWxzZSwKICAgICAgICBwYXlsb2FkOiBbcmVzXQogICAgICB9LCB7CiAgICAgICAgdGFyZ2V0T3JpZ2luOiAiKiIKICAgICAgfSk7CiAgICB9CiAgfTsKICBzZWxmLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBzZXJ2aWNlSGFuZGxlcik7CiAgcmV0dXJuICgpID0+IHsKICAgIHNlbGYucmVtb3ZlRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIHNlcnZpY2VIYW5kbGVyKTsKICB9Owp9CmFzeW5jIGZ1bmN0aW9uIHdhaXRQcm94eSh3aW4sIHNlcnZpY2VJZCwgdGltZW91dCA9IDFlNCkgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTMsIHJlamVjdCkgPT4gewogICAgY29uc3QgbWVzc2FnZUlkID0gZ2V0TWVzc2FnZUlkKCk7CiAgICBjb25zdCB0aW1lb3V0XyA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICBzZWxmLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICAgIHJlamVjdChgW3Byb3h5XSB3YWl0IGZvciAke3NlcnZpY2VJZH0gdGltZW91dCAuYCk7CiAgICB9LCB0aW1lb3V0KTsKICAgIGNvbnN0IGNhbGxiYWNrID0gKGUpID0+IHsKICAgICAgaWYgKChlLnNvdXJjZSB8fCBzZWxmKSAhPT0gd2luKQogICAgICAgIHJldHVybjsKICAgICAgY29uc3QgbWVzc2FnZSA9IGUuZGF0YTsKICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBSZWZsZWN0LmdldChtZXNzYWdlLCAiX19wcm94eV9pbnRlcm5hbCIpICE9PSAid2FpdC1yZXBseSIgfHwgbWVzc2FnZS5pZCAhPT0gbWVzc2FnZUlkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHJlc29sdmUzKG51bGwpOwogICAgICBjbGVhclRpbWVvdXQodGltZW91dF8pOwogICAgICBzZWxmLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICB9OwogICAgc2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgY2FsbGJhY2spOwogICAgd2luLnBvc3RNZXNzYWdlKHsKICAgICAgX19wcm94eV9pbnRlcm5hbDogIndhaXQiLAogICAgICByZWNlaXZlcjogc2VydmljZUlkLAogICAgICBwYXlsb2FkOiBbXSwKICAgICAgZXJyb3I6IGZhbHNlLAogICAgICBpZDogbWVzc2FnZUlkCiAgICB9LCB7CiAgICAgIHRhcmdldE9yaWdpbjogIioiCiAgICB9KTsKICB9KTsKfQphc3luYyBmdW5jdGlvbiBjYWxsUHJveHkoeyB3aW4sIHNlcnZpY2VJZCwgbWV0aG9kLCBwYXlsb2FkLCB0aW1lb3V0ID0gMWU0IH0pIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUzLCByZWplY3QpID0+IHsKICAgIHZhciBfYTsKICAgIGNvbnN0IG1lc3NhZ2VJZCA9IGdldE1lc3NhZ2VJZCgpOwogICAgbGV0IGhhbmRsZXIgPSBzZWxmOwogICAgaWYgKHdpbiBpbnN0YW5jZW9mIFdvcmtlcikgewogICAgICBoYW5kbGVyID0gd2luOwogICAgfQogICAgbGV0IHRpbWVvdXRfID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHJlamVjdChgY2FsbCByZW1vdGUgb2JqZWN0ICR7c2VydmljZUlkfSBtZXRob2QgJHttZXRob2QudG9TdHJpbmcoKX0gdGltZW91dGApOwogICAgICBoYW5kbGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICB9LCB0aW1lb3V0KTsKICAgIGNvbnN0IGNhbGxiYWNrID0gKGUpID0+IHsKICAgICAgdmFyIF9hMjsKICAgICAgaWYgKCEod2luIGluc3RhbmNlb2YgV29ya2VyKSAmJiAoZS5zb3VyY2UgfHwgc2VsZikgIT09IHdpbikKICAgICAgICByZXR1cm47CiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlLmRhdGE7CiAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgUmVmbGVjdC5nZXQobWVzc2FnZSwgIl9fcHJveHlfaW50ZXJuYWwiKSAhPT0gInJlcGx5IiB8fCBtZXNzYWdlLmlkICE9PSBtZXNzYWdlSWQpCiAgICAgICAgcmV0dXJuOwogICAgICBoYW5kbGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0Xyk7CiAgICAgIGxvZ2dlci5kZWJ1ZygiW3Byb3h5XSByZWNlaXZlIHJlcGx5IiwgKChfYTIgPSBzZWxmID09IG51bGwgPyB2b2lkIDAgOiBzZWxmLmxvY2F0aW9uKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmhyZWYpIHx8ICJ3b3JrZXIiLCBtZXNzYWdlLmlkKTsKICAgICAgaWYgKG1lc3NhZ2UuZXJyb3IpIHsKICAgICAgICByZWplY3QobWVzc2FnZS5wYXlsb2FkWzBdKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmVzb2x2ZTMobWVzc2FnZS5wYXlsb2FkWzBdKTsKICAgIH07CiAgICBoYW5kbGVyLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBjYWxsYmFjayk7CiAgICBsb2dnZXIuZGVidWcoIltwcm94eV0gY2FsbCIsICgoX2EgPSBzZWxmID09IG51bGwgPyB2b2lkIDAgOiBzZWxmLmxvY2F0aW9uKSA9PSBudWxsID8gdm9pZCAwIDogX2EuaHJlZikgfHwgIndvcmtlciIsIHNlcnZpY2VJZCwgbWV0aG9kKTsKICAgIHdpbi5wb3N0TWVzc2FnZSh7CiAgICAgIGlkOiBtZXNzYWdlSWQsCiAgICAgIF9fcHJveHlfaW50ZXJuYWw6ICJjYWxsIiwKICAgICAgcmVjZWl2ZXI6IHNlcnZpY2VJZCwKICAgICAgbWV0aG9kLAogICAgICBwYXlsb2FkLAogICAgICBlcnJvcjogZmFsc2UKICAgIH0sIHsKICAgICAgdGFyZ2V0T3JpZ2luOiAiKiIKICAgIH0pOwogIH0pOwp9CmZ1bmN0aW9uIGJpbmRTY3JpcHRMb2FkZXJUb0N0eChjdHgyKSB7CiAgbGV0IGxvYWRpbmdNb2R1bGVOYW1lID0gIiI7CiAgY29uc3Qgc2NyaXB0TG9hZGluZ1Rhc2tzID0gW107CiAgY29uc3QgbG9hZFNjcmlwdCA9IGFzeW5jIChkb20sIHVybCwgbW9kdWxlTmFtZTIgPSAiZ2xvYmFsT2JqIikgPT4gewogICAgaWYgKGxvYWRpbmdNb2R1bGVOYW1lKSB7CiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlMykgPT4gewogICAgICAgIHJlc29sdmUzLm1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lMjsKICAgICAgICBzY3JpcHRMb2FkaW5nVGFza3MucHVzaChyZXNvbHZlMyk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlMywgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIGN0eDIubG9nZ2VyLmxvZygiW2FtZF0gc2NyaXB0IGxvYWQgdGltZW91dCAiICsgbW9kdWxlTmFtZTIpOwogICAgICAgIHJlamVjdChuZXcgRXJyb3IoYGxvYWQgbW9kdWxlICR7bW9kdWxlTmFtZTJ9IHRpbWVvdXRgKSk7CiAgICAgICAgKF9hID0gc2NyaXB0TG9hZGluZ1Rhc2tzLnNoaWZ0KCkpID09IG51bGwgPyB2b2lkIDAgOiBfYSgpOwogICAgICB9LCBjdHgyLnNjcmlwdFRpbWVvdXQpOwogICAgICBzY3JpcHQub25sb2FkID0gKCkgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICBjdHgyLmxvZ2dlci5sb2coIlthbWRdIHNjcmlwdCByZXNvbHZlZCIsIGxvYWRpbmdNb2R1bGVOYW1lKTsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgcmVzb2x2ZTMobnVsbCk7CiAgICAgICAgbG9hZGluZ01vZHVsZU5hbWUgPSAiIjsKICAgICAgICAoX2EgPSBzY3JpcHRMb2FkaW5nVGFza3Muc2hpZnQoKSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hKCk7CiAgICAgIH07CiAgICAgIHNjcmlwdC5vbmVycm9yID0gKGVycikgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICBjdHgyLmxvZ2dlci5sb2coIlthbWRdIHNjcmlwdCByZWplY3RlZCIsIGxvYWRpbmdNb2R1bGVOYW1lKTsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgbG9hZGluZ01vZHVsZU5hbWUgPSAiIjsKICAgICAgICAoX2EgPSBzY3JpcHRMb2FkaW5nVGFza3Muc2hpZnQoKSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hKCk7CiAgICAgIH07CiAgICAgIHNjcmlwdC5jcm9zc09yaWdpbiA9ICJhbm9ueW1vdXMiOwogICAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgICBzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwogICAgICBjdHgyLmxvZ2dlci5sb2coIlthbWRdIHN0YXJ0IGxvYWQgc2NyaXB0IiwgbW9kdWxlTmFtZTIpOwogICAgICBsb2FkaW5nTW9kdWxlTmFtZSA9IG1vZHVsZU5hbWUyOwogICAgICBkb20uYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgIH0pOwogIH07CiAgY3R4Mi5zY3JpcHRMb2FkZXIgPSB7CiAgICBnZXRMb2FkaW5nTW9kdWxlTmFtZTogKCkgPT4gbG9hZGluZ01vZHVsZU5hbWUsCiAgICBsb2FkU2NyaXB0LAogICAgc2NyaXB0TG9hZGluZ1Rhc2tzCiAgfTsKfQp2YXIgSUV2ZW50VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gKChJRXZlbnRUeXBlczIpID0+IHsKICBJRXZlbnRUeXBlczJbIk1vZHVsZVVwZGF0ZSJdID0gIm1vZHVsZS11cGRhdGUiOwogIElFdmVudFR5cGVzMlsiTG9hZGluZ1NjcmlwdCJdID0gImxvYWRpbmctc2NyaXB0IjsKICBJRXZlbnRUeXBlczJbIk1vZHVsZURlcHMiXSA9ICJtb2R1bGUtZGVwcyI7CiAgcmV0dXJuIElFdmVudFR5cGVzMjsKfSkoSUV2ZW50VHlwZXMgfHwge30pOwpmdW5jdGlvbiBiaW5kRGVmaW5lVG9DdHgoY3R4MikgewogIGZ1bmN0aW9uIGRlZmluZShtb2R1bGVOYW1lMiwgZGVwZW5kZW5jaWVzXywgZmFjdG9yeTIpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlTmFtZTIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZmFjdG9yeTIgPSBtb2R1bGVOYW1lMjsKICAgICAgZGVwZW5kZW5jaWVzXyA9IFsicmVxdWlyZSIsICJleHBvcnRzIiwgIm1vZHVsZSJdOwogICAgICBtb2R1bGVOYW1lMiA9IGN0eDIuc2NyaXB0TG9hZGVyLmdldExvYWRpbmdNb2R1bGVOYW1lKCk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheShtb2R1bGVOYW1lMikpIHsKICAgICAgZmFjdG9yeTIgPSBkZXBlbmRlbmNpZXNfOwogICAgICBkZXBlbmRlbmNpZXNfID0gbW9kdWxlTmFtZTI7CiAgICAgIG1vZHVsZU5hbWUyID0gY3R4Mi5zY3JpcHRMb2FkZXIuZ2V0TG9hZGluZ01vZHVsZU5hbWUoKTsKICAgIH0KICAgIGN0eDIubG9nZ2VyLmxvZygiW2FtZF0gZGVmaW5lIG1vZHVsZSIsIG1vZHVsZU5hbWUyLCBkZXBlbmRlbmNpZXNfKTsKICAgIGNvbnN0IG1vZHVsZVBhdGgyID0gY3R4Mi5yZXF1aXJlLnJlc29sdmUobW9kdWxlTmFtZTIpOwogICAgY29uc3QgeyBmYWN0b3JpZXM6IGZhY3RvcmllczIsIGNhY2hlOiBjYWNoZTIsIGRlcGVuZGVuY2llczogZGVwZW5kZW5jaWVzMiB9ID0gY3R4Mi5yZXF1aXJlOwogICAgaWYgKGZhY3RvcmllczIuaGFzKG1vZHVsZVBhdGgyKSkgewogICAgICBmYWN0b3JpZXMyLmRlbGV0ZShtb2R1bGVQYXRoMik7CiAgICB9CiAgICBpZiAoY2FjaGUyLmhhcyhtb2R1bGVQYXRoMikpIHsKICAgICAgY2FjaGUyLmRlbGV0ZShtb2R1bGVQYXRoMik7CiAgICB9CiAgICBpZiAoZGVwZW5kZW5jaWVzMi5oYXMobW9kdWxlUGF0aDIpKSB7CiAgICAgIGRlcGVuZGVuY2llczIuZGVsZXRlKG1vZHVsZVBhdGgyKTsKICAgIH0KICAgIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLnRyaWdnZXIoSUV2ZW50VHlwZXMuTW9kdWxlVXBkYXRlLCBtb2R1bGVQYXRoMik7CiAgICBmYWN0b3JpZXMyLnNldChtb2R1bGVQYXRoMiwgZmFjdG9yeTIpOwogICAgZGVwZW5kZW5jaWVzMi5zZXQobW9kdWxlUGF0aDIsIGRlcGVuZGVuY2llc18pOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgY3R4Mi5sb2dnZXIubG9nKCJbYW1kXSBtb2R1bGUgZGlzcG9zZSIsIG1vZHVsZU5hbWUyKTsKICAgICAgZmFjdG9yaWVzMi5kZWxldGUobW9kdWxlUGF0aDIpOwogICAgfTsKICB9CiAgY3R4Mi5kZWZpbmUgPSBPYmplY3QuYXNzaWduKGRlZmluZSwgewogICAgYW1kOiB7fQogIH0pOwp9CmZ1bmN0aW9uIGFzc2VydFBhdGgocGF0aCkgewogIGlmICh0eXBlb2YgcGF0aCAhPT0gInN0cmluZyIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlBhdGggbXVzdCBiZSBhIHN0cmluZy4gUmVjZWl2ZWQgIiArIEpTT04uc3RyaW5naWZ5KHBhdGgpKTsKICB9Cn0KZnVuY3Rpb24gbm9ybWFsaXplU3RyaW5nUG9zaXgocGF0aCwgYWxsb3dBYm92ZVJvb3QpIHsKICB2YXIgcmVzID0gIiI7CiAgdmFyIGxhc3RTZWdtZW50TGVuZ3RoID0gMDsKICB2YXIgbGFzdFNsYXNoID0gLTE7CiAgdmFyIGRvdHMgPSAwOwogIHZhciBjb2RlOwogIGZvciAodmFyIGkgPSAwOyBpIDw9IHBhdGgubGVuZ3RoOyArK2kpIHsKICAgIGlmIChpIDwgcGF0aC5sZW5ndGgpCiAgICAgIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSk7CiAgICBlbHNlIGlmIChjb2RlID09PSA0NykKICAgICAgYnJlYWs7CiAgICBlbHNlCiAgICAgIGNvZGUgPSA0NzsKICAgIGlmIChjb2RlID09PSA0NykgewogICAgICBpZiAobGFzdFNsYXNoID09PSBpIC0gMSB8fCBkb3RzID09PSAxKQogICAgICAgIDsKICAgICAgZWxzZSBpZiAobGFzdFNsYXNoICE9PSBpIC0gMSAmJiBkb3RzID09PSAyKSB7CiAgICAgICAgaWYgKHJlcy5sZW5ndGggPCAyIHx8IGxhc3RTZWdtZW50TGVuZ3RoICE9PSAyIHx8IHJlcy5jaGFyQ29kZUF0KHJlcy5sZW5ndGggLSAxKSAhPT0gNDYgfHwgcmVzLmNoYXJDb2RlQXQocmVzLmxlbmd0aCAtIDIpICE9PSA0NikgewogICAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgIHZhciBsYXN0U2xhc2hJbmRleCA9IHJlcy5sYXN0SW5kZXhPZigiLyIpOwogICAgICAgICAgICBpZiAobGFzdFNsYXNoSW5kZXggIT09IHJlcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgaWYgKGxhc3RTbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgcmVzID0gIiI7CiAgICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDA7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlcyA9IHJlcy5zbGljZSgwLCBsYXN0U2xhc2hJbmRleCk7CiAgICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IHJlcy5sZW5ndGggLSAxIC0gcmVzLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgICAgICAgICAgZG90cyA9IDA7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAocmVzLmxlbmd0aCA9PT0gMiB8fCByZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHJlcyA9ICIiOwogICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDA7CiAgICAgICAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgICAgICAgIGRvdHMgPSAwOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGFsbG93QWJvdmVSb290KSB7CiAgICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDApCiAgICAgICAgICAgIHJlcyArPSAiLy4uIjsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgcmVzID0gIi4uIjsKICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAwKQogICAgICAgICAgcmVzICs9ICIvIiArIHBhdGguc2xpY2UobGFzdFNsYXNoICsgMSwgaSk7CiAgICAgICAgZWxzZQogICAgICAgICAgcmVzID0gcGF0aC5zbGljZShsYXN0U2xhc2ggKyAxLCBpKTsKICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IGkgLSBsYXN0U2xhc2ggLSAxOwogICAgICB9CiAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgIGRvdHMgPSAwOwogICAgfSBlbHNlIGlmIChjb2RlID09PSA0NiAmJiBkb3RzICE9PSAtMSkgewogICAgICArK2RvdHM7CiAgICB9IGVsc2UgewogICAgICBkb3RzID0gLTE7CiAgICB9CiAgfQogIHJldHVybiByZXM7Cn0KZnVuY3Rpb24gX2Zvcm1hdChzZXAsIHBhdGhPYmplY3QpIHsKICB2YXIgZGlyID0gcGF0aE9iamVjdC5kaXIgfHwgcGF0aE9iamVjdC5yb290OwogIHZhciBiYXNlID0gcGF0aE9iamVjdC5iYXNlIHx8IChwYXRoT2JqZWN0Lm5hbWUgfHwgIiIpICsgKHBhdGhPYmplY3QuZXh0IHx8ICIiKTsKICBpZiAoIWRpcikgewogICAgcmV0dXJuIGJhc2U7CiAgfQogIGlmIChkaXIgPT09IHBhdGhPYmplY3Qucm9vdCkgewogICAgcmV0dXJuIGRpciArIGJhc2U7CiAgfQogIHJldHVybiBkaXIgKyBzZXAgKyBiYXNlOwp9CnZhciBwb3NpeCA9IHsKICAvLyBwYXRoLnJlc29sdmUoW2Zyb20gLi4uXSwgdG8pCiAgcmVzb2x2ZTogZnVuY3Rpb24gcmVzb2x2ZTIoKSB7CiAgICB2YXIgcmVzb2x2ZWRQYXRoID0gIiI7CiAgICB2YXIgcmVzb2x2ZWRBYnNvbHV0ZSA9IGZhbHNlOwogICAgdmFyIGN3ZDsKICAgIGZvciAodmFyIGkgPSBhcmd1bWVudHMubGVuZ3RoIC0gMTsgaSA+PSAtMSAmJiAhcmVzb2x2ZWRBYnNvbHV0ZTsgaS0tKSB7CiAgICAgIHZhciBwYXRoOwogICAgICBpZiAoaSA+PSAwKQogICAgICAgIHBhdGggPSBhcmd1bWVudHNbaV07CiAgICAgIGVsc2UgewogICAgICAgIGlmIChjd2QgPT09IHZvaWQgMCkKICAgICAgICAgIGN3ZCA9IHByb2Nlc3MuY3dkKCk7CiAgICAgICAgcGF0aCA9IGN3ZDsKICAgICAgfQogICAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICByZXNvbHZlZFBhdGggPSBwYXRoICsgIi8iICsgcmVzb2x2ZWRQYXRoOwogICAgICByZXNvbHZlZEFic29sdXRlID0gcGF0aC5jaGFyQ29kZUF0KDApID09PSA0NzsKICAgIH0KICAgIHJlc29sdmVkUGF0aCA9IG5vcm1hbGl6ZVN0cmluZ1Bvc2l4KHJlc29sdmVkUGF0aCwgIXJlc29sdmVkQWJzb2x1dGUpOwogICAgaWYgKHJlc29sdmVkQWJzb2x1dGUpIHsKICAgICAgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPiAwKQogICAgICAgIHJldHVybiAiLyIgKyByZXNvbHZlZFBhdGg7CiAgICAgIGVsc2UKICAgICAgICByZXR1cm4gIi8iOwogICAgfSBlbHNlIGlmIChyZXNvbHZlZFBhdGgubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gcmVzb2x2ZWRQYXRoOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICIuIjsKICAgIH0KICB9LAogIG5vcm1hbGl6ZTogZnVuY3Rpb24gbm9ybWFsaXplKHBhdGgpIHsKICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICBpZiAocGF0aC5sZW5ndGggPT09IDApCiAgICAgIHJldHVybiAiLiI7CiAgICB2YXIgaXNBYnNvbHV0ZTIgPSBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IDQ3OwogICAgdmFyIHRyYWlsaW5nU2VwYXJhdG9yID0gcGF0aC5jaGFyQ29kZUF0KHBhdGgubGVuZ3RoIC0gMSkgPT09IDQ3OwogICAgcGF0aCA9IG5vcm1hbGl6ZVN0cmluZ1Bvc2l4KHBhdGgsICFpc0Fic29sdXRlMik7CiAgICBpZiAocGF0aC5sZW5ndGggPT09IDAgJiYgIWlzQWJzb2x1dGUyKQogICAgICBwYXRoID0gIi4iOwogICAgaWYgKHBhdGgubGVuZ3RoID4gMCAmJiB0cmFpbGluZ1NlcGFyYXRvcikKICAgICAgcGF0aCArPSAiLyI7CiAgICBpZiAoaXNBYnNvbHV0ZTIpCiAgICAgIHJldHVybiAiLyIgKyBwYXRoOwogICAgcmV0dXJuIHBhdGg7CiAgfSwKICBpc0Fic29sdXRlOiBmdW5jdGlvbiBpc0Fic29sdXRlKHBhdGgpIHsKICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICByZXR1cm4gcGF0aC5sZW5ndGggPiAwICYmIHBhdGguY2hhckNvZGVBdCgwKSA9PT0gNDc7CiAgfSwKICBqb2luOiBmdW5jdGlvbiBqb2luKCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApCiAgICAgIHJldHVybiAiLiI7CiAgICB2YXIgam9pbmVkOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGFyZyA9IGFyZ3VtZW50c1tpXTsKICAgICAgYXNzZXJ0UGF0aChhcmcpOwogICAgICBpZiAoYXJnLmxlbmd0aCA+IDApIHsKICAgICAgICBpZiAoam9pbmVkID09PSB2b2lkIDApCiAgICAgICAgICBqb2luZWQgPSBhcmc7CiAgICAgICAgZWxzZQogICAgICAgICAgam9pbmVkICs9ICIvIiArIGFyZzsKICAgICAgfQogICAgfQogICAgaWYgKGpvaW5lZCA9PT0gdm9pZCAwKQogICAgICByZXR1cm4gIi4iOwogICAgcmV0dXJuIHBvc2l4Lm5vcm1hbGl6ZShqb2luZWQpOwogIH0sCiAgcmVsYXRpdmU6IGZ1bmN0aW9uIHJlbGF0aXZlKGZyb20sIHRvKSB7CiAgICBhc3NlcnRQYXRoKGZyb20pOwogICAgYXNzZXJ0UGF0aCh0byk7CiAgICBpZiAoZnJvbSA9PT0gdG8pCiAgICAgIHJldHVybiAiIjsKICAgIGZyb20gPSBwb3NpeC5yZXNvbHZlKGZyb20pOwogICAgdG8gPSBwb3NpeC5yZXNvbHZlKHRvKTsKICAgIGlmIChmcm9tID09PSB0bykKICAgICAgcmV0dXJuICIiOwogICAgdmFyIGZyb21TdGFydCA9IDE7CiAgICBmb3IgKDsgZnJvbVN0YXJ0IDwgZnJvbS5sZW5ndGg7ICsrZnJvbVN0YXJ0KSB7CiAgICAgIGlmIChmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0KSAhPT0gNDcpCiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB2YXIgZnJvbUVuZCA9IGZyb20ubGVuZ3RoOwogICAgdmFyIGZyb21MZW4gPSBmcm9tRW5kIC0gZnJvbVN0YXJ0OwogICAgdmFyIHRvU3RhcnQgPSAxOwogICAgZm9yICg7IHRvU3RhcnQgPCB0by5sZW5ndGg7ICsrdG9TdGFydCkgewogICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0KSAhPT0gNDcpCiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB2YXIgdG9FbmQgPSB0by5sZW5ndGg7CiAgICB2YXIgdG9MZW4gPSB0b0VuZCAtIHRvU3RhcnQ7CiAgICB2YXIgbGVuZ3RoID0gZnJvbUxlbiA8IHRvTGVuID8gZnJvbUxlbiA6IHRvTGVuOwogICAgdmFyIGxhc3RDb21tb25TZXAgPSAtMTsKICAgIHZhciBpID0gMDsKICAgIGZvciAoOyBpIDw9IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChpID09PSBsZW5ndGgpIHsKICAgICAgICBpZiAodG9MZW4gPiBsZW5ndGgpIHsKICAgICAgICAgIGlmICh0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKSA9PT0gNDcpIHsKICAgICAgICAgICAgcmV0dXJuIHRvLnNsaWNlKHRvU3RhcnQgKyBpICsgMSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGkgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHRvLnNsaWNlKHRvU3RhcnQgKyBpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGZyb21MZW4gPiBsZW5ndGgpIHsKICAgICAgICAgIGlmIChmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSkgPT09IDQ3KSB7CiAgICAgICAgICAgIGxhc3RDb21tb25TZXAgPSBpOwogICAgICAgICAgfSBlbHNlIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgIGxhc3RDb21tb25TZXAgPSAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgfQogICAgICB2YXIgZnJvbUNvZGUgPSBmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSk7CiAgICAgIHZhciB0b0NvZGUgPSB0by5jaGFyQ29kZUF0KHRvU3RhcnQgKyBpKTsKICAgICAgaWYgKGZyb21Db2RlICE9PSB0b0NvZGUpCiAgICAgICAgYnJlYWs7CiAgICAgIGVsc2UgaWYgKGZyb21Db2RlID09PSA0NykKICAgICAgICBsYXN0Q29tbW9uU2VwID0gaTsKICAgIH0KICAgIHZhciBvdXQgPSAiIjsKICAgIGZvciAoaSA9IGZyb21TdGFydCArIGxhc3RDb21tb25TZXAgKyAxOyBpIDw9IGZyb21FbmQ7ICsraSkgewogICAgICBpZiAoaSA9PT0gZnJvbUVuZCB8fCBmcm9tLmNoYXJDb2RlQXQoaSkgPT09IDQ3KSB7CiAgICAgICAgaWYgKG91dC5sZW5ndGggPT09IDApCiAgICAgICAgICBvdXQgKz0gIi4uIjsKICAgICAgICBlbHNlCiAgICAgICAgICBvdXQgKz0gIi8uLiI7CiAgICAgIH0KICAgIH0KICAgIGlmIChvdXQubGVuZ3RoID4gMCkKICAgICAgcmV0dXJuIG91dCArIHRvLnNsaWNlKHRvU3RhcnQgKyBsYXN0Q29tbW9uU2VwKTsKICAgIGVsc2UgewogICAgICB0b1N0YXJ0ICs9IGxhc3RDb21tb25TZXA7CiAgICAgIGlmICh0by5jaGFyQ29kZUF0KHRvU3RhcnQpID09PSA0NykKICAgICAgICArK3RvU3RhcnQ7CiAgICAgIHJldHVybiB0by5zbGljZSh0b1N0YXJ0KTsKICAgIH0KICB9LAogIF9tYWtlTG9uZzogZnVuY3Rpb24gX21ha2VMb25nKHBhdGgpIHsKICAgIHJldHVybiBwYXRoOwogIH0sCiAgZGlybmFtZTogZnVuY3Rpb24gZGlybmFtZShwYXRoKSB7CiAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKQogICAgICByZXR1cm4gIi4iOwogICAgdmFyIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCk7CiAgICB2YXIgaGFzUm9vdCA9IGNvZGUgPT09IDQ3OwogICAgdmFyIGVuZCA9IC0xOwogICAgdmFyIG1hdGNoZWRTbGFzaCA9IHRydWU7CiAgICBmb3IgKHZhciBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDE7IC0taSkgewogICAgICBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICBpZiAoY29kZSA9PT0gNDcpIHsKICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgZW5kID0gaTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgaWYgKGVuZCA9PT0gLTEpCiAgICAgIHJldHVybiBoYXNSb290ID8gIi8iIDogIi4iOwogICAgaWYgKGhhc1Jvb3QgJiYgZW5kID09PSAxKQogICAgICByZXR1cm4gIi8vIjsKICAgIHJldHVybiBwYXRoLnNsaWNlKDAsIGVuZCk7CiAgfSwKICBiYXNlbmFtZTogZnVuY3Rpb24gYmFzZW5hbWUocGF0aCwgZXh0KSB7CiAgICBpZiAoZXh0ICE9PSB2b2lkIDAgJiYgdHlwZW9mIGV4dCAhPT0gInN0cmluZyIpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJleHQiIGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcnKTsKICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICB2YXIgc3RhcnQgPSAwOwogICAgdmFyIGVuZCA9IC0xOwogICAgdmFyIG1hdGNoZWRTbGFzaCA9IHRydWU7CiAgICB2YXIgaTsKICAgIGlmIChleHQgIT09IHZvaWQgMCAmJiBleHQubGVuZ3RoID4gMCAmJiBleHQubGVuZ3RoIDw9IHBhdGgubGVuZ3RoKSB7CiAgICAgIGlmIChleHQubGVuZ3RoID09PSBwYXRoLmxlbmd0aCAmJiBleHQgPT09IHBhdGgpCiAgICAgICAgcmV0dXJuICIiOwogICAgICB2YXIgZXh0SWR4ID0gZXh0Lmxlbmd0aCAtIDE7CiAgICAgIHZhciBmaXJzdE5vblNsYXNoRW5kID0gLTE7CiAgICAgIGZvciAoaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB2YXIgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKTsKICAgICAgICBpZiAoY29kZSA9PT0gNDcpIHsKICAgICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICAgIHN0YXJ0ID0gaSArIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZmlyc3ROb25TbGFzaEVuZCA9PT0gLTEpIHsKICAgICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgICAgIGZpcnN0Tm9uU2xhc2hFbmQgPSBpICsgMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHRJZHggPj0gMCkgewogICAgICAgICAgICBpZiAoY29kZSA9PT0gZXh0LmNoYXJDb2RlQXQoZXh0SWR4KSkgewogICAgICAgICAgICAgIGlmICgtLWV4dElkeCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGVuZCA9IGk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGV4dElkeCA9IC0xOwogICAgICAgICAgICAgIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHN0YXJ0ID09PSBlbmQpCiAgICAgICAgZW5kID0gZmlyc3ROb25TbGFzaEVuZDsKICAgICAgZWxzZSBpZiAoZW5kID09PSAtMSkKICAgICAgICBlbmQgPSBwYXRoLmxlbmd0aDsKICAgICAgcmV0dXJuIHBhdGguc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgaWYgKHBhdGguY2hhckNvZGVBdChpKSA9PT0gNDcpIHsKICAgICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICAgIHN0YXJ0ID0gaSArIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZW5kID09PSAtMSkgewogICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgICBlbmQgPSBpICsgMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGVuZCA9PT0gLTEpCiAgICAgICAgcmV0dXJuICIiOwogICAgICByZXR1cm4gcGF0aC5zbGljZShzdGFydCwgZW5kKTsKICAgIH0KICB9LAogIGV4dG5hbWU6IGZ1bmN0aW9uIGV4dG5hbWUocGF0aCkgewogICAgYXNzZXJ0UGF0aChwYXRoKTsKICAgIHZhciBzdGFydERvdCA9IC0xOwogICAgdmFyIHN0YXJ0UGFydCA9IDA7CiAgICB2YXIgZW5kID0gLTE7CiAgICB2YXIgbWF0Y2hlZFNsYXNoID0gdHJ1ZTsKICAgIHZhciBwcmVEb3RTdGF0ZSA9IDA7CiAgICBmb3IgKHZhciBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICB2YXIgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKTsKICAgICAgaWYgKGNvZGUgPT09IDQ3KSB7CiAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgIHN0YXJ0UGFydCA9IGkgKyAxOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChlbmQgPT09IC0xKSB7CiAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgZW5kID0gaSArIDE7CiAgICAgIH0KICAgICAgaWYgKGNvZGUgPT09IDQ2KSB7CiAgICAgICAgaWYgKHN0YXJ0RG90ID09PSAtMSkKICAgICAgICAgIHN0YXJ0RG90ID0gaTsKICAgICAgICBlbHNlIGlmIChwcmVEb3RTdGF0ZSAhPT0gMSkKICAgICAgICAgIHByZURvdFN0YXRlID0gMTsKICAgICAgfSBlbHNlIGlmIChzdGFydERvdCAhPT0gLTEpIHsKICAgICAgICBwcmVEb3RTdGF0ZSA9IC0xOwogICAgICB9CiAgICB9CiAgICBpZiAoc3RhcnREb3QgPT09IC0xIHx8IGVuZCA9PT0gLTEgfHwgLy8gV2Ugc2F3IGEgbm9uLWRvdCBjaGFyYWN0ZXIgaW1tZWRpYXRlbHkgYmVmb3JlIHRoZSBkb3QKICAgIHByZURvdFN0YXRlID09PSAwIHx8IC8vIFRoZSAocmlnaHQtbW9zdCkgdHJpbW1lZCBwYXRoIGNvbXBvbmVudCBpcyBleGFjdGx5ICcuLicKICAgIHByZURvdFN0YXRlID09PSAxICYmIHN0YXJ0RG90ID09PSBlbmQgLSAxICYmIHN0YXJ0RG90ID09PSBzdGFydFBhcnQgKyAxKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KICAgIHJldHVybiBwYXRoLnNsaWNlKHN0YXJ0RG90LCBlbmQpOwogIH0sCiAgZm9ybWF0OiBmdW5jdGlvbiBmb3JtYXQocGF0aE9iamVjdCkgewogICAgaWYgKHBhdGhPYmplY3QgPT09IG51bGwgfHwgdHlwZW9mIHBhdGhPYmplY3QgIT09ICJvYmplY3QiKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RoZSAicGF0aE9iamVjdCIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIE9iamVjdC4gUmVjZWl2ZWQgdHlwZSAnICsgdHlwZW9mIHBhdGhPYmplY3QpOwogICAgfQogICAgcmV0dXJuIF9mb3JtYXQoIi8iLCBwYXRoT2JqZWN0KTsKICB9LAogIHBhcnNlOiBmdW5jdGlvbiBwYXJzZShwYXRoKSB7CiAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgdmFyIHJldCA9IHsgcm9vdDogIiIsIGRpcjogIiIsIGJhc2U6ICIiLCBleHQ6ICIiLCBuYW1lOiAiIiB9OwogICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKQogICAgICByZXR1cm4gcmV0OwogICAgdmFyIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCk7CiAgICB2YXIgaXNBYnNvbHV0ZTIgPSBjb2RlID09PSA0NzsKICAgIHZhciBzdGFydDsKICAgIGlmIChpc0Fic29sdXRlMikgewogICAgICByZXQucm9vdCA9ICIvIjsKICAgICAgc3RhcnQgPSAxOwogICAgfSBlbHNlIHsKICAgICAgc3RhcnQgPSAwOwogICAgfQogICAgdmFyIHN0YXJ0RG90ID0gLTE7CiAgICB2YXIgc3RhcnRQYXJ0ID0gMDsKICAgIHZhciBlbmQgPSAtMTsKICAgIHZhciBtYXRjaGVkU2xhc2ggPSB0cnVlOwogICAgdmFyIGkgPSBwYXRoLmxlbmd0aCAtIDE7CiAgICB2YXIgcHJlRG90U3RhdGUgPSAwOwogICAgZm9yICg7IGkgPj0gc3RhcnQ7IC0taSkgewogICAgICBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICBpZiAoY29kZSA9PT0gNDcpIHsKICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgc3RhcnRQYXJ0ID0gaSArIDE7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGVuZCA9PT0gLTEpIHsKICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICBlbmQgPSBpICsgMTsKICAgICAgfQogICAgICBpZiAoY29kZSA9PT0gNDYpIHsKICAgICAgICBpZiAoc3RhcnREb3QgPT09IC0xKQogICAgICAgICAgc3RhcnREb3QgPSBpOwogICAgICAgIGVsc2UgaWYgKHByZURvdFN0YXRlICE9PSAxKQogICAgICAgICAgcHJlRG90U3RhdGUgPSAxOwogICAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewogICAgICAgIHByZURvdFN0YXRlID0gLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChzdGFydERvdCA9PT0gLTEgfHwgZW5kID09PSAtMSB8fCAvLyBXZSBzYXcgYSBub24tZG90IGNoYXJhY3RlciBpbW1lZGlhdGVseSBiZWZvcmUgdGhlIGRvdAogICAgcHJlRG90U3RhdGUgPT09IDAgfHwgLy8gVGhlIChyaWdodC1tb3N0KSB0cmltbWVkIHBhdGggY29tcG9uZW50IGlzIGV4YWN0bHkgJy4uJwogICAgcHJlRG90U3RhdGUgPT09IDEgJiYgc3RhcnREb3QgPT09IGVuZCAtIDEgJiYgc3RhcnREb3QgPT09IHN0YXJ0UGFydCArIDEpIHsKICAgICAgaWYgKGVuZCAhPT0gLTEpIHsKICAgICAgICBpZiAoc3RhcnRQYXJ0ID09PSAwICYmIGlzQWJzb2x1dGUyKQogICAgICAgICAgcmV0LmJhc2UgPSByZXQubmFtZSA9IHBhdGguc2xpY2UoMSwgZW5kKTsKICAgICAgICBlbHNlCiAgICAgICAgICByZXQuYmFzZSA9IHJldC5uYW1lID0gcGF0aC5zbGljZShzdGFydFBhcnQsIGVuZCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChzdGFydFBhcnQgPT09IDAgJiYgaXNBYnNvbHV0ZTIpIHsKICAgICAgICByZXQubmFtZSA9IHBhdGguc2xpY2UoMSwgc3RhcnREb3QpOwogICAgICAgIHJldC5iYXNlID0gcGF0aC5zbGljZSgxLCBlbmQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldC5uYW1lID0gcGF0aC5zbGljZShzdGFydFBhcnQsIHN0YXJ0RG90KTsKICAgICAgICByZXQuYmFzZSA9IHBhdGguc2xpY2Uoc3RhcnRQYXJ0LCBlbmQpOwogICAgICB9CiAgICAgIHJldC5leHQgPSBwYXRoLnNsaWNlKHN0YXJ0RG90LCBlbmQpOwogICAgfQogICAgaWYgKHN0YXJ0UGFydCA+IDApCiAgICAgIHJldC5kaXIgPSBwYXRoLnNsaWNlKDAsIHN0YXJ0UGFydCAtIDEpOwogICAgZWxzZSBpZiAoaXNBYnNvbHV0ZTIpCiAgICAgIHJldC5kaXIgPSAiLyI7CiAgICByZXR1cm4gcmV0OwogIH0sCiAgc2VwOiAiLyIsCiAgZGVsaW1pdGVyOiAiOiIsCiAgd2luMzI6IG51bGwsCiAgcG9zaXg6IG51bGwKfTsKcG9zaXgucG9zaXggPSBwb3NpeDsKdmFyIHBhdGhCcm93c2VyaWZ5ID0gcG9zaXg7CmZ1bmN0aW9uIGJpbmRSZXF1aXJlVG9DdHgoY3R4KSB7CiAgY29uc3QgY2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IGZhY3RvcmllcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgZGVwZW5kZW5jaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCBtb2R1bGVSZXF1aXJpbmdUYXNrcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgcGFyc2VNb2R1bGVOYW1lID0gZnVuY3Rpb24obW9kdWxlTmFtZTIpIHsKICAgIGNvbnN0IFssIG5hbWUsIHZlcnNpb24sIGZpbGVdID0gbW9kdWxlTmFtZTIubWF0Y2goLyheQD9bXi9AXSspKD86QChbXi9dKykpPyguKikvKSB8fCBbXTsKICAgIHJldHVybiBbbmFtZSwgdmVyc2lvbiwgZmlsZV07CiAgfTsKICBjb25zdCByZXNvbHZlID0gKG1vZHVsZU5hbWUyLCBfX2ZpbGVwYXRoKSA9PiB7CiAgICBpZiAoWyJyZXF1aXJlIiwgIm1vZHVsZSIsICJleHBvcnRzIl0uaW5jbHVkZXMobW9kdWxlTmFtZTIpKSB7CiAgICAgIHJldHVybiBtb2R1bGVOYW1lMjsKICAgIH0KICAgIGlmIChwYXRoQnJvd3NlcmlmeS5pc0Fic29sdXRlKG1vZHVsZU5hbWUyKSkgewogICAgICByZXR1cm4gbW9kdWxlTmFtZTI7CiAgICB9CiAgICBpZiAobW9kdWxlTmFtZTIuc3RhcnRzV2l0aCgiLiIpKSB7CiAgICAgIGlmICghX19maWxlcGF0aCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgW2FtZF0gY2FuJ3Qgbm90IHJlc29sdmUgcmVsYXRpdmUgcGF0aCAke21vZHVsZU5hbWUyfSB3aXRob3V0IF9fZGlybmFtZWApOwogICAgICB9CiAgICAgIHJldHVybiBwYXRoQnJvd3NlcmlmeS5yZXNvbHZlKHBhdGhCcm93c2VyaWZ5LmRpcm5hbWUoX19maWxlcGF0aCksIG1vZHVsZU5hbWUyKTsKICAgIH0KICAgIGlmIChtb2R1bGVOYW1lMi5zdGFydHNXaXRoKCIvIikpIHsKICAgICAgcmV0dXJuIHBhdGhCcm93c2VyaWZ5LnJlc29sdmUoY3R4LnJvb3QsIG1vZHVsZU5hbWUyKTsKICAgIH0KICAgIGNvbnN0IFttb2R1bGVQYXRoMl0gPSBwYXJzZU1vZHVsZU5hbWUobW9kdWxlTmFtZTIpOwogICAgcmV0dXJuIHBhdGhCcm93c2VyaWZ5LnJlc29sdmUoY3R4LnJvb3QsICJub2RlX21vZHVsZXMiLCBtb2R1bGVQYXRoMik7CiAgfTsKICBjb25zdCByZXNvbHZlRGVwcyA9IGFzeW5jIChfcGFja2FnZU5hbWUsIF92ZXJzaW9uLCBfZmlsZSkgPT4gewogICAgY29uc3QgcGFyYW1zID0gewogICAgICBwYWNrYWdlTmFtZTogX3BhY2thZ2VOYW1lLAogICAgICB2ZXJzaW9uOiBfdmVyc2lvbiwKICAgICAgZmlsZTogX2ZpbGUKICAgIH07CiAgICBjb25zdCByZXMgPSBhd2FpdCBjdHgucGx1Z2luUmVkdWNlKAogICAgICBhc3luYyAocHJlVmFsdWUsIHBsdWdpbikgPT4gewogICAgICAgIGNvbnN0IHJlczIgPSBhd2FpdCBwbHVnaW4ucmVzb2x2ZU1vZHVsZVVybChwcmVWYWx1ZSk7CiAgICAgICAgaWYgKHR5cGVvZiByZXMyID09PSAic3RyaW5nIikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdWx0OiByZXMyLAogICAgICAgICAgICBicmVhazogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsgcmVzdWx0OiByZXMyIH07CiAgICAgIH0sCiAgICAgIHBhcmFtcwogICAgKTsKICAgIHJldHVybiByZXM7CiAgfTsKICBjb25zdCBtb2R1bGVGYWN0b3J5ID0gYXN5bmMgKG1vZHVsZU5hbWUsIF90aGlzKSA9PiB7CiAgICBjb25zdCBtb2R1bGVQYXRoID0gcmVzb2x2ZShtb2R1bGVOYW1lLCBfdGhpcy5fX2Rpcm5hbWUpOwogICAgaWYgKG1vZHVsZVJlcXVpcmluZ1Rhc2tzLmhhcyhtb2R1bGVQYXRoKSkgewogICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUyMiwgcmVqZWN0KSA9PiB7CiAgICAgICAgY29uc3QgdGFza3MgPSBtb2R1bGVSZXF1aXJpbmdUYXNrcy5nZXQobW9kdWxlUGF0aCk7CiAgICAgICAgdGFza3MucHVzaChbcmVzb2x2ZTIyLCByZWplY3RdKTsKICAgICAgICBjdHgubG9nZ2VyLmxvZyhgW2FtZF0gcmVxdWlyZSAke21vZHVsZU5hbWV9LCBhbHJlYWR5IGhhcyB0YXNrIHJlcXVpcmluZywgd2FpdGluZyB0YXNrczogJHt0YXNrcy5sZW5ndGh9LmApOwogICAgICB9KTsKICAgIH0KICAgIGN0eC5sb2dnZXIubG9nKCJbYW1kXSBzdGFydCByZXF1aXJlIiwgbW9kdWxlUGF0aCk7CiAgICBtb2R1bGVSZXF1aXJpbmdUYXNrcy5zZXQobW9kdWxlUGF0aCwgW10pOwogICAgY29uc3QgY2xlYXJBbGxUYXNrcyA9IChlcnIsIG1vZHVsZV8yKSA9PiB7CiAgICAgIGNvbnN0IHRhc2tzID0gbW9kdWxlUmVxdWlyaW5nVGFza3MuZ2V0KG1vZHVsZVBhdGgpOwogICAgICBpZiAodGFza3MgPT0gbnVsbCA/IHZvaWQgMCA6IHRhc2tzLmxlbmd0aCkgewogICAgICAgIHRhc2tzLmZvckVhY2goKFtyZXNvbHZlMjIsIHJlamVjdF0sIGluZGV4KSA9PiB7CiAgICAgICAgICBjdHgubG9nZ2VyLmxvZygiW2FtZF0gcmVzb2x2ZSBpdGVtIiwgaW5kZXgsIG1vZHVsZU5hbWUpOwogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc29sdmUyMihtb2R1bGVfMik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgbW9kdWxlUmVxdWlyaW5nVGFza3MuZGVsZXRlKG1vZHVsZVBhdGgpOwogICAgICBpZiAoZXJyKSB7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGVfMjsKICAgIH07CiAgICBpZiAoY2FjaGUuaGFzKG1vZHVsZVBhdGgpKSB7CiAgICAgIGN0eC5sb2dnZXIubG9nKGBbYW1kXSByZXF1aXJlICR7bW9kdWxlTmFtZX0sIHJlc29sdmVkIGZyb20gY2FjaGVgKTsKICAgICAgcmV0dXJuIGNsZWFyQWxsVGFza3Modm9pZCAwLCBjYWNoZS5nZXQobW9kdWxlUGF0aCkpOwogICAgfQogICAgbGV0IGZhY3RvcnkgPSBmYWN0b3JpZXMuZ2V0KG1vZHVsZVBhdGgpOwogICAgaWYgKCFmYWN0b3J5KSB7CiAgICAgIGlmICghbW9kdWxlTmFtZS5zdGFydHNXaXRoKCIuIikgJiYgIXBhdGhCcm93c2VyaWZ5LmlzQWJzb2x1dGUobW9kdWxlTmFtZSkpIHsKICAgICAgICBjb25zdCBbbmFtZSwgdmVyc2lvbiwgZmlsZV0gPSBwYXJzZU1vZHVsZU5hbWUobW9kdWxlTmFtZSk7CiAgICAgICAgY29uc3Qgc2NyaXB0VXJsID0gYXdhaXQgcmVzb2x2ZURlcHMobmFtZSwgdmVyc2lvbiwgZmlsZSk7CiAgICAgICAgY3R4LmV2ZW50U3Vic2NyaWJlTWFuYWdlci50cmlnZ2VyKElFdmVudFR5cGVzLkxvYWRpbmdTY3JpcHQsIG1vZHVsZU5hbWUsIHNjcmlwdFVybCk7CiAgICAgICAgaWYgKHR5cGVvZiBzY3JpcHRVcmwgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICBhd2FpdCBjdHguc2NyaXB0TG9hZGVyLmxvYWRTY3JpcHQoZG9jdW1lbnQuYm9keSwgc2NyaXB0VXJsLCBtb2R1bGVOYW1lKTsKICAgICAgICAgIGZhY3RvcnkgPSBmYWN0b3JpZXMuZ2V0KG1vZHVsZVBhdGgpOwogICAgICAgICAgY3R4LmxvZ2dlci5sb2coIlthbWRdIHNjcmlwdCBsb2FkZWQiLCBmYWN0b3J5LCBtb2R1bGVQYXRoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgW2V4aXN0LCBmaWxlXSA9IGN0eC5mcy5wYXRoUmVkdWNlKG1vZHVsZVBhdGgpOwogICAgICAgIGlmIChleGlzdCAmJiBSZWZsZWN0LmhhcyhmaWxlLCAiY29udGVudCIpKSB7CiAgICAgICAgICBjb25zdCBjb250ZW50ID0gZmlsZS5jb250ZW50OwogICAgICAgICAgZmFjdG9yaWVzLnNldChtb2R1bGVQYXRoLCBjb250ZW50KTsKICAgICAgICAgIGZhY3RvcnkgPSBjb250ZW50OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWZhY3RvcnkpIHsKICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoYFthbWRdIG1vZHVsZSBlcnJvcjogJHttb2R1bGVQYXRofSBkb2VzIG5vdCBleGlzdC5gKTsKICAgICAgICByZXR1cm4gY2xlYXJBbGxUYXNrcyhlcnIpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBtb2R1bGVEZXBzID0gW107CiAgICBjb25zdCByZXF1aXJlQ3R4ID0geyBfX2Rpcm5hbWU6IG1vZHVsZVBhdGgsIGRlcHM6IG1vZHVsZURlcHMgfTsKICAgIGNvbnN0IHJlcXVpcmVfID0gZ2V0UmVxdWlyZUZ1bmMocmVxdWlyZUN0eCk7CiAgICBsZXQgZGVwTW9kdWxlTmFtZXMgPSBkZXBlbmRlbmNpZXMuZ2V0KG1vZHVsZVBhdGgpOwogICAgaWYgKHR5cGVvZiBmYWN0b3J5ID09PSAic3RyaW5nIikgewogICAgICBjb25zdCB7IGRlcHM6IF9kZXBNb2R1bGVOYW1lcywgZmFjdG9yeTogZmFjdG9yeV8gfSA9IGF3YWl0IGN0eC5wbHVnaW5SZWR1Y2UoYXN5bmMgKHByZVZhbHVlLCBwbHVnaW4pID0+IHsKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwbHVnaW4uYmVmb3JlTW9kdWxlR2VuZXJhdGUoX3RoaXMsIHByZVZhbHVlKTsKICAgICAgICByZXR1cm4geyByZXN1bHQ6IHsgLi4ucmVzdWx0LCBuYW1lOiBtb2R1bGVOYW1lIH0gfTsKICAgICAgfSwgeyBuYW1lOiBtb2R1bGVOYW1lLCBkZXBzOiBkZXBNb2R1bGVOYW1lcywgZmFjdG9yeSB9KTsKICAgICAgZmFjdG9yeSA9IGZhY3RvcnlfOwogICAgICBkZXBNb2R1bGVOYW1lcyA9IF9kZXBNb2R1bGVOYW1lczsKICAgIH0KICAgIGNvbnN0IF9leHBvcnRzID0ge307CiAgICBjb25zdCBjb21tb25qcyA9IHsKICAgICAgcmVxdWlyZTogcmVxdWlyZV8sCiAgICAgIG1vZHVsZTogeyBleHBvcnRzOiBfZXhwb3J0cyB9LAogICAgICBleHBvcnRzOiBfZXhwb3J0cwogICAgfTsKICAgIGxldCBkZXBzID0gW107CiAgICBpZiAoZGVwTW9kdWxlTmFtZXMgPT0gbnVsbCA/IHZvaWQgMCA6IGRlcE1vZHVsZU5hbWVzLmxlbmd0aCkgewogICAgICBkZXBzID0gYXdhaXQgUHJvbWlzZS5hbGwoZGVwTW9kdWxlTmFtZXMubWFwKChkZXBOYW1lKSA9PiB7CiAgICAgICAgaWYgKGNvbW1vbmpzW2RlcE5hbWVdKQogICAgICAgICAgcmV0dXJuIGNvbW1vbmpzW2RlcE5hbWVdOwogICAgICAgIHJldHVybiByZXF1aXJlXyhkZXBOYW1lKTsKICAgICAgfSkpOwogICAgfQogICAgdHJ5IHsKICAgICAgbGV0IGV4cG9ydHNSZXR1cm47CiAgICAgIGlmICh0eXBlb2YgZmFjdG9yeSA9PT0gInN0cmluZyIpIHsKICAgICAgICBleHBvcnRzUmV0dXJuID0gYXdhaXQgZXZhbChmYWN0b3J5KSguLi5kZXBzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBleHBvcnRzUmV0dXJuID0gYXdhaXQgZmFjdG9yeSguLi5kZXBzKTsKICAgICAgfQogICAgICBjdHguZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLnRyaWdnZXIoSUV2ZW50VHlwZXMuTW9kdWxlRGVwcywgcmVxdWlyZUN0eCk7CiAgICAgIGNvbnN0IG1vZHVsZV8gPSAoKCkgPT4gewogICAgICAgIGlmIChPYmplY3Qua2V5cyhjb21tb25qcy5tb2R1bGUuZXhwb3J0cykubGVuZ3RoIHx8IHR5cGVvZiBjb21tb25qcy5tb2R1bGUuZXhwb3J0cyAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiBjb21tb25qcy5tb2R1bGUuZXhwb3J0czsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cG9ydHNSZXR1cm47CiAgICAgIH0pKCk7CiAgICAgIGNhY2hlLnNldChtb2R1bGVQYXRoLCBtb2R1bGVfKTsKICAgICAgY3R4LmxvZ2dlci5sb2coIlthbWRdIHJlc29sdmUgbW9kdWxlIHRhc2tzIGhlYWQiLCBtb2R1bGVQYXRoLCBtb2R1bGVfKTsKICAgICAgcmV0dXJuIGNsZWFyQWxsVGFza3Modm9pZCAwLCBtb2R1bGVfKTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICByZXR1cm4gY2xlYXJBbGxUYXNrcyhlcnIsIHZvaWQgMCk7CiAgICB9CiAgfTsKICBjb25zdCBnZXRSZXF1aXJlRnVuYyA9IChfdGhpczIpID0+IHsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKGFzeW5jICguLi5hcmdzKSA9PiB7CiAgICAgIHZhciBfYSwgX2I7CiAgICAgIGNvbnN0IFttb2R1bGVOYW1lc18sIGNiXSA9IGFyZ3M7CiAgICAgIGNvbnN0IG1vZHVsZU5hbWVzID0gYXdhaXQgY3R4LnBsdWdpblJlZHVjZShhc3luYyAocHJlVmFsdWUsIHBsdWdpbikgPT4gewogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN1bHQ6IGF3YWl0IHBsdWdpbi5yZXF1aXJlKF90aGlzMiwgcHJlVmFsdWUpCiAgICAgICAgfTsKICAgICAgfSwgbW9kdWxlTmFtZXNfKTsKICAgICAgaWYgKHR5cGVvZiBtb2R1bGVOYW1lcyA9PT0gInN0cmluZyIpIHsKICAgICAgICAoX2EgPSBfdGhpczIuZGVwcykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnB1c2gocmVzb2x2ZShtb2R1bGVOYW1lcywgX3RoaXMyLl9fZGlybmFtZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIChfYiA9IF90aGlzMi5kZXBzKSA9PSBudWxsID8gdm9pZCAwIDogX2IucHVzaCguLi5tb2R1bGVOYW1lcy5yZWR1Y2UoKHByZXZpb3VzVmFsdWUsIGN1cnJlbnRWYWx1ZSkgPT4gewogICAgICAgICAgcHJldmlvdXNWYWx1ZS5wdXNoKHJlc29sdmUoY3VycmVudFZhbHVlLCBfdGhpczIuX19kaXJuYW1lKSk7CiAgICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZTsKICAgICAgICB9LCBbXSkpOwogICAgICB9CiAgICAgIGxldCBtb2R1bGVzOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShtb2R1bGVOYW1lcykpIHsKICAgICAgICBtb2R1bGVzID0gYXdhaXQgUHJvbWlzZS5hbGwobW9kdWxlTmFtZXMubWFwKChuYW1lKSA9PiBtb2R1bGVGYWN0b3J5KG5hbWUsIF90aGlzMikpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtb2R1bGVzID0gYXdhaXQgbW9kdWxlRmFjdG9yeShtb2R1bGVOYW1lcywgX3RoaXMyKTsKICAgICAgfQogICAgICBjYiA9PSBudWxsID8gdm9pZCAwIDogY2IobW9kdWxlcyk7CiAgICAgIHJldHVybiBtb2R1bGVzOwogICAgfSwgewogICAgICBjYWNoZSwKICAgICAgZmFjdG9yaWVzLAogICAgICByZXNvbHZlLAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgIG1vZHVsZVJlcXVpcmluZ1Rhc2tzLAogICAgICByZXNvbHZlRGVwcwogICAgfSk7CiAgfTsKICBjdHgucmVxdWlyZSA9IGdldFJlcXVpcmVGdW5jKHsgX19kaXJuYW1lOiBjdHgucm9vdCB9KTsKfQpjb25zdCBjcmVhdGVFdmVudFN1YnNjcmliZU1hbmFnZXIgPSAoKSA9PiB7CiAgY29uc3QgZXZlbnRzSGFuZGxlcnNNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IHRyaWdnZXIgPSAoa2V5LCAuLi5wYXJhbXMpID0+IHsKICAgIGNvbnN0IGhhbmRsZXJzID0gZXZlbnRzSGFuZGxlcnNNYXAuZ2V0KGtleSk7CiAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgY29uc3QgZHJvcHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBoYW5kbGVycy5mb3JFYWNoKChoYW5kbGVyLCBpbmRleCkgPT4gewogICAgICAgIGlmIChoYW5kbGVyLmZpbHRlciAmJiAhaGFuZGxlci5maWx0ZXIoLi4ucGFyYW1zKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBoYW5kbGVyKC4uLnBhcmFtcyk7CiAgICAgICAgaWYgKGhhbmRsZXIub25jZSkgewogICAgICAgICAgZHJvcHMuc2V0KGluZGV4LCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBldmVudHNIYW5kbGVyc01hcC5zZXQoa2V5LCBoYW5kbGVycy5maWx0ZXIoKF8sIGluZGV4KSA9PiAhZHJvcHMuZ2V0KGluZGV4KSkpOwogICAgfQogIH07CiAgY29uc3QgbGlzdGVuID0gKGtleSwgY2IsIGZpbHRlcikgPT4gewogICAgdmFyIF9hLCBfYjsKICAgIGlmICghZXZlbnRzSGFuZGxlcnNNYXAuaGFzKGtleSkpIHsKICAgICAgZXZlbnRzSGFuZGxlcnNNYXAuc2V0KGtleSwgW10pOwogICAgfQogICAgY29uc3QgX2NiID0gT2JqZWN0LmFzc2lnbihjYiwgewogICAgICBmaWx0ZXIKICAgIH0pOwogICAgKF9iID0gKF9hID0gZXZlbnRzSGFuZGxlcnNNYXAuZ2V0KGtleSkpID09IG51bGwgPyB2b2lkIDAgOiBfYS5wdXNoKSA9PSBudWxsID8gdm9pZCAwIDogX2IuY2FsbChfYSwgX2NiKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBfYTI7CiAgICAgIGV2ZW50c0hhbmRsZXJzTWFwLnNldChrZXksIChfYTIgPSBldmVudHNIYW5kbGVyc01hcC5nZXQoa2V5KSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5maWx0ZXIoKGhhbmRsZXIpID0+IGhhbmRsZXIgIT09IF9jYikpOwogICAgfTsKICB9OwogIGNvbnN0IG9uY2UgPSAoa2V5LCBjYiwgZmlsdGVyLCBvblRpbWVvdXQsIHRpbWVvdXQgPSAtMSkgPT4gewogICAgdmFyIF9hLCBfYjsKICAgIGlmICghZXZlbnRzSGFuZGxlcnNNYXAuaGFzKGtleSkpIHsKICAgICAgZXZlbnRzSGFuZGxlcnNNYXAuc2V0KGtleSwgW10pOwogICAgfQogICAgY29uc3QgZGlzcG9zZSA9ICgpID0+IHsKICAgICAgdmFyIF9hMjsKICAgICAgZXZlbnRzSGFuZGxlcnNNYXAuc2V0KGtleSwgKF9hMiA9IGV2ZW50c0hhbmRsZXJzTWFwLmdldChrZXkpKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmZpbHRlcigoaGFuZGxlcikgPT4gaGFuZGxlciAhPT0gX2NiKSk7CiAgICB9OwogICAgbGV0IF90aW1lb3V0OwogICAgaWYgKHRpbWVvdXQgIT09IC0xKSB7CiAgICAgIF90aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgZGlzcG9zZSgpOwogICAgICAgIG9uVGltZW91dCA9PSBudWxsID8gdm9pZCAwIDogb25UaW1lb3V0KCk7CiAgICAgIH0sIHRpbWVvdXQpOwogICAgfQogICAgY29uc3QgX2NiID0gT2JqZWN0LmFzc2lnbigoLi4uYXJncykgPT4gewogICAgICBpZiAoX3RpbWVvdXQpCiAgICAgICAgY2xlYXJUaW1lb3V0KF90aW1lb3V0KTsKICAgICAgY2IoLi4uYXJncyk7CiAgICB9LCB7CiAgICAgIG9uY2U6IHRydWUsCiAgICAgIGZpbHRlcgogICAgfSk7CiAgICAoX2IgPSAoX2EgPSBldmVudHNIYW5kbGVyc01hcC5nZXQoa2V5KSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnB1c2gpID09IG51bGwgPyB2b2lkIDAgOiBfYi5jYWxsKF9hLCBfY2IpOwogICAgcmV0dXJuIGRpc3Bvc2U7CiAgfTsKICByZXR1cm4geyB0cmlnZ2VyLCBsaXN0ZW4sIG9uY2UgfTsKfTsKZnVuY3Rpb24gY3JlYXRlQW1kTWFuYWdlcihmczIsIHJvb3QgPSAiLyIsIHNjcmlwdFRpbWVvdXQgPSAxZTQsIGxvZ2dlcjIgPSBjb25zb2xlKSB7CiAgY29uc3QgY3R4MiA9IHt9OwogIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyID0gY3JlYXRlRXZlbnRTdWJzY3JpYmVNYW5hZ2VyKCk7CiAgY3R4Mi5mcyA9IGZzMjsKICBjdHgyLnJvb3QgPSByb290OwogIGN0eDIuc2NyaXB0VGltZW91dCA9IHNjcmlwdFRpbWVvdXQ7CiAgY3R4Mi5sb2dnZXIgPSBsb2dnZXIyOwogIGN0eDIucGx1Z2lucyA9IFtdOwogIGN0eDIucGx1Z2luUmVkdWNlID0gYXN5bmMgKHJlZHVjZXIsIGluaXRWYWx1ZSkgPT4gewogICAgbGV0IHJlc3VsdCA9IGluaXRWYWx1ZTsKICAgIGZvciAoY29uc3QgcGx1Z2luIG9mIGN0eDIucGx1Z2lucykgewogICAgICBjb25zb2xlLmxvZygicnVuIHBsdWdpbiIsIHBsdWdpbik7CiAgICAgIGNvbnN0IHsgcmVzdWx0OiByZXMsIGJyZWFrOiBicmVha18gfSA9IGF3YWl0IHJlZHVjZXIocmVzdWx0LCBwbHVnaW4pOwogICAgICBpZiAoYnJlYWtfKSB7CiAgICAgICAgcmV0dXJuIHJlczsKICAgICAgfQogICAgICByZXN1bHQgPSByZXM7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgYmluZFJlcXVpcmVUb0N0eChjdHgyKTsKICBiaW5kRGVmaW5lVG9DdHgoY3R4Mik7CiAgYmluZFNjcmlwdExvYWRlclRvQ3R4KGN0eDIpOwogIGZ1bmN0aW9uIGltcG9ydEdsb2JhbE9iamVjdFNjcmlwdCh0YXJnZXQsIHVybCwgbmFtZSkgewogICAgcmV0dXJuIGFzeW5jIChfcmVxdWlyZSkgPT4gewogICAgICBhd2FpdCBjdHgyLnNjcmlwdExvYWRlci5sb2FkU2NyaXB0KHRhcmdldCwgdXJsKTsKICAgICAgcmV0dXJuIHsKICAgICAgICAiZGVmYXVsdCI6IFJlZmxlY3QuZ2V0KHdpbmRvdywgbmFtZSksCiAgICAgICAgLi4uUmVmbGVjdC5nZXQod2luZG93LCBuYW1lKQogICAgICB9OwogICAgfTsKICB9CiAgY29uc3QgbW9kdWxlXzIgPSB7CiAgICByZXF1aXJlXzogY3R4Mi5yZXF1aXJlLAogICAgZGVmaW5lOiBjdHgyLmRlZmluZSwKICAgIF9pbXBvcnQ6IGltcG9ydEdsb2JhbE9iamVjdFNjcmlwdC5iaW5kKG51bGwsIGRvY3VtZW50LmJvZHkpLAogICAgb25Nb2R1bGVVcGRhdGUodGFyZ2V0cywgY2IpIHsKICAgICAgcmV0dXJuIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLmxpc3RlbihJRXZlbnRUeXBlcy5Nb2R1bGVVcGRhdGUsIChtb2R1bGVOYW1lMikgPT4gewogICAgICAgIGlmICghdGFyZ2V0cyB8fCB0YXJnZXRzLmluY2x1ZGVzKG1vZHVsZU5hbWUyKSkgewogICAgICAgICAgY2IoW21vZHVsZU5hbWUyXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBvbk1vZHVsZUxvYWRpbmcoY2IpIHsKICAgICAgcmV0dXJuIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLmxpc3RlbihJRXZlbnRUeXBlcy5Mb2FkaW5nU2NyaXB0LCAobW9kdWxlTmFtZTIsIHVybCkgPT4gewogICAgICAgIGNiKG1vZHVsZU5hbWUyLCB1cmwpOwogICAgICB9KTsKICAgIH0sCiAgICBvbk1vZHVsZURlcHMoY2IpIHsKICAgICAgcmV0dXJuIGN0eDIuZXZlbnRTdWJzY3JpYmVNYW5hZ2VyLmxpc3RlbihJRXZlbnRUeXBlcy5Nb2R1bGVEZXBzLCAoX3RoaXMyKSA9PiB7CiAgICAgICAgaWYgKCFfdGhpczIuZGVwcykgewogICAgICAgICAgZGVidWdnZXI7CiAgICAgICAgfQogICAgICAgIGNiKF90aGlzMi5kZXBzIHx8IFtdLCBfdGhpczIuX19kaXJuYW1lKTsKICAgICAgfSk7CiAgICB9LAogICAgbW91bnRUb0dsb2JhbChnbG9iYWxfID0gd2luZG93KSB7CiAgICAgIGNvbnN0IGN1cnJlbnREZWZpbmUgPSBSZWZsZWN0LmdldChnbG9iYWxfLCAiZGVmaW5lIik7CiAgICAgIGNvbnN0IGN1cnJlbnRSZXF1aXJlID0gUmVmbGVjdC5nZXQoZ2xvYmFsXywgInJlcXVpcmUiKTsKICAgICAgUmVmbGVjdC5zZXQoZ2xvYmFsXywgImRlZmluZSIsIGN0eDIuZGVmaW5lKTsKICAgICAgUmVmbGVjdC5zZXQoZ2xvYmFsXywgInJlcXVpcmUiLCBjdHgyLnJlcXVpcmUpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIFJlZmxlY3Quc2V0KGdsb2JhbF8sICJkZWZpbmUiLCBjdXJyZW50RGVmaW5lKTsKICAgICAgICBSZWZsZWN0LnNldChnbG9iYWxfLCAicmVxdWlyZSIsIGN1cnJlbnRSZXF1aXJlKTsKICAgICAgfTsKICAgIH0sCiAgICBzZXRQbHVnaW5zKHBsdWdpbnMpIHsKICAgICAgY3R4Mi5wbHVnaW5zID0gcGx1Z2luczsKICAgIH0KICB9OwogIHJldHVybiBtb2R1bGVfMjsKfQp2YXIgRmlsZXNDaGFuZ2VUeXBlID0gLyogQF9fUFVSRV9fICovICgoRmlsZXNDaGFuZ2VUeXBlMikgPT4gewogIEZpbGVzQ2hhbmdlVHlwZTJbIkRlbGV0ZSJdID0gImRlbGV0ZSI7CiAgRmlsZXNDaGFuZ2VUeXBlMlsiQ2hhbmdlIl0gPSAiY2hhbmdlIjsKICBGaWxlc0NoYW5nZVR5cGUyWyJOZXciXSA9ICJuZXciOwogIHJldHVybiBGaWxlc0NoYW5nZVR5cGUyOwp9KShGaWxlc0NoYW5nZVR5cGUgfHwge30pOwpjb25zdCBnZXRQYXRoRmlsZU5hbWUgPSAocGF0aE9iamVjdCkgPT4gYCR7cGF0aE9iamVjdC5uYW1lfSR7cGF0aE9iamVjdC5leHR9YDsKY29uc3QgdHJhdmVyc2UgPSAoZGlyID0gIiIsIGRpcmVjdG9yeSwgY2IpID0+IHsKICBkaXJlY3RvcnkuY2hpbGRyZW4uZm9yRWFjaCgoaXRlbSkgPT4gewogICAgaWYgKFJlZmxlY3QuaGFzKGl0ZW0sICJjaGlsZHJlbiIpKSB7CiAgICAgIHRyYXZlcnNlKGAke3BhdGhCcm93c2VyaWZ5fS8ke2l0ZW0ubmFtZX1gLCBpdGVtLCBjYik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNiKGAke3BhdGhCcm93c2VyaWZ5fS8ke2l0ZW0ubmFtZX1gLCBpdGVtKTsKICB9KTsKfTsKY2xhc3MgRmlsZXNTeXN0ZW0gewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5yb290ID0gewogICAgICBuYW1lOiAiIiwKICAgICAgY2hpbGRyZW46IHRoaXMuZ2V0UHJveHlNYXAoIiIsIFtdKQogICAgfTsKICAgIHRoaXMuZXZlbnRDb3VudCA9IDA7CiAgICB0aGlzLmV2ZW50ID0gY3JlYXRlRXZlbnRTdWJzY3JpYmVNYW5hZ2VyKCk7CiAgICB0aGlzLmNwID0gdGhpcy5jcE9yTXYuYmluZCh0aGlzLCBmYWxzZSk7CiAgICB0aGlzLm12ID0gdGhpcy5jcE9yTXYuYmluZCh0aGlzLCB0cnVlKTsKICB9CiAgZ2V0UHJveHlNYXAocGF0aDIsIGVudHJpZXMpIHsKICAgIGNvbnN0IF90aGlzMiA9IHRoaXM7CiAgICBjb25zdCBtYXAgPSBuZXcgTWFwKGVudHJpZXMpOwogICAgY29uc3QgcHJveHlNZXRob2QgPSAobWV0aG9kTmFtZSwgZXZlbnROYW1lKSA9PiB7CiAgICAgIGNvbnN0IF9tZXRob2QgPSBSZWZsZWN0LmdldChtYXAsIG1ldGhvZE5hbWUpOwogICAgICBpZiAodHlwZW9mIF9tZXRob2QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjb25zdCBtZXRob2QgPSBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgICBfdGhpczIuZXZlbnQudHJpZ2dlcihldmVudE5hbWUsIF90aGlzMi5ldmVudENvdW50KyssIHBhdGgyLCAuLi5hcmdzKTsKICAgICAgICAgIHJldHVybiBfbWV0aG9kLmNhbGwobWFwLCAuLi5hcmdzKTsKICAgICAgICB9OwogICAgICAgIFJlZmxlY3Quc2V0KG1hcCwgbWV0aG9kTmFtZSwgbWV0aG9kKTsKICAgICAgfQogICAgfTsKICAgIHByb3h5TWV0aG9kKCJzZXQiLCAiZGlyLXNldCIpOwogICAgcHJveHlNZXRob2QoImRlbGV0ZSIsICJkaXItZGVsZXRlIik7CiAgICBwcm94eU1ldGhvZCgiY2xlYXIiLCAiZGlyLWNsZWFyIik7CiAgICByZXR1cm4gbWFwOwogIH0KICBwYXRoUmVkdWNlKHRhcmdldCkgewogICAgY29uc3QgcGF0aHMgPSB0YXJnZXQuc3BsaXQocGF0aEJyb3dzZXJpZnkuc2VwKTsKICAgIHJldHVybiBwYXRocy5yZWR1Y2UoKFtzdGF0dXMsIGRpcl0sIGN1ciwgaW5kZXgsIGFycikgPT4gewogICAgICB2YXIgX2EsIF9iOwogICAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICByZXR1cm4gW3N0YXR1cywgZGlyXTsKICAgICAgfQogICAgICBpZiAoaW5kZXggPT09IGFyci5sZW5ndGggLSAxICYmIGN1ciA9PT0gIiIpIHsKICAgICAgICByZXR1cm4gW3N0YXR1cywgZGlyXTsKICAgICAgfQogICAgICByZXR1cm4gW3N0YXR1cyAmJiAoKF9hID0gZGlyLmNoaWxkcmVuKSA9PSBudWxsID8gdm9pZCAwIDogX2EuaGFzKGN1cikpLCAoX2IgPSBkaXIuY2hpbGRyZW4pID09IG51bGwgPyB2b2lkIDAgOiBfYi5nZXQoY3VyKV07CiAgICB9LCBbdHJ1ZSwgdGhpcy5yb290XSk7CiAgfQogIGV4aXN0KHRhcmdldCkgewogICAgY29uc3QgW2V4aXN0XSA9IHRoaXMucGF0aFJlZHVjZSh0YXJnZXQpOwogICAgcmV0dXJuIGV4aXN0OwogIH0KICBta2Rpcih0YXJnZXQpIHsKICAgIGNvbnN0IHBhdGhPYmplY3QgPSBwYXRoQnJvd3NlcmlmeS5wYXJzZSh0YXJnZXQpOwogICAgaWYgKHRoaXMuZXhpc3QodGFyZ2V0KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFtmc10gZmFpbGVkIHRvIG1rZGlyICR7dGFyZ2V0fSwgaXQgaXMgYWxyZWFkeSBleGlzdGVkLmApOwogICAgfQogICAgY29uc3QgW3BhcmVudEV4aXN0LCBwYXJlbnRdID0gdGhpcy5wYXRoUmVkdWNlKHBhdGhPYmplY3QuZGlyKTsKICAgIGlmICghcGFyZW50RXhpc3QpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBbZnNdIGZhaWxlZCB0byBta2RpciAke3RhcmdldH0sIHBhcmVudCBwYXRoICR7cGF0aE9iamVjdC5kaXJ9IGlzIG5vdCBleGlzdGVkLmApOwogICAgfQogICAgaWYgKCFSZWZsZWN0LmhhcyhwYXJlbnQsICJjaGlsZHJlbiIpIHx8IFJlZmxlY3QuaGFzKHBhcmVudCwgImNvbnRlbnQiKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFtmc10gZmFpbGVkIHRvIG1rZGlyICR7dGFyZ2V0fSwgcGFyZW50IHBhdGggJHtwYXRoT2JqZWN0LmRpcn0gaXMgbm90IGEgZGlyZWN0b3J5LmApOwogICAgfQogICAgcGFyZW50LmNoaWxkcmVuLnNldChnZXRQYXRoRmlsZU5hbWUocGF0aE9iamVjdCksIHsKICAgICAgbmFtZTogZ2V0UGF0aEZpbGVOYW1lKHBhdGhPYmplY3QpLAogICAgICBjaGlsZHJlbjogdGhpcy5nZXRQcm94eU1hcChwYXRoQnJvd3NlcmlmeS5mb3JtYXQocGF0aE9iamVjdCksIFtdKQogICAgfSk7CiAgfQogIHJlYWREaXJlY3RvcnkodGFyZ2V0KSB7CiAgICBjb25zdCBwYXRoT2JqZWN0ID0gcGF0aEJyb3dzZXJpZnkucGFyc2UodGFyZ2V0KTsKICAgIGNvbnN0IFtwYXJlbnRFeGlzdCwgcGFyZW50XSA9IHRoaXMucGF0aFJlZHVjZShwYXRoT2JqZWN0LmRpcik7CiAgICBpZiAoIXBhcmVudEV4aXN0KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgW2ZzXSBmYWlsZWQgdG8gcmVhZCBkaXJlY3RvcnkgJHt0YXJnZXR9LCBwYXJlbnQgcGF0aCAke3BhdGhPYmplY3QuZGlyfSBpcyBub3QgZXhpc3RlZC5gKTsKICAgIH0KICAgIHJldHVybiBwYXJlbnQuY2hpbGRyZW4uZ2V0KGdldFBhdGhGaWxlTmFtZShwYXRoT2JqZWN0KSk7CiAgfQogIHJlYWRGaWxlKHRhcmdldCkgewogICAgY29uc3QgW2V4aXN0LCBmaWxlXSA9IHRoaXMucGF0aFJlZHVjZSh0YXJnZXQpOwogICAgaWYgKCFleGlzdCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFtmc10gZmFpbGVkIHRvIHJlYWQgZmlsZSAke3RhcmdldH0sIGl0IGlzIG5vdCBleGlzdGVkLmApOwogICAgfQogICAgaWYgKFJlZmxlY3QuaGFzKGZpbGUsICJjaGlsZHJlbiIpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgW2ZzXSBmYWlsZWQgdG8gcmVhZCBmaWxlICR7dGFyZ2V0fSwgaXQgaXMgYSBkaXJlY3RvcnkuYCk7CiAgICB9CiAgICByZXR1cm4gZmlsZTsKICB9CiAgd3JpdGVGaWxlKHRhcmdldCwgY29udGVudHMpIHsKICAgIGNvbnN0IHBhdGhPYmplY3QgPSBwYXRoQnJvd3NlcmlmeS5wYXJzZSh0YXJnZXQpOwogICAgY29uc3QgW3BhcmVudEV4aXN0LCBwYXJlbnRdID0gdGhpcy5wYXRoUmVkdWNlKHBhdGhPYmplY3QuZGlyKTsKICAgIGlmICghcGFyZW50RXhpc3QpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBbZnNdIGZhaWxlZCB0byB3cml0ZSBmaWxlICR7dGFyZ2V0fSwgcGFyZW50IHBhdGggJHtwYXRoT2JqZWN0LmRpcn0gaXMgbm90IGV4aXN0ZWQuYCk7CiAgICB9CiAgICBsZXQgd3JpdGVDb250ZW50ID0gY29udGVudHM7CiAgICBpZiAodHlwZW9mIGNvbnRlbnRzICE9PSAic3RyaW5nIikgewogICAgICB3cml0ZUNvbnRlbnQgPSBidG9hKFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgbmV3IFVpbnQ4QXJyYXkoY29udGVudHMpKSk7CiAgICB9CiAgICBjb25zdCBleGlzdEJlZm9yZSA9IHBhcmVudC5jaGlsZHJlbi5oYXMoZ2V0UGF0aEZpbGVOYW1lKHBhdGhPYmplY3QpKTsKICAgIHBhcmVudC5jaGlsZHJlbi5zZXQoZ2V0UGF0aEZpbGVOYW1lKHBhdGhPYmplY3QpLCB7CiAgICAgIG5hbWU6IGdldFBhdGhGaWxlTmFtZShwYXRoT2JqZWN0KSwKICAgICAgY29udGVudDogd3JpdGVDb250ZW50CiAgICB9KTsKICAgIHRoaXMuZXZlbnQudHJpZ2dlcigiZmlsZXMtY2hhbmdlIiwgdGhpcy5ldmVudENvdW50KyssIGV4aXN0QmVmb3JlID8gImNoYW5nZSIgOiAibmV3IiwgW3RhcmdldF0pOwogIH0KICBjcE9yTXYoaXNNdiA9IGZhbHNlLCBzb3VyY2UsIHRhcmdldCkgewogICAgY29uc3Qgc291cmNlUGF0aE9iamVjdCA9IHBhdGhCcm93c2VyaWZ5LnBhcnNlKHNvdXJjZSk7CiAgICBjb25zdCB0YXJnZXRQYXRoT2JqZWN0ID0gcGF0aEJyb3dzZXJpZnkucGFyc2UodGFyZ2V0KTsKICAgIGNvbnN0IFtzb3VyY2VQYXJlbnRFeGlzdCwgc291cmNlUGFyZW50XSA9IHRoaXMucGF0aFJlZHVjZShzb3VyY2VQYXRoT2JqZWN0LmRpcik7CiAgICBjb25zdCBbdGFyZ2V0UGFyZW50RXhpc3QsIHRhcmdldFBhcmVudF0gPSB0aGlzLnBhdGhSZWR1Y2UodGFyZ2V0UGF0aE9iamVjdC5kaXIpOwogICAgaWYgKCFzb3VyY2VQYXJlbnRFeGlzdCB8fCAhdGFyZ2V0UGFyZW50RXhpc3QpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBbZnNdIGZhaWxlZCB0byAke2lzTXYgPyAibXYiIDogImNwIn0gJHtzb3VyY2V9IHRvICR7dGFyZ2V0fSwgc291cmNlIG9yIHRhcmdldCBwYXRoIGlzIG5vdCBleGlzdGVkLmApOwogICAgfQogICAgaWYgKHRhcmdldFBhcmVudC5jaGlsZHJlbi5oYXMoZ2V0UGF0aEZpbGVOYW1lKHRhcmdldFBhdGhPYmplY3QpKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFtmc10gZmFpbGVkIHRvICR7aXNNdiA/ICJtdiIgOiAiY3AifSAke3NvdXJjZX0gdG8gJHt0YXJnZXR9LCB0YXJnZXQgcGF0aCBpcyBhbHJlYWR5IGV4aXN0ZWQuYCk7CiAgICB9CiAgICB0YXJnZXRQYXJlbnQuY2hpbGRyZW4uc2V0KGdldFBhdGhGaWxlTmFtZSh0YXJnZXRQYXRoT2JqZWN0KSwgc291cmNlUGFyZW50LmNoaWxkcmVuLmdldChnZXRQYXRoRmlsZU5hbWUoc291cmNlUGF0aE9iamVjdCkpKTsKICAgIGNvbnN0IHNvdXJjZUZpbGVPckRpcmVjdG9yeSA9IHNvdXJjZVBhcmVudC5jaGlsZHJlbi5nZXQoc291cmNlKTsKICAgIGNvbnN0IGRlbGV0ZWRGaWxlcyA9IFtdOwogICAgY29uc3QgbmV3RmlsZXMgPSBbXTsKICAgIGlmIChSZWZsZWN0Lmhhcyhzb3VyY2VGaWxlT3JEaXJlY3RvcnksICJjb250ZW50IikpIHsKICAgICAgZGVsZXRlZEZpbGVzLnB1c2goc291cmNlKTsKICAgICAgbmV3RmlsZXMucHVzaCh0YXJnZXQpOwogICAgfSBlbHNlIHsKICAgICAgdHJhdmVyc2Uodm9pZCAwLCBzb3VyY2VGaWxlT3JEaXJlY3RvcnksIChwYXRoXykgPT4gewogICAgICAgIGRlbGV0ZWRGaWxlcy5wdXNoKHBhdGhCcm93c2VyaWZ5LmpvaW4oc291cmNlUGF0aE9iamVjdC5kaXIsIHBhdGhfKSk7CiAgICAgICAgbmV3RmlsZXMucHVzaChwYXRoQnJvd3NlcmlmeS5qb2luKHRhcmdldFBhdGhPYmplY3QuZGlyLCBwYXRoXykpOwogICAgICB9KTsKICAgIH0KICAgIGlmIChpc012KSB7CiAgICAgIHNvdXJjZVBhcmVudC5jaGlsZHJlbi5kZWxldGUoZ2V0UGF0aEZpbGVOYW1lKHNvdXJjZVBhdGhPYmplY3QpKTsKICAgICAgdGhpcy5ldmVudC50cmlnZ2VyKCJmaWxlcy1jaGFuZ2UiLCB0aGlzLmV2ZW50Q291bnQrKywgImRlbGV0ZSIsIGRlbGV0ZWRGaWxlcyk7CiAgICB9CiAgICB0aGlzLmV2ZW50LnRyaWdnZXIoImZpbGVzLWNoYW5nZSIsIHRoaXMuZXZlbnRDb3VudCsrLCAibmV3IiwgbmV3RmlsZXMpOwogIH0KICBybSh0YXJnZXQpIHsKICAgIGNvbnN0IHBhdGhPYmplY3QgPSBwYXRoQnJvd3NlcmlmeS5wYXJzZSh0YXJnZXQpOwogICAgY29uc3QgW3BhcmVudEV4aXN0LCBwYXJlbnRdID0gdGhpcy5wYXRoUmVkdWNlKHBhdGhPYmplY3QuZGlyKTsKICAgIGlmICghcGFyZW50RXhpc3QgfHwgIXBhcmVudC5jaGlsZHJlbi5oYXMoZ2V0UGF0aEZpbGVOYW1lKHBhdGhPYmplY3QpKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFtmc10gZmFpbGVkIHRvIHJtICR7dGFyZ2V0fSwgaXQgaXMgbm90IGV4aXN0ZWQuYCk7CiAgICB9CiAgICBjb25zdCB0YXJnZXRGaWxlT3JEaXJlY3RvcnkgPSBwYXJlbnQuY2hpbGRyZW4uZ2V0KHRhcmdldCk7CiAgICBjb25zdCBkZWxldGVkRmlsZXMgPSBbXTsKICAgIGlmIChSZWZsZWN0Lmhhcyh0YXJnZXRGaWxlT3JEaXJlY3RvcnksICJjb250ZW50IikpIHsKICAgICAgZGVsZXRlZEZpbGVzLnB1c2godGFyZ2V0KTsKICAgIH0gZWxzZSB7CiAgICAgIHRyYXZlcnNlKHZvaWQgMCwgdGFyZ2V0RmlsZU9yRGlyZWN0b3J5LCAocGF0aF8pID0+IHsKICAgICAgICBkZWxldGVkRmlsZXMucHVzaChwYXRoQnJvd3NlcmlmeS5qb2luKHBhdGhPYmplY3QuZGlyLCBwYXRoXykpOwogICAgICB9KTsKICAgIH0KICAgIHBhcmVudC5jaGlsZHJlbi5kZWxldGUoZ2V0UGF0aEZpbGVOYW1lKHBhdGhPYmplY3QpKTsKICAgIHRoaXMuZXZlbnQudHJpZ2dlcigiZmlsZXMtY2hhbmdlIiwgdGhpcy5ldmVudENvdW50KyssICJkZWxldGUiLCBkZWxldGVkRmlsZXMpOwogIH0KICAvKioKICAgKiDluo/liJfljJblhoXpg6jlrZjlgqjnmoTmiYDmnInmlbDmja4KICAgKi8KICBnZXREYXRhUGF5bG9hZCgpIHsKICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnJvb3QsIChrZXksIHZhbHVlKSA9PiB7CiAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE1hcCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBfX2RhdGFUeXBlOiAiTWFwIiwKICAgICAgICAgIGVudHJpZXM6IEFycmF5LmZyb20odmFsdWUuZW50cmllcygpKQogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSk7CiAgfQogIC8qKgogICAqIOinpuWPkeWwhuaWh+S7tuWvueixoeWtmOWCqOeahOaVsOaNruS8oOi+k+WIsOi/nOerr+eahOS6i+S7tgogICAqLwogIHRyYW5zZmVyKCkgewogICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZ2V0RGF0YVBheWxvYWQoKTsKICAgIHRoaXMuZXZlbnQudHJpZ2dlcigidHJhbnNmZXIiLCB0aGlzLmV2ZW50Q291bnQrKywgIiIsIHBheWxvYWQpOwogIH0KICAvKioKICAgKiDmjqXmlLblpJbpg6jorr7nva7nmoTmlbDmja4KICAgKiBAcGFyYW0gcGF5bG9hZCDlupXlsYLmlbDmja4KICAgKi8KICByZWNlaXZlKHBheWxvYWQpIHsKICAgIGNvbnN0IHRyYXZlcnNlMiA9IChvYmosIHBhdGgyID0gIiIpID0+IHsKICAgICAgaWYgKG9iai5jaGlsZHJlbiAmJiBSZWZsZWN0LmdldChvYmouY2hpbGRyZW4sICJfX2RhdGFUeXBlIikgPT09ICJNYXAiKSB7CiAgICAgICAgY29uc3QgZW50cmllcyA9IG9iai5jaGlsZHJlbi5lbnRyaWVzLm1hcCgoW2tleSwgdmFsdWVdKSA9PiBba2V5LCB0cmF2ZXJzZTIodmFsdWUsIFtwYXRoMiwga2V5XS5qb2luKCIvIikpXSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC4uLm9iaiwKICAgICAgICAgIGNoaWxkcmVuOiB0aGlzLmdldFByb3h5TWFwKHBhdGgyLCBlbnRyaWVzKQogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIG9iajsKICAgIH07CiAgICBjb25zdCByb290ID0gdHJhdmVyc2UyKEpTT04ucGFyc2UocGF5bG9hZCkpOwogICAgdGhpcy5yb290ID0gcm9vdDsKICAgIGNvbnNvbGUubG9nKCJ0aGlzLnJvb3QiLCByb290KTsKICAgIHRoaXMuZXZlbnQudHJpZ2dlcigicmVjZWl2ZSIsIHRoaXMuZXZlbnRDb3VudCsrKTsKICB9Cn0KY29uc3QgTk9USUZJQ0FUSU9OX1NFUlZJQ0UgPSAiaWZyYW1lLW5vdGlmaWNhdGlvbi1zZXJ2aWNlIjsKY29uc3QgaWZyYW1lUmVhZHkgPSBhc3luYyAoKSA9PiB7CiAgcmVnaXN0ZXJQcm94eShOT1RJRklDQVRJT05fU0VSVklDRSwgewogICAgaWZyYW1lUmVhZHk6IGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSk7CiAgY29uc3QgcGFyZW50ID0gd2luZG93LnRvcCB8fCB3aW5kb3cucGFyZW50IHx8IHdpbmRvdy5vcGVuZXI7CiAgaWYgKCFwYXJlbnQpCiAgICByZXR1cm47CiAgcmV0dXJuIGNhbGxQcm94eSh7CiAgICB3aW46IHBhcmVudCwKICAgIHNlcnZpY2VJZDogTk9USUZJQ0FUSU9OX1NFUlZJQ0UsCiAgICBtZXRob2Q6ICJpZnJhbWVSZWFkeSIsCiAgICBwYXlsb2FkOiBbXQogIH0pOwp9Owpjb25zdCBpZnJhbWVMb2FkaW5nTW9kdWxlID0gYXN5bmMgKG1vZHVsZU5hbWUyLCBleHRyYUluZm8pID0+IHsKICBjb25zdCBwYXJlbnQgPSB3aW5kb3cudG9wIHx8IHdpbmRvdy5wYXJlbnQgfHwgd2luZG93Lm9wZW5lcjsKICBpZiAoIXBhcmVudCkKICAgIHJldHVybjsKICByZXR1cm4gY2FsbFByb3h5KHsKICAgIHdpbjogcGFyZW50LAogICAgc2VydmljZUlkOiBOT1RJRklDQVRJT05fU0VSVklDRSwKICAgIG1ldGhvZDogImlmcmFtZUxvYWRpbmdNb2R1bGUiLAogICAgcGF5bG9hZDogW21vZHVsZU5hbWUyLCBleHRyYUluZm9dCiAgfSk7Cn07CmNvbnN0IFN5bmNTZXJ2aWNlTmFtZSA9ICJjb2RlLXNhbmRib3gtc3luYy1maWxlcyI7CmFzeW5jIGZ1bmN0aW9uIGluaXRJZnJhbWVGaWxlc1N5bmNTZXJ2aWNlKGZzMikgewogIGNvbnN0IGNhY2hlUXVldWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGxldCBjdXJyZW50Q291bnQgPSAwOwogIGNvbnN0IGRpc3Bvc2UgPSByZWdpc3RlclByb3h5KFN5bmNTZXJ2aWNlTmFtZSwgewogICAgc3luYzogYXN5bmMgKGV2ZW50VHlwZSwgb3JkZXJDb3VudCwgcGF0aCwgLi4uYXJncykgPT4gewogICAgICBjYWNoZVF1ZXVlLnNldChvcmRlckNvdW50LCBbZXZlbnRUeXBlLCBwYXRoLCAuLi5hcmdzXSk7CiAgICAgIHdoaWxlIChjYWNoZVF1ZXVlLmdldChjdXJyZW50Q291bnQpKSB7CiAgICAgICAgY29uc3QgW2V2ZW50VHlwZTIsIHBhdGgyLCAuLi5hcmdzMl0gPSBjYWNoZVF1ZXVlLmdldChjdXJyZW50Q291bnQpOwogICAgICAgIGNhY2hlUXVldWUuZGVsZXRlKGN1cnJlbnRDb3VudCk7CiAgICAgICAgY3VycmVudENvdW50Kys7CiAgICAgICAgY29uc3QgWywgZGlyX10gPSBmczIucGF0aFJlZHVjZShwYXRoMik7CiAgICAgICAgY29uc3QgZGlyID0gZGlyXzsKICAgICAgICBzd2l0Y2ggKGV2ZW50VHlwZTIpIHsKICAgICAgICAgIGNhc2UgInRyYW5zZmVyIjogewogICAgICAgICAgICBmczIucmVjZWl2ZS5hcHBseShmczIsIGFyZ3MyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJkaXItY2xlYXIiOiB7CiAgICAgICAgICAgIGRpci5jaGlsZHJlbi5jbGVhcigpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgImRpci1zZXQiOiB7CiAgICAgICAgICAgIGRpci5jaGlsZHJlbi5zZXQuYXBwbHkoZGlyLmNoaWxkcmVuLCBhcmdzMik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAiZGlyLWRlbGV0ZSI6IHsKICAgICAgICAgICAgZGlyLmNoaWxkcmVuLmRlbGV0ZS5hcHBseShkaXIuY2hpbGRyZW4sIGFyZ3MyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJmaWxlcy1jaGFuZ2UiOiB7CiAgICAgICAgICAgIGZzMi5ldmVudC50cmlnZ2VyKGV2ZW50VHlwZTIsIHBhdGgyLCAuLi5hcmdzMik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIGNvbnN0IHBheWxvYWQgPSBhd2FpdCBjYWxsUHJveHkoewogICAgd2luOiBzZWxmLnBhcmVudCB8fCBzZWxmLm9wZW5lciB8fCBzZWxmLnRvcCwKICAgIG1ldGhvZDogInJlcXVlc3RGcyIsCiAgICBzZXJ2aWNlSWQ6IFN5bmNTZXJ2aWNlTmFtZSwKICAgIHBheWxvYWQ6IFtdCiAgfSk7CiAgaWYgKHBheWxvYWQpIHsKICAgIGZzMi5yZWNlaXZlKHBheWxvYWQpOwogICAgY29uc29sZS5sb2coInJlY2VpdmUiLCBwYXlsb2FkLCBmczIpOwogICAgcmV0dXJuOwogIH0KICByZXR1cm4gZGlzcG9zZTsKfQpjb25zdCBEZW1vU2VydmljZU5hbWUgPSAiZGVtby1zZXJ2aWNlIjsKZnVuY3Rpb24gZ2VuZXJhdGVQbHVnaW5zKHBsdWdpbnNTZXJ2aWNlSWQpIHsKICBjb25zdCBwYXJlbnQgPSB3aW5kb3cucGFyZW50IHx8IHdpbmRvdy50b3AgfHwgd2luZG93Lm9wZW5lcjsKICBjb25zdCBnZW5lcmF0ZU1ldGhvZCA9IChrZXksIHNlcnZpY2VJZCkgPT4gYXN5bmMgKC4uLmFyZ3MpID0+IHsKICAgIGF3YWl0IHdhaXRQcm94eShwYXJlbnQsIHNlcnZpY2VJZCk7CiAgICByZXR1cm4gYXdhaXQgY2FsbFByb3h5KHsKICAgICAgd2luOiBwYXJlbnQsCiAgICAgIHNlcnZpY2VJZCwKICAgICAgbWV0aG9kOiBrZXksCiAgICAgIHBheWxvYWQ6IGFyZ3MKICAgIH0pOwogIH07CiAgcmV0dXJuIHBsdWdpbnNTZXJ2aWNlSWQubWFwKChzZXJ2aWNlSWQpID0+IHsKICAgIGNvbnN0IGtleXMgPSBbInJlcXVpcmUiLCAiYmVmb3JlTW9kdWxlR2VuZXJhdGUiLCAicmVzb2x2ZU1vZHVsZVVybCJdOwogICAgcmV0dXJuIGtleXMucmVkdWNlKChwcmUsIGtleSkgPT4gewogICAgICByZXR1cm4gewogICAgICAgIC4uLnByZSwKICAgICAgICBba2V5XTogZ2VuZXJhdGVNZXRob2Qoa2V5LCBzZXJ2aWNlSWQpCiAgICAgIH07CiAgICB9LCB7fSk7CiAgfSk7Cn0KY2xhc3MgRGVwc0dyYXBoIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuRGVwTm9kZUluZGV4ZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIH0KICBnZXREZXBOb2RlKF90YXJnZXQsIGNyZWF0ZSA9IGZhbHNlKSB7CiAgICBjb25zdCB0YXJnZXQgPSBfdGFyZ2V0LnJlcGxhY2UoL1wvJC8sICIiKTsKICAgIGlmICghdGhpcy5EZXBOb2RlSW5kZXhlcy5oYXModGFyZ2V0KSAmJiBjcmVhdGUpIHsKICAgICAgdGhpcy5EZXBOb2RlSW5kZXhlcy5zZXQodGFyZ2V0LCB7CiAgICAgICAgcGF0aDogdGFyZ2V0LAogICAgICAgIGNvbWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgICAgICAgb3V0OiAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXMuRGVwTm9kZUluZGV4ZXMuZ2V0KHRhcmdldCk7CiAgfQogIC8qKgogICAqIOabtOaWsCBmcm9tIC0+IHRvIOeahOi3r+W+hAogICAqIEBwYXJhbSBmcm9tIOi1t+eCuSBub2RlIOaVsOe7hAogICAqIEBwYXJhbSB0byDnu4jngrkgbm9kZQogICAqLwogIHVwZGF0ZVBhdGhzKGZyb20sIHRvKSB7CiAgICBjb25zdCB0YXJnZXROb2RlID0gdGhpcy5nZXREZXBOb2RlKHRvLCB0cnVlKTsKICAgIGlmICh0YXJnZXROb2RlLmNvbWUuc2l6ZSkgewogICAgICB0YXJnZXROb2RlLmNvbWUuZm9yRWFjaCgoZGVwTm9kZSkgPT4gewogICAgICAgIGRlcE5vZGUub3V0LmRlbGV0ZSh0YXJnZXROb2RlKTsKICAgICAgfSk7CiAgICAgIHRhcmdldE5vZGUuY29tZS5jbGVhcigpOwogICAgfQogICAgZnJvbS5mb3JFYWNoKChub2RlUGF0aCkgPT4gewogICAgICBjb25zdCBkZXBOb2RlID0gdGhpcy5nZXREZXBOb2RlKG5vZGVQYXRoLCB0cnVlKTsKICAgICAgdGFyZ2V0Tm9kZS5jb21lLmFkZChkZXBOb2RlKTsKICAgICAgZGVwTm9kZS5vdXQuYWRkKHRhcmdldE5vZGUpOwogICAgfSk7CiAgfQogIC8qKgogICAqIOWIoOmZpCBmcm9tIC0+IHRvIOeahOi3r+W+hAogICAqIEBwYXJhbSBmcm9tIOi1t+eCuSBub2RlIOaVsOe7hAogICAqIEBwYXJhbSB0byDnu4jngrkgbm9kZQogICAqLwogIGRlbGV0ZVBhdGhzKGZyb20sIHRvKSB7CiAgICBjb25zdCB0YXJnZXROb2RlID0gdGhpcy5nZXREZXBOb2RlKHRvKTsKICAgIGlmICghdGFyZ2V0Tm9kZSkKICAgICAgcmV0dXJuIGZhbHNlOwogICAgZnJvbS5mb3JFYWNoKChzb3VyY2VQYXRoKSA9PiB7CiAgICAgIGNvbnN0IHNvdXJjZU5vZGUgPSB0aGlzLmdldERlcE5vZGUoc291cmNlUGF0aCk7CiAgICAgIGlmICghc291cmNlTm9kZSkKICAgICAgICByZXR1cm47CiAgICAgIHNvdXJjZU5vZGUub3V0LmRlbGV0ZSh0YXJnZXROb2RlKTsKICAgICAgdGFyZ2V0Tm9kZS5jb21lLmRlbGV0ZShzb3VyY2VOb2RlKTsKICAgICAgdGhpcy5kZWxldGVOb2RlKHNvdXJjZU5vZGUucGF0aCk7CiAgICB9KTsKICB9CiAgLyoqCiAgICog5Yig6Zmk5oyH5a6a55qE5L6d6LWW6IqC54K5CiAgICogQHBhcmFtIHNvdXJjZQogICAqLwogIGRlbGV0ZU5vZGUoc291cmNlKSB7CiAgICBjb25zdCBzb3VyY2VOb2RlID0gdGhpcy5nZXREZXBOb2RlKHNvdXJjZSk7CiAgICBpZiAoIXNvdXJjZU5vZGUpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIHRoaXMuRGVwTm9kZUluZGV4ZXMuZGVsZXRlKHNvdXJjZSk7CiAgICBpZiAoc291cmNlTm9kZS5jb21lLnNpemUpIHsKICAgICAgc291cmNlTm9kZS5jb21lLmZvckVhY2goKGNvbWVOb2RlKSA9PiB7CiAgICAgICAgY29tZU5vZGUub3V0LmRlbGV0ZShzb3VyY2VOb2RlKTsKICAgICAgICBpZiAoIWNvbWVOb2RlLm91dC5zaXplKSB7CiAgICAgICAgICB0aGlzLmRlbGV0ZU5vZGUoY29tZU5vZGUucGF0aCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICAvKioKICAgKiDpgY3ljobmiYDmnInnm7TmjqXmiJbogIXpl7TmjqXkvp3otZYgc291cmNlIOeahOiKgueCuQogICAqIEBwYXJhbSBzb3VyY2Ug6KaB6YGN5Y6G55qE6IqC54K5CiAgICogQHBhcmFtIGNiIOWvueavj+S4quiKgueCueeahOWkhOeQhgogICAqIEBwYXJhbSB0cmFja2VkIOeUqOS6juWtmOWCqOmBjeWOhui/h+eahOiKgueCuQogICAqIEBwYXJhbSB3YWl0IOeUqOS6juWtmOWCqOmcgOimgemBjeWOhueahOiKgueCuQogICAqIEBwYXJhbSBvcmRlciDmmK/lkKbmjInnhafpobrluo/lvIDlp4vpgY3ljoYKICAgKi8KICB0cmF2ZXJzZShzb3VyY2UsIGNiLCB0cmFja2VkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwgd2FpdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksIG9yZGVyID0gdHJ1ZSkgewogICAgY29uc3QgaXNBbGxEZXBzVHJhY2tlZCA9IChub2RlKSA9PiBBcnJheS5mcm9tKG5vZGUuY29tZSkuZXZlcnkoKGRlcCkgPT4gIXdhaXQuaGFzKGRlcC5wYXRoKSB8fCB0cmFja2VkLmhhcyhkZXAucGF0aCkpOwogICAgY29uc3QgdHJhdmVyc2UyID0gKG5vZGUsIG9yZGVyMiA9IGZhbHNlLCBjYl8pID0+IHsKICAgICAgaWYgKCFvcmRlcjIpIHsKICAgICAgICB3YWl0LmFkZChub2RlLnBhdGgpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghaXNBbGxEZXBzVHJhY2tlZChub2RlKSkKICAgICAgICAgIHJldHVybjsKICAgICAgICB0cmFja2VkLmFkZChub2RlLnBhdGgpOwogICAgICAgIGNiXyA9PSBudWxsID8gdm9pZCAwIDogY2JfKG5vZGUsIHRyYWNrZWQuc2l6ZSwgd2FpdC5zaXplKTsKICAgICAgfQogICAgICBub2RlLm91dC5mb3JFYWNoKChjaGlsZCkgPT4gewogICAgICAgIGlmICghb3JkZXIyIHx8IGlzQWxsRGVwc1RyYWNrZWQoY2hpbGQpKSB7CiAgICAgICAgICB0cmF2ZXJzZTIoY2hpbGQsIG9yZGVyMiwgY2JfKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICAgIGNvbnN0IHNvdXJjZU5vZGUgPSB0aGlzLmdldERlcE5vZGUoc291cmNlKTsKICAgIGlmICghc291cmNlTm9kZSkKICAgICAgcmV0dXJuOwogICAgdHJhdmVyc2UyKHNvdXJjZU5vZGUsIGZhbHNlLCBjYik7CiAgICBpZiAob3JkZXIpIHsKICAgICAgdHJhdmVyc2UyKHNvdXJjZU5vZGUsIHRydWUsIGNiKTsKICAgIH0KICB9CiAgLyoqCiAgICog5om56YeP6YGN5Y6G55u05o6l5oiW6ICF6Ze05o6lIHNvdXJjZXMg6IqC54K555qE5omA5pyJ6IqC54K5CiAgICogQHBhcmFtIHNvdXJjZXMg6KKr5L6d6LWW55qE6IqC54K55pWw57uECiAgICogQHBhcmFtIGNiIOWvueavj+S4quiKgueCueeahOWkhOeQhgogICAqLwogIGJhdGNoVHJhdmVyc2Uoc291cmNlcywgY2IpIHsKICAgIGNvbnN0IHRyYWNrZWQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3Qgd2FpdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBzb3VyY2VzLmZvckVhY2goKHNvdXJjZSkgPT4gewogICAgICB0aGlzLnRyYXZlcnNlKHNvdXJjZSwgY2IsIHRyYWNrZWQsIHdhaXQsIGZhbHNlKTsKICAgIH0pOwogICAgc291cmNlcy5mb3JFYWNoKChzb3VyY2UpID0+IHsKICAgICAgdGhpcy50cmF2ZXJzZShzb3VyY2UsIGNiLCB0cmFja2VkLCB3YWl0LCB0cnVlKTsKICAgIH0pOwogICAgcmV0dXJuIEFycmF5LmZyb20odHJhY2tlZCk7CiAgfQp9CmNvbnN0IGZzID0gbmV3IEZpbGVzU3lzdGVtKCk7CmNvbnN0IGZzU3luY1Byb21pc2UgPSBpbml0SWZyYW1lRmlsZXNTeW5jU2VydmljZShmcyk7CmNvbnN0IGRlcHNHcmFwaCA9IG5ldyBEZXBzR3JhcGgoKTsKY29uc3QgbWFuYWdlciA9IGNyZWF0ZUFtZE1hbmFnZXIoZnMsIHZvaWQgMCwgdm9pZCAwLCBsb2dnZXIpOwptYW5hZ2VyLm1vdW50VG9HbG9iYWwoKTsKY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwpkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKbWFuYWdlci5vbk1vZHVsZUxvYWRpbmcoaWZyYW1lTG9hZGluZ01vZHVsZSk7Cm1hbmFnZXIub25Nb2R1bGVEZXBzKGRlcHNHcmFwaC51cGRhdGVQYXRocy5iaW5kKGRlcHNHcmFwaCkpOwpmcy5ldmVudC5saXN0ZW4oImZpbGVzLWNoYW5nZSIsIGFzeW5jICh0eXBlLCBmaWxlcykgPT4gewogIGlmICh0eXBlID09PSBGaWxlc0NoYW5nZVR5cGUuQ2hhbmdlKSB7CiAgICBkZXBzR3JhcGguYmF0Y2hUcmF2ZXJzZShmaWxlcywgKG5vZGUpID0+IHsKICAgICAgbWFuYWdlci5yZXF1aXJlXy5mYWN0b3JpZXMuZGVsZXRlKG5vZGUucGF0aCk7CiAgICAgIG1hbmFnZXIucmVxdWlyZV8uY2FjaGUuZGVsZXRlKG5vZGUucGF0aCk7CiAgICAgIGlmIChub2RlLm91dC5zaXplKSB7CiAgICAgICAgbWFuYWdlci5yZXF1aXJlXyhub2RlLnBhdGgpOwogICAgICB9CiAgICB9KTsKICB9Cn0pOwpyZWdpc3RlclByb3h5KERlbW9TZXJ2aWNlTmFtZSwgewogIHJ1bjogYXN5bmMgKGpzRW50cnksIGh0bWxFbnRyeSwgc3R5bGVzRW50cnkpID0+IHsKICAgIGF3YWl0IGZzU3luY1Byb21pc2U7CiAgICBpZiAoaHRtbEVudHJ5KSB7CiAgICAgIGNvbnN0IFtodG1sRXhpc3QsIGh0bWxdID0gZnMucGF0aFJlZHVjZShodG1sRW50cnkpOwogICAgICBpZiAoIWh0bWxFeGlzdCkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gaHRtbC5jb250ZW50OwogICAgfQogICAgaWYgKHN0eWxlc0VudHJ5KSB7CiAgICAgIGNvbnN0IFtzdHlsZXNFeGlzdCwgc3R5bGVzXSA9IGZzLnBhdGhSZWR1Y2Uoc3R5bGVzRW50cnkpOwogICAgICBpZiAoIXN0eWxlc0V4aXN0KQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgc3R5bGUuaW5uZXJIVE1MID0gc3R5bGVzLmNvbnRlbnQ7CiAgICB9CiAgICBjb25zdCBbanNFeGlzdF0gPSBmcy5wYXRoUmVkdWNlKGpzRW50cnkpOwogICAgaWYgKCFqc0V4aXN0KQogICAgICByZXR1cm4gZmFsc2U7CiAgICBhd2FpdCBtYW5hZ2VyLnJlcXVpcmVfKGpzRW50cnkpOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBzZXRQbHVnaW5zOiBhc3luYyAocGx1Z2luSWRzKSA9PiB7CiAgICBjb25zdCBwbHVnaW5zID0gZ2VuZXJhdGVQbHVnaW5zKHBsdWdpbklkcyk7CiAgICBtYW5hZ2VyLnNldFBsdWdpbnMocGx1Z2lucyk7CiAgfQp9KTsKd2luZG93Lm9uZXJyb3IgPSAoZXJyKSA9PiB7CiAgY29uc29sZS5lcnJvcihlcnIpOwp9OwppZnJhbWVSZWFkeSgpOwovLyMgc291cmNlTWFwcGluZ1VSTD1pZnJhbWUuanMubWFwCg==";
const iframeStyles_ = ".code-sandbox-iframe {\n    border-width: 0;\n    width: 100%;\n    height: 100%;\n}\n";
const getIframeHTML = () => {
  const srcDoc = `<html lang="en">
    <head>
        <title>Demo Sandbox</title>
        <script type="module" src="${iframeScriptUrl}"><\/script>
    </head>
    <body></body>
</html>`;
  return [srcDoc];
};
const iframeStyles = iframeStyles_;
const JSEntry = "/index.js";
const StylesEntry = "/styles.css";
const HTMLEntry = "/index.html";
const getSandboxRefresher = (opt) => {
  const iframe = opt.iframe;
  return async () => {
    if (!iframe)
      return;
    await waitIframeReady(iframe);
    await waitProxy(iframe.contentWindow, DemoServiceName);
    await callProxy({
      win: iframe.contentWindow,
      serviceId: DemoServiceName,
      method: "run",
      payload: [JSEntry, HTMLEntry, StylesEntry]
    });
  };
};
const setSandboxPlugins = async (iframe, pluginsId2) => {
  await waitIframeReady(iframe);
  await waitProxy(iframe.contentWindow, DemoServiceName);
  return await callProxy({
    win: iframe.contentWindow,
    serviceId: DemoServiceName,
    method: "setPlugins",
    payload: [pluginsId2]
  });
};
const DefaultDemoFileName = "/Demo.js";
const DefaultDemoCode = `// require function is asynchronous !
const React = await require('react');

// if you register \`EsmToAmdPlugin\`, following statements will be support
// import React from 'react';

const App = () => {
    // if you register \`JsxPlugin\`, jsx can be used.
    // return <div>hello world</div>;
    return (
        React.createElement(
            'div',
            {},
            React.createElement(
                'div',
                {
                    className: 'title'
                },
                'DemoSandbox'
            ),
            'welcome to use code sandbox'
        )
    );
};

module.exports.default = App
// if you register \`EsmToAmdPlugin\`, following statements will be support
// export default App;`;
const DefaultIndexCode = `const React = await require('react');
const ReactDom = await require('react-dom');
const App = (await require('./Demo.js')).default;

// if you register \`EsmToAmdPlugin\`, following statements will be support
// import React from 'react';
// import ReactDom from 'react-dom';
// import App from './App';

ReactDom.render(React.createElement(App, {}), document.getElementById('root'));`;
const DefaultHtml = `<noscript>Need javascript to run this demo page.</noscript>
<div id="root">
    <h3>  Welcome to use code sandbox. </h3>
</div>`;
const DefaultCssCode = `.title { color: blue }`;
const _default = /* @__PURE__ */ Object.freeze(/* @__PURE__ */ Object.defineProperty({
  __proto__: null,
  DefaultCssCode,
  DefaultDemoCode,
  DefaultDemoFileName,
  DefaultHtml,
  DefaultIndexCode
}, Symbol.toStringTag, { value: "Module" }));
let pluginsId = [];
class DefaultPlugin extends BasePlugin {
  constructor() {
    super();
    this.pluginId = "default-plugin";
  }
  async resolveModuleUrl(meta) {
    const { packageName, version, file } = meta;
    const versionSuffix = version ? `@${version}` : "";
    const fileSuffix = file ? `${file}` : "";
    return `https://unpkg.com/${packageName}${versionSuffix}${fileSuffix}`;
  }
  async beforeModuleGenerate(ctx, meta) {
    meta.factory = `async (require, exports, module) => {
${meta.factory}
}`;
    meta.deps = ["require", "exports", "module"];
    return meta;
  }
}
const registerPlugins = (_plugins) => {
  const plugins = _plugins.concat(new DefaultPlugin());
  plugins.forEach((plugin) => {
    registerProxy(plugin.pluginId, plugin);
  });
  pluginsId = plugins.map((plugin) => plugin.pluginId);
  return pluginsId;
};
const getPlugins = () => {
  return pluginsId;
};
const getPathFileName = (pathObject) => `${pathObject.name}${pathObject.ext}`;
const traverse = (dir = "", directory, cb) => {
  directory.children.forEach((item) => {
    if (Reflect.has(item, "children")) {
      traverse(`${pathBrowserify}/${item.name}`, item, cb);
      return;
    }
    cb(`${pathBrowserify}/${item.name}`, item);
  });
};
class FilesSystem {
  constructor() {
    this.root = {
      name: "",
      children: this.getProxyMap("", [])
    };
    this.eventCount = 0;
    this.event = createEventSubscribeManager();
    this.cp = this.cpOrMv.bind(this, false);
    this.mv = this.cpOrMv.bind(this, true);
  }
  getProxyMap(path2, entries) {
    const _this = this;
    const map = new Map(entries);
    const proxyMethod = (methodName, eventName) => {
      const _method = Reflect.get(map, methodName);
      if (typeof _method === "function") {
        const method = function(...args) {
          _this.event.trigger(eventName, _this.eventCount++, path2, ...args);
          return _method.call(map, ...args);
        };
        Reflect.set(map, methodName, method);
      }
    };
    proxyMethod("set", "dir-set");
    proxyMethod("delete", "dir-delete");
    proxyMethod("clear", "dir-clear");
    return map;
  }
  pathReduce(target) {
    const paths = target.split(pathBrowserify.sep);
    return paths.reduce(([status, dir], cur, index, arr) => {
      var _a, _b;
      if (index === 0) {
        return [status, dir];
      }
      if (index === arr.length - 1 && cur === "") {
        return [status, dir];
      }
      return [status && ((_a = dir.children) == null ? void 0 : _a.has(cur)), (_b = dir.children) == null ? void 0 : _b.get(cur)];
    }, [true, this.root]);
  }
  exist(target) {
    const [exist] = this.pathReduce(target);
    return exist;
  }
  mkdir(target) {
    const pathObject = pathBrowserify.parse(target);
    if (this.exist(target)) {
      throw new Error(`[fs] failed to mkdir ${target}, it is already existed.`);
    }
    const [parentExist, parent] = this.pathReduce(pathObject.dir);
    if (!parentExist) {
      throw new Error(`[fs] failed to mkdir ${target}, parent path ${pathObject.dir} is not existed.`);
    }
    if (!Reflect.has(parent, "children") || Reflect.has(parent, "content")) {
      throw new Error(`[fs] failed to mkdir ${target}, parent path ${pathObject.dir} is not a directory.`);
    }
    parent.children.set(getPathFileName(pathObject), {
      name: getPathFileName(pathObject),
      children: this.getProxyMap(pathBrowserify.format(pathObject), [])
    });
  }
  readDirectory(target) {
    const pathObject = pathBrowserify.parse(target);
    const [parentExist, parent] = this.pathReduce(pathObject.dir);
    if (!parentExist) {
      throw new Error(`[fs] failed to read directory ${target}, parent path ${pathObject.dir} is not existed.`);
    }
    return parent.children.get(getPathFileName(pathObject));
  }
  readFile(target) {
    const [exist, file] = this.pathReduce(target);
    if (!exist) {
      throw new Error(`[fs] failed to read file ${target}, it is not existed.`);
    }
    if (Reflect.has(file, "children")) {
      throw new Error(`[fs] failed to read file ${target}, it is a directory.`);
    }
    return file;
  }
  writeFile(target, contents) {
    const pathObject = pathBrowserify.parse(target);
    const [parentExist, parent] = this.pathReduce(pathObject.dir);
    if (!parentExist) {
      throw new Error(`[fs] failed to write file ${target}, parent path ${pathObject.dir} is not existed.`);
    }
    let writeContent = contents;
    if (typeof contents !== "string") {
      writeContent = btoa(String.fromCharCode.apply(null, new Uint8Array(contents)));
    }
    const existBefore = parent.children.has(getPathFileName(pathObject));
    parent.children.set(getPathFileName(pathObject), {
      name: getPathFileName(pathObject),
      content: writeContent
    });
    this.event.trigger("files-change", this.eventCount++, existBefore ? "change" : "new", [target]);
  }
  cpOrMv(isMv = false, source, target) {
    const sourcePathObject = pathBrowserify.parse(source);
    const targetPathObject = pathBrowserify.parse(target);
    const [sourceParentExist, sourceParent] = this.pathReduce(sourcePathObject.dir);
    const [targetParentExist, targetParent] = this.pathReduce(targetPathObject.dir);
    if (!sourceParentExist || !targetParentExist) {
      throw new Error(`[fs] failed to ${isMv ? "mv" : "cp"} ${source} to ${target}, source or target path is not existed.`);
    }
    if (targetParent.children.has(getPathFileName(targetPathObject))) {
      throw new Error(`[fs] failed to ${isMv ? "mv" : "cp"} ${source} to ${target}, target path is already existed.`);
    }
    targetParent.children.set(getPathFileName(targetPathObject), sourceParent.children.get(getPathFileName(sourcePathObject)));
    const sourceFileOrDirectory = sourceParent.children.get(source);
    const deletedFiles = [];
    const newFiles = [];
    if (Reflect.has(sourceFileOrDirectory, "content")) {
      deletedFiles.push(source);
      newFiles.push(target);
    } else {
      traverse(void 0, sourceFileOrDirectory, (path_) => {
        deletedFiles.push(pathBrowserify.join(sourcePathObject.dir, path_));
        newFiles.push(pathBrowserify.join(targetPathObject.dir, path_));
      });
    }
    if (isMv) {
      sourceParent.children.delete(getPathFileName(sourcePathObject));
      this.event.trigger("files-change", this.eventCount++, "delete", deletedFiles);
    }
    this.event.trigger("files-change", this.eventCount++, "new", newFiles);
  }
  rm(target) {
    const pathObject = pathBrowserify.parse(target);
    const [parentExist, parent] = this.pathReduce(pathObject.dir);
    if (!parentExist || !parent.children.has(getPathFileName(pathObject))) {
      throw new Error(`[fs] failed to rm ${target}, it is not existed.`);
    }
    const targetFileOrDirectory = parent.children.get(target);
    const deletedFiles = [];
    if (Reflect.has(targetFileOrDirectory, "content")) {
      deletedFiles.push(target);
    } else {
      traverse(void 0, targetFileOrDirectory, (path_) => {
        deletedFiles.push(pathBrowserify.join(pathObject.dir, path_));
      });
    }
    parent.children.delete(getPathFileName(pathObject));
    this.event.trigger("files-change", this.eventCount++, "delete", deletedFiles);
  }
  /**
   * 
   */
  getDataPayload() {
    return JSON.stringify(this.root, (key, value) => {
      if (value instanceof Map) {
        return {
          __dataType: "Map",
          entries: Array.from(value.entries())
        };
      }
      return value;
    });
  }
  /**
   * 
   */
  transfer() {
    const payload = this.getDataPayload();
    this.event.trigger("transfer", this.eventCount++, "", payload);
  }
  /**
   * 
   * @param payload 
   */
  receive(payload) {
    const traverse2 = (obj, path2 = "") => {
      if (obj.children && Reflect.get(obj.children, "__dataType") === "Map") {
        const entries = obj.children.entries.map(([key, value]) => [key, traverse2(value, [path2, key].join("/"))]);
        return {
          ...obj,
          children: this.getProxyMap(path2, entries)
        };
      }
      return obj;
    };
    const root = traverse2(JSON.parse(payload));
    this.root = root;
    console.log("this.root", root);
    this.event.trigger("receive", this.eventCount++);
  }
}
const SyncServiceName = "code-sandbox-sync-files";
function initMainFilesSyncCaller(fs, iframe) {
  const onEvent = (eventType) => {
    return fs.event.listen(eventType, async (...args) => {
      await waitIframeReady(iframe);
      await waitProxy(iframe.contentWindow, SyncServiceName);
      await callProxy({
        win: iframe.contentWindow,
        serviceId: SyncServiceName,
        method: "sync",
        payload: [eventType, ...args]
      });
    });
  };
  const disposes = [];
  disposes.push(onEvent("transfer"));
  disposes.push(onEvent("dir-delete"));
  disposes.push(onEvent("dir-set"));
  disposes.push(onEvent("dir-clear"));
  disposes.push(onEvent("files-change"));
  disposes.push(registerProxy(SyncServiceName, {
    requestFs: async () => {
      return fs.getDataPayload();
    }
  }));
  return () => {
    disposes.forEach((dispose) => dispose());
  };
}
class CodeSandbox extends HTMLElement {
  constructor() {
    super();
    this.fs = new FilesSystem();
    this.fsSyncServiceDispose = null;
    this.mainThreadServiceDispose = null;
    this.root = null;
    this.root = this.attachShadow({ mode: "open" });
    this.initIframe();
  }
  addEventListener(type, listener, options) {
    super.addEventListener(type, listener, options);
  }
  removeEventListener(type, listener, options) {
    super.removeEventListener(type, listener, options);
  }
  initIframe() {
    var _a, _b;
    if (this.iframe) {
      this.root.removeChild(this.iframe);
    }
    (_a = this.fsSyncServiceDispose) == null ? void 0 : _a.call(this);
    (_b = this.mainThreadServiceDispose) == null ? void 0 : _b.call(this);
    this.mainThreadServiceDispose = initMainThreadService();
    const [srcDoc] = getIframeHTML();
    this.iframe = document.createElement("iframe");
    this.iframe.srcdoc = srcDoc;
    this.iframe.setAttribute("title", this.iframe.getAttribute("title"));
    this.iframe.setAttribute("sandbox", "allow-scripts");
    this.iframe.setAttribute("class", `code-sandbox-iframe ${this.getAttribute("class") || ""}`);
    this.iframe.setAttribute("style", this.getAttribute("style"));
    onIframeLoadingModule(this.iframe, (moduleName, extraInfo) => {
      this.dispatchEvent(new CustomEvent("loading-module", {
        detail: {
          moduleName,
          url: extraInfo
        }
      }));
    });
    this.styleElement = document.createElement("style");
    this.styleElement.innerHTML = iframeStyles;
    this.root.append(this.styleElement, this.iframe);
    this.fsSyncServiceDispose = initMainFilesSyncCaller(this.fs, this.iframe);
    setSandboxPlugins(this.iframe, getPlugins());
    this.writeFile("html");
    this.writeFile("css");
    this.writeFile("code");
    this.writeFile("index");
  }
  static get observedAttributes() {
    return ["code", "css", "index", "html", "class", "style"];
  }
  async execute() {
    await getSandboxRefresher({ iframe: this.iframe })();
    this.dispatchEvent(new CustomEvent("ready"));
  }
  async attributeChangedCallback(name, oldValue, newValue) {
    if (["html", "code", "index", "css"].includes(name)) {
      waitIframeReady(this.iframe).then(() => {
        this.writeFile(name);
        this.execute();
      });
    } else {
      this.iframe.setAttribute(name, newValue);
    }
  }
  async refresh() {
    this.initIframe();
    await waitIframeReady(this.iframe);
    return this.execute();
  }
  async writeFile(name) {
    await waitIframeReady(this.iframe);
    const defaultCodes = {
      html: [HTMLEntry, DefaultHtml],
      code: [DefaultDemoFileName, DefaultDemoCode],
      index: [JSEntry, DefaultIndexCode],
      css: [StylesEntry, DefaultCssCode]
    };
    const [fileName, defaultCode] = defaultCodes[name];
    this.fs.writeFile(fileName, this.getAttribute(name) || defaultCode);
  }
}
export {
  CodeSandbox,
  _default as DefaultCodes,
  registerPlugins
};
//# sourceMappingURL=webcomponent.js.map
